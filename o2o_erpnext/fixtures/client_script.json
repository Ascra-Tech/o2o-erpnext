[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-12-24 14:57:00.242566",
  "module": "o2o ErpNext",
  "name": "No Duplicate Purchase Receipt",
  "script": "// Purchase Order - Client Script\nfrappe.ui.form.on('Purchase Order', {\n    refresh: function(frm) {\n        if (frm.doc.__islocal || frm.doc.docstatus !== 1) {\n            return; // Only run for saved, submitted documents\n        }\n        \n        // Add the Check Linked Receipts button\n        frm.add_custom_button(__('Check Linked Receipts'), function() {\n            check_linked_receipts(frm);\n        }, __(\"Tools\"));\n        \n        // When the form refreshes, directly override the standard make_purchase_receipt function\n        // Store the original function\n        if (!window._original_make_purchase_receipt) {\n            window._original_make_purchase_receipt = cur_frm.cscript.make_purchase_receipt;\n            \n            // Replace it with our custom function\n            cur_frm.cscript.make_purchase_receipt = function() {\n                // Check for linked receipts before proceeding\n                check_active_receipts(frm).then(function(result) {\n                    if (result.has_active_receipts) {\n                        // Format receipt list for display\n                        const receipt_list = result.receipts.map(rec => \n                            `<a href=\"/app/purchase-receipt/${rec.name}\" target=\"_blank\">${frappe.utils.escape_html(rec.name)}</a> (${rec.status})`\n                        ).join('<br>');\n                        \n                        // If active receipts exist (Draft OR Submitted), show warning\n                        frappe.msgprint({\n                            title: __('Cannot Create Purchase Receipt'),\n                            indicator: 'red',\n                            message: __(`This Purchase Order already has active linked Purchase Receipts:<br>${receipt_list}<br><br>You cannot create additional Purchase Receipts for this order.`)\n                        });\n                    } else {\n                        // If no active receipts, proceed with original method\n                        window._original_make_purchase_receipt.apply(cur_frm.cscript);\n                    }\n                }).catch(function(err) {\n                    console.error(\"Error checking linked receipts:\", err);\n                    frappe.msgprint({\n                        title: __('Error'),\n                        indicator: 'red',\n                        message: __('Failed to check for linked Purchase Receipts. For safety, receipt creation has been blocked.')\n                    });\n                });\n            };\n        }\n        \n        // Also check for linked receipts silently on form load\n        check_linked_receipts(frm, true).then(function(result) {\n            if (result && result.has_active_receipts) {\n                // Clear any existing dashboard sections to avoid duplicates\n                frm.dashboard.wrapper.find('.custom-linked-receipts').remove();\n                \n                // Format the receipt list for display with clickable links\n                const receipt_list = result.receipts.map(rec => \n                    `<a href=\"/app/purchase-receipt/${rec.name}\" target=\"_blank\">${frappe.utils.escape_html(rec.name)}</a> (${frappe.utils.escape_html(rec.status)})`\n                ).join('<br>');\n                \n                // Add an indicator to the dashboard\n                frm.dashboard.add_indicator(\n                    __(\"Has active linked Purchase Receipts in Draft or Submitted status\"), \"red\"\n                );\n                \n                // Add a custom message in the dashboard\n                frm.dashboard.add_section(\n                    `<div class=\"form-dashboard-section custom-linked-receipts\">\n                        <div class=\"section-head\">Linked Purchase Receipts</div>\n                        <div class=\"row\">\n                            <div class=\"col-md-12\">\n                                <div class=\"alert alert-warning\">\n                                    This Purchase Order has active linked Purchase Receipts in Draft or Submitted status:<br>\n                                    ${receipt_list}<br><br>\n                                    You cannot create additional Purchase Receipts for this order.\n                                </div>\n                            </div>\n                        </div>\n                    </div>`\n                );\n            }\n        }).catch(function(err) {\n            console.error(\"Error checking linked receipts:\", err);\n        });\n    }\n});\n\n// Helper function to check for active receipts using SQL query via frappe.call\nfunction check_active_receipts(frm) {\n    return new Promise(function(resolve, reject) {\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Purchase Receipt',\n                filters: {\n                    'docstatus': ['in', [0, 1]]\n                },\n                fields: ['name', 'docstatus'],\n                limit_page_length: 0\n            },\n            callback: function(r) {\n                if (!r.message || r.message.length === 0) {\n                    resolve({\n                        has_active_receipts: false,\n                        receipts: []\n                    });\n                    return;\n                }\n                \n                // Check each receipt to see if it has items linked to this PO\n                let check_promises = r.message.map(function(receipt) {\n                    return new Promise(function(res) {\n                        frappe.call({\n                            method: 'frappe.client.get',\n                            args: {\n                                doctype: 'Purchase Receipt',\n                                name: receipt.name\n                            },\n                            callback: function(receipt_data) {\n                                if (receipt_data.message && receipt_data.message.items) {\n                                    // Check if any item has this PO linked\n                                    const has_link = receipt_data.message.items.some(function(item) {\n                                        return item.purchase_order === frm.doc.name;\n                                    });\n                                    \n                                    if (has_link) {\n                                        res({\n                                            name: receipt.name,\n                                            status: receipt.docstatus === 0 ? 'Draft' : 'Submitted',\n                                            has_link: true\n                                        });\n                                    } else {\n                                        res({ has_link: false });\n                                    }\n                                } else {\n                                    res({ has_link: false });\n                                }\n                            },\n                            error: function() {\n                                res({ has_link: false });\n                            }\n                        });\n                    });\n                });\n                \n                Promise.all(check_promises).then(function(results) {\n                    const linked_receipts = results.filter(r => r.has_link);\n                    resolve({\n                        has_active_receipts: linked_receipts.length > 0,\n                        receipts: linked_receipts\n                    });\n                }).catch(reject);\n            },\n            error: function(err) {\n                reject(err);\n            }\n        });\n    });\n}\n\n// Function to check linked receipts with UI feedback\nfunction check_linked_receipts(frm, silent = false) {\n    return new Promise(function(resolve, reject) {\n        if (!silent) {\n            frappe.show_alert({\n                message: __(\"Checking for linked Purchase Receipts in Draft or Submitted status...\"),\n                indicator: 'blue'\n            }, 3);\n        }\n        \n        check_active_receipts(frm).then(function(result) {\n            if (result.has_active_receipts && !silent) {\n                // Format the receipt list with clickable links\n                const receipt_list = result.receipts.map(rec => \n                    `<a href=\"/app/purchase-receipt/${rec.name}\" target=\"_blank\">${frappe.utils.escape_html(rec.name)}</a> (${frappe.utils.escape_html(rec.status)})`\n                ).join('<br>');\n                \n                // Show warning message\n                frappe.msgprint({\n                    title: __('Active Linked Receipts Found'),\n                    indicator: 'red',\n                    message: __(`This Purchase Order has active linked Purchase Receipts in Draft or Submitted status:<br>${receipt_list}<br><br>You cannot create additional Purchase Receipts for this order.`)\n                });\n            } else if (!result.has_active_receipts && !silent) {\n                frappe.msgprint({\n                    title: __('No Active Linked Receipts'),\n                    indicator: 'green',\n                    message: __('No active Purchase Receipts found in Draft or Submitted status. You can create a new one.')\n                });\n            }\n            \n            resolve(result);\n        }).catch(function(err) {\n            if (!silent) {\n                frappe.msgprint({\n                    title: __('Error'),\n                    indicator: 'red',\n                    message: __('Failed to check for linked Purchase Receipts.')\n                });\n            }\n            reject(err);\n        });\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-07-04 20:39:00.928339",
  "module": null,
  "name": "Purchase Invoice Controller",
  "script": "// Client Script for Purchase Invoice\n// Setup > Customization > Client Script\n// DocType: Purchase Invoice\n// Apply To: Form\n\nfrappe.ui.form.on('Purchase Invoice', {\n    refresh: function(frm) {\n        // Apply restrictions for Vendor User on Draft documents\n        if (frm.doc.docstatus === 0 && frappe.user.has_role('Vendor User')) {\n            apply_vendor_restrictions(frm);\n        }\n    },\n    \n    onload: function(frm) {\n        // Store original values when document loads\n        if (frm.doc.docstatus === 0 && frappe.user.has_role('Vendor User') && !frm.is_new()) {\n            store_original_values(frm);\n        }\n    },\n    \n    before_save: function(frm) {\n        // Validate on client side before sending to server\n        if (frm.doc.docstatus === 0 && frappe.user.has_role('Vendor User') && !frm.is_new()) {\n            return validate_vendor_changes(frm);\n        }\n    }\n});\n\nfrappe.ui.form.on('Purchase Invoice Item', {\n    items_add: function(frm, cdt, cdn) {\n        if (frm.doc.docstatus === 0 && frappe.user.has_role('Vendor User') && !frm.is_new()) {\n            // Show auto-dismissing message\n            show_vendor_restriction_message('Vendor Users cannot add items when Purchase Invoice is in Draft status.');\n            \n            // Remove the added row\n            setTimeout(function() {\n                let added_row = frm.doc.items.find(row => row.name === cdn);\n                if (added_row) {\n                    let idx = frm.doc.items.indexOf(added_row);\n                    frm.doc.items.splice(idx, 1);\n                    frm.refresh_field('items');\n                }\n            }, 10);\n        }\n    },\n    \n    before_items_remove: function(frm, cdt, cdn) {\n        if (frm.doc.docstatus === 0 && frappe.user.has_role('Vendor User') && !frm.is_new()) {\n            show_vendor_restriction_message('Vendor Users cannot remove items when Purchase Invoice is in Draft status.');\n            frappe.validated = false;\n            return false;\n        }\n    },\n    \n    item_code: function(frm, cdt, cdn) {\n        check_field_modification(frm, cdt, cdn, 'item_code');\n    },\n    \n    qty: function(frm, cdt, cdn) {\n        check_field_modification(frm, cdt, cdn, 'qty');\n    },\n    \n    rate: function(frm, cdt, cdn) {\n        check_field_modification(frm, cdt, cdn, 'rate');\n    }\n});\n\n// Global flag to prevent duplicate messages\nlet messageTimeout = null;\nlet lastMessageTime = 0;\n\nfunction show_vendor_restriction_message(message) {\n    // Prevent duplicate messages within 1 second\n    const currentTime = Date.now();\n    if (currentTime - lastMessageTime < 1000) {\n        return;\n    }\n    lastMessageTime = currentTime;\n    \n    // Clear any existing timeout\n    if (messageTimeout) {\n        clearTimeout(messageTimeout);\n    }\n    \n    // Show message that auto-dismisses after 3 seconds\n    const msg = frappe.show_alert({\n        message: message,\n        indicator: 'orange'\n    }, 3);\n}\n\nfunction apply_vendor_restrictions(frm) {\n    // Add visual indicator\n    if (!frm.fields_dict.items.wrapper.find('.vendor-restriction-notice').length) {\n        let notice = `\n            <div class=\"alert alert-warning vendor-restriction-notice\" style=\"margin: 10px 0; position: relative;\">\n                <i class=\"fa fa-lock\"></i> <strong>Notice:</strong> Items table is read-only for Vendor Users when Purchase Invoice is in Draft status.\n                <button type=\"button\" class=\"close\" aria-label=\"Close\" style=\"position: absolute; right: 10px; top: 50%; transform: translateY(-50%);\">\n                    <span aria-hidden=\"true\">&times;</span>\n                </button>\n            </div>\n        `;\n        $(notice).prependTo(frm.fields_dict.items.wrapper);\n        \n        // Add click handler to close button\n        frm.fields_dict.items.wrapper.find('.vendor-restriction-notice .close').on('click', function() {\n            $(this).parent('.vendor-restriction-notice').fadeOut(300, function() {\n                $(this).remove();\n            });\n        });\n    }\n    \n    // Disable add/delete buttons\n    frm.fields_dict.items.grid.cannot_add_rows = true;\n    frm.fields_dict.items.grid.cannot_delete_rows = true;\n    \n    // Hide action buttons\n    setTimeout(() => {\n        frm.fields_dict.items.grid.wrapper.find('.btn-open-row').hide();\n        frm.fields_dict.items.grid.wrapper.find('.grid-add-row').hide();\n        frm.fields_dict.items.grid.wrapper.find('.grid-remove-rows').hide();\n        frm.fields_dict.items.grid.wrapper.find('.grid-duplicate-row').hide();\n        \n        // Make grid rows appear disabled\n        frm.fields_dict.items.grid.wrapper.find('.grid-row').css({\n            'opacity': '0.8',\n            'background-color': '#f5f5f5'\n        });\n        \n        // Add hover effect to show restriction\n        frm.fields_dict.items.grid.wrapper.find('.grid-row').off('mouseenter.vendor-restrict').on('mouseenter.vendor-restrict', function() {\n            $(this).css('cursor', 'not-allowed');\n        });\n    }, 100);\n    \n    // Make item fields read-only\n    const read_only_fields = ['item_code', 'item_name', 'qty', 'rate', 'amount', 'uom', 'description'];\n    frm.fields_dict.items.grid.docfields.forEach(df => {\n        if (read_only_fields.includes(df.fieldname)) {\n            df.read_only = 1;\n        }\n    });\n    \n    frm.refresh_field('items');\n}\n\nfunction store_original_values(frm) {\n    // Store original values for comparison\n    frm._original_items = [];\n    \n    if (frm.doc.items) {\n        frm.doc.items.forEach(item => {\n            frm._original_items.push({\n                idx: item.idx,\n                item_code: item.item_code,\n                qty: item.qty,\n                rate: item.rate,\n                amount: item.amount\n            });\n        });\n    }\n}\n\nfunction check_field_modification(frm, cdt, cdn, fieldname) {\n    if (frm.doc.docstatus === 0 && frappe.user.has_role('Vendor User') && !frm.is_new()) {\n        let row = locals[cdt][cdn];\n        let original = frm._original_items ? frm._original_items.find(item => item.idx === row.idx) : null;\n        \n        if (original && original[fieldname] !== undefined) {\n            // Revert to original value\n            setTimeout(function() {\n                frappe.model.set_value(cdt, cdn, fieldname, original[fieldname]);\n            }, 10);\n            \n            // Show auto-dismissing message\n            show_vendor_restriction_message(`Vendor Users cannot modify ${fieldname.replace('_', ' ')} when Purchase Invoice is in Draft status.`);\n        }\n    }\n}\n\nfunction validate_vendor_changes(frm) {\n    // Additional validation before save\n    if (!frm._original_items) {\n        return true;\n    }\n    \n    // Check if number of items changed\n    if (frm.doc.items.length !== frm._original_items.length) {\n        show_vendor_restriction_message('Vendor Users cannot add or remove items when Purchase Invoice is in Draft status.');\n        frappe.validated = false;\n        return false;\n    }\n    \n    // Check for modifications in items\n    for (let i = 0; i < frm.doc.items.length; i++) {\n        let current = frm.doc.items[i];\n        let original = frm._original_items[i];\n        \n        if (current.item_code !== original.item_code ||\n            current.qty !== original.qty ||\n            current.rate !== original.rate) {\n            show_vendor_restriction_message('Vendor Users cannot modify item details when Purchase Invoice is in Draft status.');\n            frappe.validated = false;\n            return false;\n        }\n    }\n    \n    return true;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-07-04 18:34:34.326958",
  "module": "o2o ErpNext",
  "name": "PO Scanner 1",
  "script": "// Client Script for Purchase Order List View\n// DocType: Purchase Order\n// Script Type: Client Script\n// Apply To: List\n// Event: (leave blank for list view)\n\n// Method 1: Direct listview settings\nfrappe.listview_settings['Purchase Order'] = frappe.listview_settings['Purchase Order'] || {};\nfrappe.listview_settings['Purchase Order'].onload = function(listview) {\n    // Add custom button to scan for partial POs\n    listview.page.add_menu_item(__('üîç Scan Partial Orders'), function() {\n        scan_partial_purchase_orders();\n    });\n    \n    // Add statistics button\n    listview.page.add_menu_item(__('üìä PO Statistics'), function() {\n        show_po_statistics();\n    });\n};\n\n// Method 2: Alternative approach using refresh event\n$(document).on('page-change', function() {\n    if (frappe.get_route()[0] === 'List' && frappe.get_route()[1] === 'Purchase Order') {\n        setTimeout(function() {\n            var listview = cur_list;\n            if (listview && listview.page && !listview.page.custom_po_scanner_added) {\n                listview.page.add_menu_item(__('üîç Scan Partial Orders'), function() {\n                    scan_partial_purchase_orders();\n                });\n                \n                listview.page.add_menu_item(__('üìä PO Statistics'), function() {\n                    show_po_statistics();\n                });\n                \n                // Mark as added to avoid duplicates\n                listview.page.custom_po_scanner_added = true;\n            }\n        }, 500);\n    }\n});\n\nfunction scan_partial_purchase_orders() {\n    frappe.show_alert({\n        message: __('üîç Scanning Purchase Orders for partial receipts...'),\n        indicator: 'blue'\n    });\n    \n    frappe.call({\n        method: 'o2o_erpnext.po_scanner.get_partial_purchase_orders',\n        callback: function(r) {\n            if (r.message && r.message.status === 'success') {\n                if (r.message.data && r.message.data.length > 0) {\n                    show_partial_orders_results(r.message.data);\n                } else {\n                    frappe.show_alert({\n                        message: __('‚úÖ No partial Purchase Orders found!'),\n                        indicator: 'green'\n                    });\n                }\n            } else {\n                frappe.msgprint({\n                    title: __('Error'),\n                    message: r.message?.message || __('Failed to scan Purchase Orders'),\n                    indicator: 'red'\n                });\n            }\n        },\n        error: function(r) {\n            frappe.msgprint({\n                title: __('Error'),\n                message: __('Unable to scan. Please ensure the server method exists in o2o_erpnext.po_scanner'),\n                indicator: 'red'\n            });\n        }\n    });\n}\n\nfunction show_partial_orders_results(partial_pos) {\n    let html = `\n        <div class=\"partial-orders-results\">\n            <style>\n                .partial-orders-results {\n                    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif;\n                }\n                .summary-card {\n                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                    color: white;\n                    padding: 20px;\n                    border-radius: 12px;\n                    margin-bottom: 24px;\n                    text-align: center;\n                }\n                .po-card {\n                    border: 1px solid #e1e5e9;\n                    border-radius: 12px;\n                    margin-bottom: 16px;\n                    padding: 20px;\n                    background: #ffffff;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);\n                    border-left: 4px solid #ff9800;\n                    transition: all 0.3s ease;\n                }\n                .po-card:hover {\n                    box-shadow: 0 4px 16px rgba(0,0,0,0.12);\n                    transform: translateY(-2px);\n                }\n                .po-header {\n                    display: flex;\n                    justify-content: space-between;\n                    align-items: center;\n                    margin-bottom: 16px;\n                }\n                .po-title {\n                    font-size: 18px;\n                    font-weight: 600;\n                    color: #2c3e50;\n                }\n                .po-title a {\n                    text-decoration: none;\n                    color: #3498db;\n                }\n                .po-title a:hover {\n                    color: #2980b9;\n                }\n                .po-details-grid {\n                    display: grid;\n                    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));\n                    gap: 16px;\n                    margin-bottom: 16px;\n                }\n                .detail-item {\n                    text-align: center;\n                    padding: 12px;\n                    background: #f8f9fa;\n                    border-radius: 8px;\n                    border: 1px solid #e9ecef;\n                }\n                .detail-value {\n                    font-size: 16px;\n                    font-weight: 600;\n                    color: #2c3e50;\n                    margin-bottom: 4px;\n                }\n                .detail-label {\n                    font-size: 12px;\n                    color: #6c757d;\n                    text-transform: uppercase;\n                    letter-spacing: 0.5px;\n                }\n                .progress-section {\n                    margin-top: 16px;\n                }\n                .progress-bar {\n                    width: 100%;\n                    height: 12px;\n                    background-color: #e9ecef;\n                    border-radius: 6px;\n                    overflow: hidden;\n                    margin: 8px 0;\n                }\n                .progress-fill {\n                    height: 100%;\n                    background: linear-gradient(90deg, #ff9800 0%, #ffb74d 100%);\n                    border-radius: 6px;\n                    transition: width 0.5s ease;\n                }\n                .btn-view-details {\n                    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);\n                    color: white;\n                    border: none;\n                    padding: 10px 20px;\n                    border-radius: 8px;\n                    cursor: pointer;\n                    font-size: 14px;\n                    font-weight: 500;\n                    transition: all 0.3s ease;\n                }\n                .btn-view-details:hover {\n                    transform: translateY(-2px);\n                    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);\n                }\n                .status-badge {\n                    padding: 6px 12px;\n                    border-radius: 20px;\n                    font-size: 12px;\n                    font-weight: 500;\n                    background: #fff3cd;\n                    color: #856404;\n                    border: 1px solid #ffeaa7;\n                }\n            </style>\n            \n            <div class=\"summary-card\">\n                <h3 style=\"margin: 0 0 8px 0; font-size: 24px;\">üìä Partial Orders Summary</h3>\n                <p style=\"margin: 0; font-size: 16px; opacity: 0.9;\">\n                    Found <strong>${partial_pos.length}</strong> Purchase Orders with partial receipts\n                </p>\n            </div>\n    `;\n    \n    partial_pos.forEach(function(po) {\n        html += `\n            <div class=\"po-card\">\n                <div class=\"po-header\">\n                    <div class=\"po-title\">\n                        <a href=\"/app/purchase-order/${po.name}\" target=\"_blank\">\n                            üìÑ ${po.name}\n                        </a>\n                    </div>\n                    <div>\n                        <span class=\"status-badge\">${po.status}</span>\n                    </div>\n                </div>\n                \n                <div class=\"po-details-grid\">\n                    <div class=\"detail-item\">\n                        <div class=\"detail-value\">${po.supplier}</div>\n                        <div class=\"detail-label\">Supplier</div>\n                    </div>\n                    <div class=\"detail-item\">\n                        <div class=\"detail-value\">${frappe.datetime.str_to_user(po.transaction_date)}</div>\n                        <div class=\"detail-label\">Date</div>\n                    </div>\n                    <div class=\"detail-item\">\n                        <div class=\"detail-value\">${format_currency(po.grand_total)}</div>\n                        <div class=\"detail-label\">Total Amount</div>\n                    </div>\n                    <div class=\"detail-item\">\n                        <div class=\"detail-value\">${po.total_items}</div>\n                        <div class=\"detail-label\">Total Items</div>\n                    </div>\n                    <div class=\"detail-item\">\n                        <div class=\"detail-value\" style=\"color: #e74c3c;\">${po.pending_items}</div>\n                        <div class=\"detail-label\">Pending Items</div>\n                    </div>\n                    <div class=\"detail-item\">\n                        <div class=\"detail-value\" style=\"color: #27ae60;\">${po.completion_percentage}%</div>\n                        <div class=\"detail-label\">Completed</div>\n                    </div>\n                </div>\n                \n                <div class=\"progress-section\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;\">\n                        <span style=\"font-size: 14px; color: #6c757d;\">\n                            Progress: ${po.received_items}/${po.total_items} items received\n                        </span>\n                        <button class=\"btn-view-details\" onclick=\"show_po_item_details('${po.name}')\">\n                            üîç View Item Details\n                        </button>\n                    </div>\n                    <div class=\"progress-bar\">\n                        <div class=\"progress-fill\" style=\"width: ${po.completion_percentage}%\"></div>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    html += `</div>`;\n    \n    let dialog = new frappe.ui.Dialog({\n        title: __(`üìã Partial Purchase Orders (${partial_pos.length} found)`),\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'partial_orders',\n                options: html\n            }\n        ],\n        size: 'extra-large',\n        primary_action_label: __('Export CSV'),\n        primary_action: function() {\n            export_to_csv(partial_pos);\n        }\n    });\n    \n    dialog.show();\n}\n\nfunction show_po_item_details(po_name) {\n    frappe.show_alert({\n        message: __('Loading item details...'),\n        indicator: 'blue'\n    });\n    \n    frappe.call({\n        method: 'o2o_erpnext.po_scanner.get_po_item_status',\n        args: {\n            po_name: po_name\n        },\n        callback: function(r) {\n            if (r.message && r.message.status === 'success') {\n                display_po_item_details(r.message.data);\n            } else {\n                frappe.msgprint({\n                    title: __('Error'),\n                    message: r.message?.message || __('Failed to get item details'),\n                    indicator: 'red'\n                });\n            }\n        }\n    });\n}\n\nfunction display_po_item_details(data) {\n    let html = `\n        <div class=\"po-item-details\">\n            <style>\n                .po-summary-section {\n                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                    color: white;\n                    padding: 24px;\n                    border-radius: 12px;\n                    margin-bottom: 24px;\n                }\n                .summary-stats {\n                    display: grid;\n                    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));\n                    gap: 16px;\n                    margin-top: 16px;\n                }\n                .stat-box {\n                    text-align: center;\n                    background: rgba(255, 255, 255, 0.15);\n                    padding: 16px;\n                    border-radius: 8px;\n                    backdrop-filter: blur(10px);\n                }\n                .stat-number {\n                    font-size: 20px;\n                    font-weight: 700;\n                    margin-bottom: 4px;\n                }\n                .stat-label {\n                    font-size: 12px;\n                    opacity: 0.9;\n                    text-transform: uppercase;\n                    letter-spacing: 0.5px;\n                }\n                .items-table {\n                    width: 100%;\n                    border-collapse: collapse;\n                    margin-top: 20px;\n                    border-radius: 8px;\n                    overflow: hidden;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n                }\n                .items-table th {\n                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);\n                    padding: 16px 12px;\n                    text-align: left;\n                    font-weight: 600;\n                    color: #495057;\n                    border-bottom: 2px solid #dee2e6;\n                }\n                .items-table td {\n                    padding: 14px 12px;\n                    border-bottom: 1px solid #f1f3f4;\n                    vertical-align: middle;\n                }\n                .items-table tr:hover {\n                    background: #f8f9fa;\n                }\n                .status-badge {\n                    padding: 6px 12px;\n                    border-radius: 20px;\n                    font-size: 11px;\n                    font-weight: 600;\n                    text-transform: uppercase;\n                    letter-spacing: 0.5px;\n                }\n                .status-received { background: #d4edda; color: #155724; }\n                .status-partial { background: #fff3cd; color: #856404; }\n                .status-pending { background: #f8d7da; color: #721c24; }\n                .item-code {\n                    font-weight: 600;\n                    color: #2c3e50;\n                }\n            </style>\n            \n            <div class=\"po-summary-section\">\n                <h4 style=\"margin: 0 0 8px 0; font-size: 22px;\">üìã ${data.po_name}</h4>\n                <p style=\"margin: 0; font-size: 16px; opacity: 0.9;\">\n                    <strong>Supplier:</strong> ${data.supplier} | \n                    <strong>Date:</strong> ${frappe.datetime.str_to_user(data.transaction_date)} | \n                    <strong>Status:</strong> ${data.po_status}\n                </p>\n                \n                <div class=\"summary-stats\">\n                    <div class=\"stat-box\">\n                        <div class=\"stat-number\">${data.summary.total_items}</div>\n                        <div class=\"stat-label\">Total Items</div>\n                    </div>\n                    <div class=\"stat-box\">\n                        <div class=\"stat-number\">${format_currency(data.summary.total_ordered_amount)}</div>\n                        <div class=\"stat-label\">Total Ordered</div>\n                    </div>\n                    <div class=\"stat-box\">\n                        <div class=\"stat-number\">${format_currency(data.summary.total_received_amount)}</div>\n                        <div class=\"stat-label\">Total Received</div>\n                    </div>\n                    <div class=\"stat-box\">\n                        <div class=\"stat-number\">${format_currency(data.summary.total_pending_amount)}</div>\n                        <div class=\"stat-label\">Total Pending</div>\n                    </div>\n                    <div class=\"stat-box\">\n                        <div class=\"stat-number\">${data.summary.overall_completion_percentage}%</div>\n                        <div class=\"stat-label\">Completion</div>\n                    </div>\n                </div>\n            </div>\n            \n            <table class=\"items-table\">\n                <thead>\n                    <tr>\n                        <th>Item Code</th>\n                        <th>Item Name</th>\n                        <th>UOM</th>\n                        <th>Ordered</th>\n                        <th>Received</th>\n                        <th>Pending</th>\n                        <th>Rate</th>\n                        <th>Pending Amount</th>\n                        <th>Status</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    data.items.forEach(function(item) {\n        let status_class = '';\n        if (item.status === 'Fully Received') {\n            status_class = 'status-received';\n        } else if (item.status === 'Partially Received') {\n            status_class = 'status-partial';\n        } else {\n            status_class = 'status-pending';\n        }\n        \n        html += `\n            <tr>\n                <td><span class=\"item-code\">${item.item_code}</span></td>\n                <td>${item.item_name}</td>\n                <td>${item.uom}</td>\n                <td>${item.ordered_qty}</td>\n                <td>${item.received_qty}</td>\n                <td><strong>${item.pending_qty}</strong></td>\n                <td>${format_currency(item.rate)}</td>\n                <td><strong>${format_currency(item.pending_amount)}</strong></td>\n                <td>\n                    <span class=\"status-badge ${status_class}\">\n                        ${item.status}\n                    </span>\n                </td>\n            </tr>\n        `;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    let dialog = new frappe.ui.Dialog({\n        title: __(`üì¶ Item Details - ${data.po_name}`),\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'item_details',\n                options: html\n            }\n        ],\n        size: 'extra-large'\n    });\n    \n    dialog.show();\n}\n\nfunction show_po_statistics() {\n    frappe.call({\n        method: 'o2o_erpnext.po_scanner.get_po_statistics',\n        callback: function(r) {\n            if (r.message && r.message.status === 'success') {\n                let stats = r.message.data;\n                \n                let html = `\n                    <div class=\"po-statistics\">\n                        <style>\n                            .stats-container {\n                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                                color: white;\n                                padding: 30px;\n                                border-radius: 15px;\n                                text-align: center;\n                            }\n                            .stats-grid {\n                                display: grid;\n                                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                                gap: 20px;\n                                margin-top: 20px;\n                            }\n                            .stat-card {\n                                background: rgba(255, 255, 255, 0.15);\n                                padding: 20px;\n                                border-radius: 12px;\n                                backdrop-filter: blur(10px);\n                            }\n                            .stat-number {\n                                font-size: 28px;\n                                font-weight: 700;\n                                margin-bottom: 8px;\n                            }\n                            .stat-label {\n                                font-size: 14px;\n                                opacity: 0.9;\n                                text-transform: uppercase;\n                                letter-spacing: 0.5px;\n                            }\n                        </style>\n                        \n                        <div class=\"stats-container\">\n                            <h3 style=\"margin: 0 0 10px 0; font-size: 28px;\">üìä Purchase Order Statistics</h3>\n                            <p style=\"margin: 0; font-size: 16px; opacity: 0.9;\">\n                                Overview of your Purchase Order status\n                            </p>\n                            \n                            <div class=\"stats-grid\">\n                                <div class=\"stat-card\">\n                                    <div class=\"stat-number\">${stats.total_pos}</div>\n                                    <div class=\"stat-label\">Total POs</div>\n                                </div>\n                                <div class=\"stat-card\">\n                                    <div class=\"stat-number\">${stats.partial_pos}</div>\n                                    <div class=\"stat-label\">Partial POs</div>\n                                </div>\n                                <div class=\"stat-card\">\n                                    <div class=\"stat-number\">${stats.partial_percentage}%</div>\n                                    <div class=\"stat-label\">Partial Rate</div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                `;\n                \n                frappe.msgprint({\n                    title: __('üìä PO Statistics'),\n                    message: html,\n                    wide: true\n                });\n            } else {\n                frappe.msgprint({\n                    title: __('Error'),\n                    message: r.message?.message || __('Failed to get statistics'),\n                    indicator: 'red'\n                });\n            }\n        }\n    });\n}\n\nfunction export_to_csv(partial_pos) {\n    let csv_content = \"Purchase Order,Supplier,Date,Amount,Status,Total Items,Pending Items,Completion %\\n\";\n    \n    partial_pos.forEach(function(po) {\n        csv_content += `\"${po.name}\",\"${po.supplier}\",\"${po.transaction_date}\",\"${po.grand_total}\",\"${po.status}\",\"${po.total_items}\",\"${po.pending_items}\",\"${po.completion_percentage}\"\\n`;\n    });\n    \n    let blob = new Blob([csv_content], { type: 'text/csv;charset=utf-8;' });\n    let link = document.createElement(\"a\");\n    let url = URL.createObjectURL(blob);\n    link.setAttribute(\"href\", url);\n    link.setAttribute(\"download\", `partial_purchase_orders_${frappe.datetime.now_date()}.csv`);\n    link.style.visibility = 'hidden';\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    \n    frappe.show_alert({\n        message: __('CSV file downloaded successfully!'),\n        indicator: 'green'\n    });\n}\n\n// Make function globally available\nwindow.show_po_item_details = show_po_item_details;",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-05-15 15:13:25.770162",
  "module": "o2o ErpNext",
  "name": "change label",
  "script": "frappe.ui.form.on('Purchase Invoice', {\n    refresh: function(frm) {\n        console.log(\"====++++++++++++++++++++++++++++++\")\n       \n        setTimeout(() => {\n            \n            $('.dropdown-menu a.dropdown-item').each(function() {\n                if ($(this).text().trim() === \"Return / Debit Note\") {\n                    $(this).text(\"Return / Credit Note\");\n                }\n            });\n        }, 300); \n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier",
  "enabled": 1,
  "modified": "2025-04-21 13:05:54.355539",
  "module": null,
  "name": "Budget date",
  "script": "frappe.ui.form.on('Supplier', {\n    validate: function(frm) {\n        // Validate budget start date\n        let start_date = frm.doc.custom_budget_start_date;\n        if (start_date !== undefined && start_date !== null && start_date !== '') {\n            if (isNaN(start_date) || start_date < 1 || start_date > 31 || !Number.isInteger(parseFloat(start_date))) {\n                frappe.validated = false;\n                frappe.throw('Budget Start Date must be a whole number between 1 and 31');\n                return false;\n            }\n        }\n        \n        // Validate budget end date\n        let end_date = frm.doc.custom_budget_end_date;\n        if (end_date !== undefined && end_date !== null && end_date !== '') {\n            if (isNaN(end_date) || end_date < 1 || end_date > 31 || !Number.isInteger(parseFloat(end_date))) {\n                frappe.validated = false;\n                frappe.throw('Budget End Date must be a whole number between 1 and 31');\n                return false;\n            }\n        }\n    },\n    \n    // Also add real-time validation for better user experience\n    custom_budget_start_date: function(frm) {\n        validateInputField(frm, 'custom_budget_start_date');\n    },\n    \n    custom_budget_end_date: function(frm) {\n        validateInputField(frm, 'custom_budget_end_date');\n    }\n});\n\n// Function for real-time validation feedback\nfunction validateInputField(frm, fieldname) {\n    let value = frm.doc[fieldname];\n    let label = frappe.meta.get_label(frm.doctype, fieldname, frm.docname);\n    \n    if (value !== undefined && value !== null && value !== '') {\n        if (isNaN(value) || value < 1 || value > 31 || !Number.isInteger(parseFloat(value))) {\n            // Show message but don't throw (for better UX)\n            frappe.msgprint(`${label} must be a whole number between 1 and 31`);\n            // Clear the invalid value\n            frm.set_value(fieldname, '');\n        }\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Vendor",
  "enabled": 1,
  "modified": "2025-01-29 11:18:42.162173",
  "module": "o2o ErpNext",
  "name": "Vendor v1",
  "script": "frappe.ui.form.on('Vendor', {\n    refresh: function(frm) {\n        console.log('Refresh triggered');\n        console.log('user_id:', frm.doc.user_id);\n        console.log('email_id:', frm.doc.email_id);\n        \n        // Add custom button if user is not created/linked\n        if (!frm.doc.user_id && frm.doc.email_id) {\n            console.log('Adding Create User button');\n            frm.add_custom_button(__('Create User'), () => {\n                console.log('Create User button clicked');\n                create_vendor_user(frm);\n            }).addClass('btn-primary');\n        }\n    }\n});\n\n// Separate function for creating vendor user\nfunction create_vendor_user(frm) {\n    console.log('Creating vendor user for:', frm.doc.name);\n    \n    if (!frm.doc.email_id) {\n        frappe.throw(__(\"Please enter Email ID\"));\n        return;\n    }\n    \n    frappe.call({\n        method: \"o2o_erpnext.api.vendor.create_vendor_user\",\n        args: {\n            vendor: frm.doc.name\n        },\n        freeze: true,\n        freeze_message: __(\"Creating User...\"),\n        callback: function(r) {\n            console.log('API response:', r);\n            if (!r.exc) {\n                frm.reload_doc();\n                setTimeout(function() {\n                    cur_frm.refresh();\n                }, 1000);\n            }\n        },\n        error: function(r) {\n            console.error('API error:', r);\n        }\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier",
  "enabled": 1,
  "modified": "2025-01-16 10:53:58.115896",
  "module": "o2o ErpNext",
  "name": "Supplier Restrictions",
  "script": "frappe.ui.form.on('Supplier', {\n    onload: function(frm) {\n        if (frm.is_new()) {\n            frappe.call({\n                method: 'o2o_erpnext.api.supplier_validation.check_supplier_permission',\n                callback: function(r) {\n                    if (r.message) {\n                        if (!r.message.allowed) {\n                            frappe.validated = false;\n                            frappe.msgprint({\n                                title: __('Not Allowed'),\n                                indicator: 'red',\n                                message: r.message.message\n                            });\n                            setTimeout(() => {\n                                frappe.set_route('List', 'Supplier');\n                            }, 2000);\n                        } else {\n                            frm.set_value('custom_user', frappe.session.user);\n                        }\n                    }\n                }\n            });\n        }\n    },\n    \n    validate: function(frm) {\n        if (frm.is_new()) {\n            // Check if custom_user matches current user\n            if (frm.doc.custom_user !== frappe.session.user) {\n                frappe.validated = false;\n                frappe.msgprint({\n                    title: __('Not Allowed'),\n                    indicator: 'red',\n                    message: __('You cannot modify the user assignment')\n                });\n                return false;\n            }\n            return true;\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Role Profile",
  "enabled": 1,
  "modified": "2024-12-04 20:41:56.962751",
  "module": "o2o ErpNext",
  "name": "Role Profile List View",
  "script": "frappe.listview_settings['Role Profile'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};\nfrappe.listview_settings['Role Profile'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n    }\n}\nfrappe.listview_settings['Role Profile'] = {\n\trefresh: function(listview) {\n\t   \t$(\"use.like-icon\").hide();\n\t}\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "State",
  "enabled": 1,
  "modified": "2024-12-04 20:43:03.263179",
  "module": null,
  "name": "State Master List View",
  "script": "frappe.listview_settings['State'] = {\n\trefresh: function(listview) {\n\t   \t$(\"use.like-icon\").hide();\n\t}\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "City",
  "enabled": 1,
  "modified": "2024-12-04 20:54:03.155072",
  "module": null,
  "name": "City Master List view",
  "script": "frappe.listview_settings['City'] = {\n\trefresh: function(listview) {\n\t   \t$(\"use.like-icon\").hide();\n\t}\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-12-10 10:04:07.659215",
  "module": "o2o ErpNext",
  "name": "PR fetch",
  "script": "frappe.listview_settings['Purchase Order'] = {\n    hide_name_column: true,\n    onload: function(listview) {\n        listview.page.add_button(__('Print PO'), function() {\n            let selected = listview.get_checked_items();\n            if (!selected.length || selected.length > 1) {\n                frappe.msgprint('Please select one Purchase Order');\n                return;\n            }\n            let pdfUrl = frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                + \"doctype=\" + encodeURIComponent(\"Purchase Order\")\n                + \"&name=\" + encodeURIComponent(selected[0].name)\n                + \"&trigger_print=0\"\n                + \"&format=Purchase Order\"\n                + \"&no_letterhead=0\"\n                + \"&_lang=en\"\n            );\n            window.open(pdfUrl);\n        }, true).addClass('btn-primary');\n\n        listview.page.add_button(__('Print PR'), function() {\n            let selected = listview.get_checked_items();\n            if (!selected.length || selected.length > 1) {\n                frappe.msgprint('Please select one Purchase Order');\n                return;\n            }\n\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Purchase Receipt',\n                    filters: [['Purchase Receipt Item', 'purchase_order', '=', selected[0].name]],\n                    fields: ['name', 'posting_date', 'supplier', 'grand_total', 'status']\n                },\n                callback: function(r) {\n                    if (!r.message?.length) {\n                        frappe.msgprint('No Purchase Receipts found');\n                        return;\n                    }\n\n                    let d = new frappe.ui.Dialog({\n                        title: 'Select Purchase Receipt to Print',\n                        fields: [{\n                            label: 'Select Purchase Receipt',\n                            fieldname: 'selected_pr',\n                            fieldtype: 'Select',\n                            options: r.message.map(pr => ({\n                                label: `${pr.name} | ${frappe.datetime.str_to_user(pr.posting_date)} | ${format_currency(pr.grand_total)}`,\n                                value: pr.name\n                            })),\n                            reqd: 1\n                        }],\n                        primary_action_label: 'Print',\n                        primary_action(values) {\n                            frappe.set_route('print', 'Purchase Receipt', values.selected_pr);\n                            d.hide();\n                        }\n                    });\n\n                    let receipt_list = `<div class=\"receipt-list\" style=\"margin-top: 10px;\">\n                        <table class=\"table table-bordered\">\n                            <thead>\n                                <tr>\n                                    <th>Receipt No</th>\n                                    <th>Date</th>\n                                    <th>Status</th>\n                                    <th>Amount</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                            ${r.message.map(pr => `\n                                <tr>\n                                    <td>${pr.name}</td>\n                                    <td>${frappe.datetime.str_to_user(pr.posting_date)}</td>\n                                    <td>${pr.status}</td>\n                                    <td>${format_currency(pr.grand_total)}</td>\n                                </tr>\n                            `).join('')}\n                            </tbody>\n                        </table>\n                    </div>`;\n                    \n                    d.fields_dict.selected_pr.$wrapper.append(receipt_list);\n                    d.show();\n                }\n            });\n        }, true).addClass('btn-primary');\n    }\n};\nlistview.refresh();\nfrappe.listview_settings['Purchase Order'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};\n\nfrappe.listview_settings['Purchase Order'] = { // And other doctype names\n    hide_name_column: true\n}\nfrappe.listview_settings['Purchase Order'] = {\n\trefresh: function(listview) {\n\t   \t$(\"use.like-icon\").hide();\n\t}\n};\n\n\n\n\n\n\n\n\n\n\n\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-04-03 05:00:55.542056",
  "module": "o2o ErpNext",
  "name": "PO print script for PI",
  "script": "frappe.listview_settings['Purchase Invoice'] = {\n    onload: function(listview) {\n        // Original PI & PO Print Button\n        listview.page.add_button(__('Print PI & PO'), function() {\n            let selected_docs = listview.get_checked_items();\n            \n            if (selected_docs.length === 0) {\n                frappe.msgprint('Please select a Purchase Invoice');\n                return;\n            }\n            if (selected_docs.length > 1) {\n                frappe.msgprint('Please select only one Purchase Invoice');\n                return;\n            }\n            \n            // Show loading indicator\n            frappe.show_alert({\n                message: __('Preparing PDF, please wait...'),\n                indicator: 'blue'\n            }, 3);\n            \n            // Directly open the URL that triggers the download\n            var download_url = frappe.urllib.get_full_url(\n                '/api/method/o2o_erpnext.api.merge_pdf.merge_invoice_and_po_pdfs?' +\n                'invoice_name=' + encodeURIComponent(selected_docs[0].name)\n            );\n            \n            // Use the same window.open method as your other buttons\n            var w = window.open(download_url);\n            \n            if (w) {\n                frappe.show_alert({\n                    message: __('PDF download initiated'),\n                    indicator: 'green'\n                }, 3);\n            } else {\n                frappe.show_alert({\n                    message: __('Failed to download PDF. Please enable pop-ups and try again.'),\n                    indicator: 'red'\n                }, 5);\n            }\n        });\n\n\n        // New Button: Print with Header\n        listview.page.add_button(__('Print with Header'), function() {\n            const selected_docs = listview.get_checked_items();\n            if (selected_docs.length > 0) {\n                let successful_prints = 0;\n                \n                selected_docs.forEach((doc, index) => {\n                    frappe.model.with_doc('Purchase Invoice', doc.name, function() {\n                        setTimeout(() => {\n                            var w = window.open(\n                                frappe.urllib.get_full_url(\n                                    '/api/method/frappe.utils.print_format.download_pdf?' +\n                                    'doctype=' + encodeURIComponent('Purchase Invoice') +\n                                    '&name=' + encodeURIComponent(doc.name) +\n                                    '&format=' + encodeURIComponent('With Header Purchase Invoice') +\n                                    '&no_letterhead=0' +\n                                    '&_lang=en'\n                                )\n                            );\n                            \n                            if (w) {\n                                successful_prints++;\n                                if (index === selected_docs.length - 1) {\n                                    frappe.show_alert({\n                                        message: __(`Successfully initiated print for ${successful_prints} invoice(s)`),\n                                        indicator: 'green'\n                                    }, 5);\n                                }\n                            } else {\n                                frappe.show_alert({\n                                    message: __(`Failed to print ${doc.name}. Please enable pop-ups and try again.`),\n                                    indicator: 'red'\n                                }, 5);\n                            }\n                        }, index * 800);\n                    });\n                });\n            } else {\n                frappe.show_alert({\n                    message: __('Please select at least one Purchase Invoice'),\n                    indicator: 'yellow'\n                }, 3);\n            }\n        });\n\n        // New Button: Print without Header\n        listview.page.add_button(__('Print without Header'), function() {\n            const selected_docs = listview.get_checked_items();\n            if (selected_docs.length > 0) {\n                let successful_prints = 0;\n                \n                selected_docs.forEach((doc, index) => {\n                    frappe.model.with_doc('Purchase Invoice', doc.name, function() {\n                        setTimeout(() => {\n                            var w = window.open(\n                                frappe.urllib.get_full_url(\n                                    '/api/method/frappe.utils.print_format.download_pdf?' +\n                                    'doctype=' + encodeURIComponent('Purchase Invoice') +\n                                    '&name=' + encodeURIComponent(doc.name) +\n                                    '&format=' + encodeURIComponent('Without Header Purchase Invoice') +\n                                    '&no_letterhead=1' +\n                                    '&_lang=en'\n                                )\n                            );\n                            \n                            if (w) {\n                                successful_prints++;\n                                if (index === selected_docs.length - 1) {\n                                    frappe.show_alert({\n                                        message: __(`Successfully initiated print for ${successful_prints} invoice(s)`),\n                                        indicator: 'green'\n                                    }, 5);\n                                }\n                            } else {\n                                frappe.show_alert({\n                                    message: __(`Failed to print ${doc.name}. Please enable pop-ups and try again.`),\n                                    indicator: 'red'\n                                }, 5);\n                            }\n                        }, index * 800);\n                    });\n                });\n            } else {\n                frappe.show_alert({\n                    message: __('Please select at least one Purchase Invoice'),\n                    indicator: 'yellow'\n                }, 3);\n            }\n        });\n    }\n};\nlistview.refresh();\nfrappe.listview_settings['Purchase Invoice'] = {\n\tonload: function(listview) {\n\t\tfrappe.route_options = {\n\t\t\t\"status\": [\"=\", \"Draft\"]\n\t\t};\n\t}\n};\n\n\n\n\n\n\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Branch",
  "enabled": 1,
  "modified": "2024-10-25 23:33:52.070530",
  "module": "o2o ErpNext",
  "name": "Branch",
  "script": "frappe.ui.form.on('Branch', {\n\trefresh(frm) {\n\t\t// your code here\n\t\tfrm.set_query(\"custom_parent_branch\", function() {\n        return {\n            \"filters\": {\n                \"custom_child_branch\": 0,\n            }\n        };\n    });\n\t}\n})\n\n// frappe.ui.form.on('Shipping Address Details', {\n// \trefresh(frm) {\n// \t\t// your code here\n// \t\tfrm.set_query(\"city\", function() {\n//         return {\n//             \"filters\": {\n//                 city in state\n//             }\n//         };\n//     });\n// \t}\n// })\n\nfrappe.ui.form.on('Branch',  {\n    refresh: function(frm) {\n        frm.set_query(\"city\", \"custom_shipping_address_details\", function (doc, cdt, cdn) {\n          return {\n            \"filters\": {\n              \"State\": \"Maharashtra\",\n            },\n          };\n        });\n    }\n});\n//Remove Form View Menu contents\nfrappe.ui.form.on('Branch', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Jump%20to%20field\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Rename\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-12-24 16:11:24.019004",
  "module": "o2o ErpNext",
  "name": "Item Master",
  "script": "frappe.ui.form.on('Item', {\n    validate: function(frm) {\n        if (frm.doc.custom_o2o_rates && frm.doc.custom_gst_slab_percentage) {\n            var o2o_rates = parseFloat(frm.doc.custom_o2o_rates) || 0;\n            var gst_percentage = parseFloat(frm.doc.custom_gst_slab_percentage) || 0;\n            \n            var gst_amount = o2o_rates * gst_percentage / 100;\n            amt_in_gst = gst_amount + o2o_rates;\n            frm.set_value('custom_amt_in_gst',amt_in_gst);\n            frm.refresh_field('custom_amt_in_gst');\n        }\n    },\n    custom_o2o_rates: function(frm) {\n        console.log(frm.doc.custom_o2o_rates);\n        if (frm.doc.custom_o2o_rates && frm.doc.custom_gst_slab_percentage) {\n            var o2o_rates = parseFloat(frm.doc.custom_o2o_rates) || 0;\n            var gst_percentage = parseFloat(frm.doc.custom_gst_slab_percentage) || 0;\n            \n            var gst_amount = o2o_rates * gst_percentage / 100;\n            amt_in_gst = gst_amount + o2o_rates;\n            frm.set_value('custom_amt_in_gst',amt_in_gst);\n            frm.refresh_field('custom_amt_in_gst');\n        }\n    },\n    custom_gst_slab_percentage: function(frm) {\n        if (frm.doc.custom_o2o_rates && frm.doc.custom_gst_slab_percentage) {\n            var o2o_rates = parseFloat(frm.doc.custom_o2o_rates) || 0;\n            var gst_percentage = parseFloat(frm.doc.custom_gst_slab_percentage) || 0;\n            \n            var gst_amount = o2o_rates * gst_percentage / 100;\n            amt_in_gst = gst_amount + o2o_rates;\n            frm.set_value('custom_amt_in_gst',amt_in_gst);\n            frm.refresh_field('custom_amt_in_gst');\n        }\n    }\n    \n});\n\nfrappe.ui.form.on(\"Item\", {\nrefresh:function(frm) {\n    $('.form-attachments').hide()\n    $('.form-tags').hide()\n    $('.form-share').hide()\n    $('.form-attachments').hide()\n  }\n});\n\nfrappe.ui.form.on('Item', {\n\trefresh(frm) {\n\t\t// your code here\n\t\tfrm.set_query(\"custom_sub_category\", function() {\n        return {\n            \"filters\": {\n                \"is_group\": 0,\n            }\n        };\n    });\n\t}\n})\n\nfrappe.ui.form.on('Item', {\n    refresh(frm) {\n        setTimeout(() => {\n            // frm.remove_custom_button('Get Items From');\n            frm.remove_custom_button('Stock Projected Qty', 'View');\n            // frm.remove_custom_button('Stock Ledger', 'View');\n            // frm.remove_custom_button('Stock Balance', 'View');\n            frm.remove_custom_button('Add / Edit Prices', 'Actions');\n            frm.remove_custom_button('Duplicate');\n            }, 10);\n    }\n});\n//Remove Form View Menu contents\nfrappe.ui.form.on('Item', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Repeat\"],\\\n            [data-label=\"New%20Item\"],\\\n            [data-label=\"Rename\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2025-03-11 19:59:19.534576",
  "module": "o2o ErpNext",
  "name": "Purchase Receipt",
  "script": "frappe.ui.form.on('Purchase Receipt', {\n\trefresh(frm) {\n\t\t// your code here\n\t\tfrm.set_query(\"custom_vendor\", function() {\n        return {\n            \"filters\": {\n                \"custom_is_vendor\": 1,\n            }\n        };\n    });\n\t}\n})\n\nfrappe.ui.form.on('Purchase Receipt', {\n\trefresh(frm) {\n\t\t// your code here\n\t\tfrm.set_query(\"supplier\", function() {\n        return {\n            \"filters\": {\n                \"custom_is_vendor\": 0,\n            }\n        };\n    });\n\t}\n})\n\nfrappe.ui.form.on('Purchase Receipt', {\n    refresh: function (frm) {\n        // This function will run when the form is refreshed\n        // You can initialize or manipulate fields here if needed\n    },\n    onload: function (frm) {\n        // This function will run when the form is loaded\n        // You can initialize fields or set default values here if needed\n        let supplier = frm.doc.supplier;\n        if (supplier) {\n            // Get the first 3 characters of the supplier_code\n            let codeSubstring = supplier.substring(0, 3).toUpperCase();\n            \n            // Set the substring to another field or use it as needed\n            frm.set_value('custom_supplier_code', codeSubstring);\n        } else {\n            // Clear the substring field if supplier_code is empty\n            frm.set_value('custom_supplier_code', '');\n        }\n    },\n    supplier: function (frm) {\n        // This function triggers when `supplier_code` field is modified\n        let supplier = frm.doc.supplier;\n        if (supplier) {\n            // Get the first 3 characters of the supplier_code\n            let codeSubstring = supplier.substring(0, 3).toUpperCase();\n            \n            // Set the substring to another field or use it as needed\n            frm.set_value('custom_supplier_code', codeSubstring);\n        } else {\n            // Clear the substring field if supplier_code is empty\n            frm.set_value('custom_supplier_code', '');\n        }\n    }\n});\n\nfrappe.ui.form.on('Purchase Receipt', {\n    refresh: function (frm) {\n        // This function will run when the form is refreshed\n        // You can initialize or manipulate fields here if needed\n    },\n    onload: function (frm) {\n        // This function will run when the form is loaded\n        // You can initialize fields or set default values here if needed\n        let custom_vendor = frm.doc.custom_vendor;\n        if (custom_vendor) {\n            // Get the first 3 characters of the supplier_code\n            let codeSubstring = custom_vendor.substring(0, 3).toUpperCase();\n            \n            // Set the substring to another field or use it as needed\n            frm.set_value('custom_vendor_code', codeSubstring);\n        } else {\n            // Clear the substring field if supplier_code is empty\n            frm.set_value('custom_vendor_code', '');\n        }\n    },\n    custom_vendor: function (frm) {\n        // This function triggers when `supplier_code` field is modified\n        let custom_vendor = frm.doc.custom_vendor;\n        if (custom_vendor) {\n            // Get the first 3 characters of the supplier_code\n            let codeSubstring = custom_vendor.substring(0, 3).toUpperCase();\n            \n            // Set the substring to another field or use it as needed\n            frm.set_value('custom_vendor_code', codeSubstring);\n        } else {\n            // Clear the substring field if supplier_code is empty\n            frm.set_value('custom_vendor_code', '');\n        }\n    }\n});\n\nfrappe.ui.form.on('Purchase Receipt', {\n    refresh: function (frm) {\n        // This function will run when the form is refreshed\n        // You can initialize or manipulate fields here if needed\n    },\n    onload: function (frm) {\n        if (!frm.doc.fiscal_year) {\n            // Fetch the current fiscal year based on the current date\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Fiscal Year',\n                    filters: {\n                        'year_start_date': ['<=', frappe.datetime.get_today()],\n                        'year_end_date': ['>=', frappe.datetime.get_today()]\n                    },\n                    fields: ['name']\n                },\n                callback: function(r) {\n                    if (r.message && r.message.length > 0) {\n                        var fiscal_year = r.message[0].name;\n                        var start_year = fiscal_year.split('-')[0];\n                        var end_year = fiscal_year.split('-')[1];\n                        display_fiscal_year = start_year.substring(2) + '-' + end_year.substring(2);    \n                        console.log(\"==>\" + fiscal_year)\n                        frm.set_value('custom_fiscal_year', display_fiscal_year);\n                    }\n                }\n            });\n        }\n    }\n});\n\nfrappe.ui.form.on('Purchase Receipt', {\n    refresh(frm) {\n        setTimeout(() => {\n            // frm.remove_custom_button('Get Items From');\n            frm.remove_custom_button('Purchase Invoice', 'Get Items From');\n            frm.remove_custom_button('Purchase Order', 'Get Items From');\n            // frm.remove_custom_button('Preview');\n            frm.remove_custom_button('Stock Ledger', 'Preview');\n            frm.remove_custom_button('Accounting Ledger', 'Preview');\n            // frm.remove_custom_button('View');\n            frm.remove_custom_button('Asset', 'View');\n            frm.remove_custom_button('Stock Ledger', 'View');\n            frm.remove_custom_button('Accounting Ledger', 'View');\n            frm.remove_custom_button('Asset Movement', 'View');\n            frm.remove_custom_button('Purchase Return', 'Create');\n            frm.remove_custom_button('Make Stock Entry', 'Create');\n            // frm.remove_custom_button('Purchase Invoice', 'Create');\n            frm.remove_custom_button('Retention Stock Entry', 'Create');\n            frm.remove_custom_button('Close', 'Status');\n        }, 10);\n    }\n});\n//Remove Form View Menu contents\nfrappe.ui.form.on('Purchase Receipt', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Repeat\"],\\\n            [data-label=\"New%20Purchase%20Receipt\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});\n\n\nfrappe.ui.form.on('Purchase Receipt', {\n    refresh: function (frm) {\n        // This function will run when the form is refreshed\n        // You can initialize or manipulate fields here if needed\n    },\n    onload: function (frm) {\n    },\n    custom_weight_in_kg: function (frm) {\n        // This function triggers when `supplier_code` field is modified\n        let custom_weight_in_kg = frm.doc.custom_weight_in_kg;\n        let custom_rate_per_kg = frm.doc.custom_rate_per_kg;\n        let tax_percent = frm.doc.custom_freight_tax_rate_;\n        let total_freight_amount = 0;\n        let freight_tax_amount = 0;\n        if(custom_weight_in_kg==\"\") {\n            custom_weight_in_kg = 0;\n        }\n        \n        if(custom_rate_per_kg==\"\") {\n            custom_rate_per_kg = 0;\n        }\n        \n        if(tax_percent==\"\") {\n            tax_percent = 0;\n        }\n        \n        let freight_amount = 0;\n        freight_amount = custom_weight_in_kg * custom_rate_per_kg;\n        \n        freight_tax_amount = freight_amount * tax_percent /100;\n        total_freight_amount = freight_amount + freight_tax_amount;\n        \n        frm.set_value('custom_freight_amount', freight_amount);\n        frm.set_value('custom_total_freight_amount', total_freight_amount);\n    },\n    custom_rate_per_kg: function (frm) {\n        // This function triggers when `supplier_code` field is modified\n        let custom_weight_in_kg = frm.doc.custom_weight_in_kg;\n        let custom_rate_per_kg = frm.doc.custom_rate_per_kg;\n        let tax_percent = frm.doc.custom_freight_tax_rate_;\n        let total_freight_amount = 0;\n        let freight_tax_amount = 0;\n        if(custom_weight_in_kg==\"\") {\n            custom_weight_in_kg = 0;\n        }\n        \n        if(custom_rate_per_kg==\"\") {\n            custom_rate_per_kg = 0;\n        }\n        \n        if(tax_percent==\"\") {\n            tax_percent = 0;\n        }\n        \n        let freight_amount = 0;\n        freight_amount = custom_weight_in_kg * custom_rate_per_kg;\n        \n        freight_tax_amount = freight_amount * tax_percent /100;\n        total_freight_amount = freight_amount + freight_tax_amount;\n        \n        frm.set_value('custom_freight_amount', freight_amount);\n        frm.set_value('custom_total_freight_amount', total_freight_amount);\n        \n    },\n    custom_freight_tax_rate_: function (frm) {\n        // This function triggers when `supplier_code` field is modified\n        let custom_weight_in_kg = frm.doc.custom_weight_in_kg;\n        let custom_rate_per_kg = frm.doc.custom_rate_per_kg;\n        let tax_percent = frm.doc.custom_freight_tax_rate_;\n        let total_freight_amount = 0;\n        let freight_tax_amount = 0;\n        if(custom_weight_in_kg==\"\") {\n            custom_weight_in_kg = 0;\n        }\n        \n        if(custom_rate_per_kg==\"\") {\n            custom_rate_per_kg = 0;\n        }\n        \n        if(tax_percent==\"\") {\n            tax_percent = 0;\n        }\n        \n        let freight_amount = 0;\n        freight_amount = custom_weight_in_kg * custom_rate_per_kg;\n        \n        freight_tax_amount = freight_amount * tax_percent /100;\n        total_freight_amount = freight_amount + freight_tax_amount;\n        \n        frm.set_value('custom_freight_amount', freight_amount);\n        frm.set_value('custom_total_freight_amount', total_freight_amount);\n        \n    }\n    \n});\n\nfrappe.ui.form.on('Purchase Receipt', {\n    refresh: function (frm) {\n        // This function will run when the form is refreshed\n        // You can initialize or manipulate fields here if needed\n    },\n    onload: function (frm) {\n        let total_gstn_value = 0;\n         $.each(frm.doc.items, function(i, d) {\n             \n             total_gstn_value = parseFloat(total_gstn_value) + parseFloat(d['custom_gstn_value']);\n             console.log(d);\n             console.log(total_gstn_value);\n         });\n        \n        frm.set_value('custom_total_gstn', total_gstn_value);\n    },\n});\n\n\n\n\n\n\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.540102",
  "module": "o2o ErpNext",
  "name": "Supplier Master",
  "script": "frappe.ui.form.on('Supplier', {\n\trefresh(frm) {\n\t\t// your code here\n\t\tfrm.set_query(\"custom_branch\", function() {\n        return {\n            \"filters\": {\n                \"custom_child_branch\": 0,\n            }\n        };\n    });\n\t}\n})\n\nfunction custom_is_vendor(frm) {\n  \n                    if (custom_is_vendor = 0) {\n                        custom_branch = 1;\n                   \n                }\n            };\nfrappe.ui.form.on('Supplier', {\n    refresh(frm) {\n        setTimeout(() => {\n            frm.remove_custom_button('Bank Account', 'Create');\n            frm.remove_custom_button('Pricing Rule', 'Create');\n            frm.remove_custom_button('Accounts Payable', 'View');\n            frm.remove_custom_button('Accounting Ledger', 'View');\n            frm.remove_custom_button('Get Supplier Group Details', 'Actions');\n        }, 10);\n    }\n});\n//Remove Form View Menu contents\nfrappe.ui.form.on('Supplier', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Rename\"],\\\n            [data-label=\"New%20Supplier\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.210238",
  "module": "o2o ErpNext",
  "name": "Purchase_Receipt_Frieght_Calc",
  "script": "frappe.ui.form.on('Purchase Receipt', {\n    // Trigger on form refresh or save\n    refresh: function(frm) {\n        // Trigger when the document is saved\n        frm.add_custom_button(__('Calculate Charges'), function() {\n            calculate_freight_and_forwarding(frm);\n        });\n        \n    },\n    // Trigger when custom fields are changed\n    freight_charges: function(frm) {\n        calculate_freight_and_forwarding(frm);\n    },\n    custom_weight_in_kg: function(frm) {\n        calculate_freight_and_forwarding(frm);\n    },\n    custom_rate_per_kg: function(frm) {\n        calculate_freight_and_forwarding(frm);\n    }\n\n});\n\nfunction calculate_freight_and_forwarding(frm) {\n    // console.log(\"here\");\n    // Add your calculation logic here\n    let custom_weight_in_kg = frm.doc.custom_weight_in_kg || 0;\n    let custom_rate_per_kg = frm.doc.custom_rate_per_kg || 0;\n    let total_freight_charges = custom_weight_in_kg * custom_rate_per_kg;\n    let freight_cnt = 0;\n    // console.log(frm.doc)\n    if (frm.doc.taxes) {\n        $.each(frm.doc.taxes || [], function (j, tax) {\n            if (tax.account_head) {\n                \n                if (tax.account_head.includes('Freight and Forwarding Charges') && freight_cnt == 0) {\n                    // console.log(\"here\"+ tax.account_head + \"  =>\" + freight_cnt);\n                    frappe.model.set_value(tax.doctype, tax.name, 'tax_amount', total_freight_charges);\n                    frm.refresh_field('purchase_taxes_and_charges');\n                    freight_cnt++;\n                } \n            }\n        });\n        \n        // return false;\n        // console.log(item)\n        \n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item Group",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.847564",
  "module": "o2o ErpNext",
  "name": "Item Group Master",
  "script": "//Remove form view menu contents\nfrappe.listview_settings['Item Group'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n    }\n}\nfrappe.listview_settings['Item Group'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};\n\nfrappe.listview_settings['Item Group'] = { // And other doctype names\n    hide_item_group_name_column: true\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.522104",
  "module": "o2o ErpNext",
  "name": "Supplier Master List View",
  "script": "frappe.listview_settings['Supplier'] = { // And other doctype names\n    hide_name_column: true\n}\n//List view menu contents remove\nfrappe.listview_settings['Supplier'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n    }\n}\n//Remove Action button menu contents\nfrappe.listview_settings['Supplier'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};\n\n\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Branch",
  "enabled": 1,
  "modified": "2024-10-25 23:33:52.135635",
  "module": "o2o ErpNext",
  "name": "Branch Master List View",
  "script": "frappe.listview_settings['Branch'] = { // And other doctype names\n    hide_name_column: true\n}\n//Remove form view menu contents\nfrappe.listview_settings['Branch'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n    }\n}\nfrappe.listview_settings['Branch'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item Group",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.482973",
  "module": "o2o ErpNext",
  "name": "Item Group",
  "script": "frappe.ui.form.on('Item Group', {\n    refresh(frm) {\n        setTimeout(() => {\n            frm.remove_custom_button('Items');\n        }, 10);\n    }\n});\nfrappe.ui.form.on(\"Item Group\", \"validate\", function(frm) {\n    cur_frm.set_value(\"custom_created_user\", frm.doc.owner);\n});\n\n//Remove Form View Menu contents\nfrappe.ui.form.on('Item Group', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Jump%20to%20field\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Rename\"],\\\n            [data-label=\"New%20Item%20Group\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item Price",
  "enabled": 1,
  "modified": "2024-10-25 23:33:52.119512",
  "module": "o2o ErpNext",
  "name": "Item Price List View",
  "script": "frappe.listview_settings['Item Price'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n        listview.page.find('[data-label=\"Dashboard\"]').parent().hide();\n    }\n}\nfrappe.listview_settings['Item Price'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Brand",
  "enabled": 1,
  "modified": "2024-10-25 23:33:52.086980",
  "module": "o2o ErpNext",
  "name": "Brand Master List View",
  "script": "//List view menu contents remove\nfrappe.listview_settings['Brand'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n    }\n}\nfrappe.listview_settings['Brand'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "File",
  "enabled": 1,
  "modified": "2024-10-25 23:33:52.037036",
  "module": "o2o ErpNext",
  "name": "File Master List View",
  "script": "//List view menu contents remove\nfrappe.listview_settings['File'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"Home\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"New%20Folder\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import%20Zip\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n    }\n}\nfrappe.listview_settings['File'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export%20as%20zip\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Data Import",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.987375",
  "module": "o2o ErpNext",
  "name": "Data Import List View",
  "script": "//List view menu contents remove\nfrappe.listview_settings['Data Import'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n    }\n}\nfrappe.listview_settings['Data Import'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "User",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.576602",
  "module": "o2o ErpNext",
  "name": "User Master List View",
  "script": "frappe.listview_settings['User'] = { // And other doctype names\n    hide_name_column: true\n}\n//Remove form view menu contents\nfrappe.listview_settings['User'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n        // listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n    }\n}\nfrappe.listview_settings['User'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "User",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.227717",
  "module": "o2o ErpNext",
  "name": "User Master",
  "script": "frappe.ui.form.on('User', {\n    refresh(frm) {\n        setTimeout(() => {\n            // frm.remove_custom_button('Get Items From');\n            frm.remove_custom_button('Set User Permissions','Permissions');\n            frm.remove_custom_button('View Permitted Documents','Permissions');\n            frm.remove_custom_button('Create User Email');\n            }, 10);\n    }\n});\n//Remove Form View Menu contents\nfrappe.ui.form.on('User', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Repeat\"],\\\n            [data-label=\"New%20User\"],\\\n            [data-label=\"Rename\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "User Permission",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.920644",
  "module": "o2o ErpNext",
  "name": "User Permission Master",
  "script": "frappe.ui.form.on('User Permission', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Jump%20to%20field\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"New%20User%20Permission\"],\\\n            [data-label=\"Customize\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});\n\nfrappe.ui.form.on('User Permission', {\n    refresh(frm) {\n        setTimeout(() => {\n            frm.remove_custom_button('View Permitted Documents');\n        }, 10);\n    }\n});\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Role Profile",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.881342",
  "module": "o2o ErpNext",
  "name": "Role Prpfile List View",
  "script": "frappe.listview_settings['Role Profile'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};\nfrappe.listview_settings['Role Profile'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n    }\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item Price",
  "enabled": 1,
  "modified": "2024-10-25 23:33:52.103016",
  "module": "o2o ErpNext",
  "name": "Item Price Master",
  "script": "frappe.ui.form.on('Item Price', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Jump%20to%20field\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Repeat\"],\\\n            [data-label=\"New%20Item%20Price\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Brand",
  "enabled": 1,
  "modified": "2024-10-25 23:33:52.053533",
  "module": "o2o ErpNext",
  "name": "Brand Master",
  "script": "frappe.ui.form.on('Brand', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Jump%20to%20field\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Rename\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "File",
  "enabled": 1,
  "modified": "2024-10-25 23:33:52.020114",
  "module": "o2o ErpNext",
  "name": "File Master",
  "script": "frappe.ui.form.on('File', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Jump%20to%20field\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Rename\"],\\\n            [data-label=\"New%20File\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Data Import",
  "enabled": 1,
  "modified": "2024-10-25 23:33:52.004100",
  "module": "o2o ErpNext",
  "name": "Data Import Master",
  "script": "//Remove Form View Menu contents\nfrappe.ui.form.on('Data Import', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Jump%20to%20field\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Rename\"],\\\n            [data-label=\"New%20Data%20Import\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Workspace",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.969652",
  "module": "o2o ErpNext",
  "name": "Workspace Master",
  "script": "frappe.ui.form.on('Purchase Order', {\n    refresh(frm) {\n        setTimeout(() => {\n            frm.remove_custom_button(\"Edit\");\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bank",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.953615",
  "module": "o2o ErpNext",
  "name": "Bank Master List View",
  "script": "frappe.listview_settings['Bank'] = { // And other doctype names\n    hide_custom_account_name_column: true\n}\n//List view menu contents remove\nfrappe.listview_settings['Bank'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n    }\n}\nfrappe.listview_settings['Bank'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};\n\n\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bank",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.936970",
  "module": "o2o ErpNext",
  "name": "Bank Master",
  "script": "frappe.ui.form.on('Bank', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Jump%20to%20field\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Rename\"],\\\n            [data-label=\"New%20Bank\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "User Permission",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.900955",
  "module": "o2o ErpNext",
  "name": "User Permission List View",
  "script": "frappe.listview_settings['User Permission'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};\nfrappe.listview_settings['User Permission'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n    }\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Role Profile",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.864224",
  "module": "o2o ErpNext",
  "name": "Role Profile",
  "script": "//Remove Form View Menu contents\nfrappe.ui.form.on('Role Profile', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Jump%20to%20field\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"New%20Role%20Profile\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Gst Slab",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.812253",
  "module": "o2o ErpNext",
  "name": "GST Slab List View",
  "script": "frappe.listview_settings['Gst Slab'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Export\"]').parent().parent().remove()\n};\n//Remove form view menu contents\nfrappe.listview_settings['Gst Slab'] = {\n    refresh(listview) {\n        listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n        listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n    }\n}\nfrappe.listview_settings['Gst Slab'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Gst Slab",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.830655",
  "module": "o2o ErpNext",
  "name": "GST Slab",
  "script": "frappe.ui.form.on('Gst Slab', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Jump%20to%20field\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Rename\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Reconciliation",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.685804",
  "module": "o2o ErpNext",
  "name": "Stock Reconciliation",
  "script": "frappe.ui.form.on('Stock Reconciliation', {\n    refresh(frm) {\n        setTimeout(() => {\n            frm.remove_custom_button('Fetch Items from Warehouse');\n            frm.remove_custom_button('Product Bundle', 'Get Items From');\n            frm.remove_custom_button('Accounting Ledger', 'View');\n        }, 10);\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.794939",
  "module": "o2o ErpNext",
  "name": "Stock Entry",
  "script": "\nfrappe.ui.form.on('Stock Entry', {\n    refresh(frm) {\n        setTimeout(() => {\n            frm.remove_custom_button('Get Items From');\n            frm.remove_custom_button('Purchase Invoice', 'Get Items From');\n            frm.remove_custom_button('Material Request', 'Get Items From');\n            frm.remove_custom_button('Bill of Materials', 'Get Items From');\n            frm.remove_custom_button('Expired Batches', 'Get Items From');\n            frm.remove_custom_button('Transit Entry', 'Get Items From');\n            frm.remove_custom_button('Material Request', 'Create');\n            frm.remove_custom_button('Accounting Ledger', 'View');\n        }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Homepage",
  "enabled": 1,
  "modified": "2024-10-25 23:33:51.340426",
  "module": "o2o ErpNext",
  "name": "Homepage",
  "script": "frappe.ui.form.on('Homepage', {\n    refresh(frm) {\n        setTimeout(() => {\n            // frm.remove_custom_button('Get Items From');\n            frm.remove_custom_button('Stock Projected Qty', 'View');\n            }, 10);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2024-11-08 09:24:16.027936",
  "module": "o2o ErpNext",
  "name": "Purchase invoice List View",
  "script": "frappe.listview_settings['Purchase Invoice'] = {\n    button: {\n        show: function(doc) {\n            return true;\n        },\n        get_label: function() {\n            return __('<i class=\"fa fa-print\" style=\"font-size:20px;color:red\"></i>');\n        },\n        get_description: function(doc) {\n            return __('Print {0}', [doc.name])\n        },\n        action: function(doc) {\n            //frappe.set_route(\"/app/print/Purchase Invoice/\" + doc.name);\n            \n            var objWindowOpenResult = window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n              + \"doctype=\" + encodeURIComponent(\"Purchase Invoice\")\n              + \"&name=\" + encodeURIComponent(doc.name)\n              + \"&trigger_print=0\"\n              + \"&format=Without Header Final Purchase Invoice\"\n              + \"&no_letterhead=0\"\n              + \"&_lang=en\"\n            ));\n\n            if(!objWindowOpenResult) {\n              msgprint(__(\"Please set permission for pop-up windows in your browser!\")); return;\n            }\n        }\n    }\n}\n//List view menu contents remove\n// frappe.listview_settings['Purchase Invoice'] = {\n//     refresh(listview) {\n//         listview.page.menu.find('[data-label=\"User%20Permissions\"]').parent().hide();\n//         listview.page.menu.find('[data-label=\"Role%20Permissions%20Manager\"]').parent().hide();\n//         listview.page.menu.find('[data-label=\"Import\"]').parent().hide();\n//         listview.page.menu.find('[data-label=\"Toggle%20Sidebar\"]').parent().hide();\n//         listview.page.menu.find('[data-label=\"List%Settings\"]').parent().hide();\n//     }\n// }\nfrappe.listview_settings['Purchase Invoice'].onload = function(listview) {\n\t\tlistview.page.actions.find('[data-label=\"Edit\"],[data-label=\"Print\"],[data-label=\"Export\"],[data-label=\"Assign%20To\"],[data-label=\"Apply%20Assignment%20Rule\"],[data-label=\"Add%20Tags\"]').parent().parent().remove()\n};\n\n// Remove ID column from listing\n// frappe.listview_settings['Purchase Invoice'] = { // And other doctype names\n//     hide_name_column: true\n// }\n\n\n\n\n\n\n\n\n\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2024-11-08 09:11:07.883406",
  "module": "o2o ErpNext",
  "name": "Purchase invoice",
  "script": "frappe.ui.form.on('Purchase Invoice', {\n\trefresh(frm) {\n\t\t// your code here\n\t\tfrm.set_query(\"custom_vendor\", function() {\n        return {\n            \"filters\": {\n                \"custom_is_vendor\": 1,\n            }\n        };\n    });\n\t}\n})\n\nfrappe.ui.form.on('Purchase Invoice', {\n\trefresh(frm) {\n\t\t// your code here\n\t\tfrm.set_query(\"supplier\", function() {\n        return {\n            \"filters\": {\n                \"custom_is_vendor\": 0,\n            }\n        };\n    });\n\t}\n})\n\nfrappe.ui.form.on('Purchase Invoice', {\n\trefresh(frm) {\n\t\t// your code here\n\t\tfrm.set_query(\"shipping_address\", function() {\n        return {\n            \"filters\": {\n                \"is_shipping_address\": 1,\n            }\n        };\n    });\n\t}\n})\n\nfrappe.ui.form.on('Purchase Invoice', {\n\trefresh(frm) {\n\t\t// your code here\n\t\tfrm.set_query(\"billing_address\", function() {\n        return {\n            \"filters\": {\n                \"is_primary_address\": 1,\n            }\n        };\n    });\n\t}\n})\n\nfrappe.ui.form.on('Purchase Invoice', {\n\trefresh(frm) {\n\t\t// your code here\n\t\tfrm.set_query(\"custom_vendor_address\", function() {\n        return {\n            \"filters\": {\n                \"custom_is_vendor_address\": 1,\n            }\n        };\n    });\n\t}\n})\n\nfrappe.ui.form.on(\"Purchase Invoice Item\", \"custom_gstn_value\", function(frm, cdt, cdn) {\n\n   var items = frm.doc.custom_gstn_value\n   var total = 0\n   for(var i in items) {\n\ttotal = total + items[i].custom_gstn_value\n\t}\n\n\tfrm.set_value(\"custom_gst_28__ot\",total)\n});\n\n\nfrappe.ui.form.on('Purchase Invoice', {\n    refresh: function (frm) {\n        // This function will run when the form is refreshed\n        // You can initialize or manipulate fields here if needed\n    },\n    onload: function (frm) {\n        // This function will run when the form is loaded\n        // You can initialize fields or set default values here if needed\n        let custom_vendor = frm.doc.custom_vendor;\n        if (custom_vendor) {\n            // Get the first 3 characters of the supplier_code\n            let codeSubstring = custom_vendor.substring(0, 5).toUpperCase();\n            \n            // Set the substring to another field or use it as needed\n            frm.set_value('custom_vendor_code', codeSubstring);\n        } else {\n            // Clear the substring field if supplier_code is empty\n            frm.set_value('custom_vendor_code', '');\n        }\n    },\n    custom_vendor: function (frm) {\n        // This function triggers when `supplier_code` field is modified\n        let custom_vendor = frm.doc.custom_vendor;\n        if (custom_vendor) {\n            // Get the first 3 characters of the supplier_code\n            let codeSubstring = custom_vendor.substring(0, 5).toUpperCase();\n            \n            // Set the substring to another field or use it as needed\n            frm.set_value('custom_vendor_code', codeSubstring);\n        } else {\n            // Clear the substring field if supplier_code is empty\n            frm.set_value('custom_vendor_code', '');\n        }\n    }\n});\n\n\nfrappe.ui.form.on('Purchase Invoice', {\n    refresh: function (frm) {\n        // This function will run when the form is refreshed\n        // You can initialize or manipulate fields here if needed\n    },\n    onload: function (frm) {\n        if (!frm.doc.fiscal_year) {\n            // Fetch the current fiscal year based on the current date\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Fiscal Year',\n                    filters: {\n                        'year_start_date': ['<=', frappe.datetime.get_today()],\n                        'year_end_date': ['>=', frappe.datetime.get_today()]\n                    },\n                    fields: ['name']\n                },\n                callback: function(r) {\n                    if (r.message && r.message.length > 0) {\n                        var fiscal_year = r.message[0].name;\n                        var start_year = fiscal_year.split('-')[0];\n                        var end_year = fiscal_year.split('-')[1];\n                        display_fiscal_year = start_year.substring(2) + '-' + end_year.substring(2);    \n                        console.log(\"==>\" + fiscal_year)\n                        frm.set_value('custom_fiscal_year', display_fiscal_year);\n                    }\n                }\n            });\n        }\n    }\n});\n\nfrappe.ui.form.on('Purchase Invoice', {\n    is_return: function(frm) {\n        if (frm.doc.is_return == 1) {\n            frm.set_value('naming_series','DN./.{custom_fiscal_year}./.###');\n        } else{\n            frm.set_value('naming_series','{custom_vendor_code}./.{custom_fiscal_year}./.###');\n        }\n    }\n});\n\nfrappe.ui.form.on('Purchase Invoice', {\n    refresh(frm) {\n        setTimeout(() => {\n            // frm.remove_custom_button('Get Items From');\n            frm.remove_custom_button('Purchase Order', 'Get Items From');\n            frm.remove_custom_button('Purchase Receipt', 'Get Items From');\n            frm.remove_custom_button('Accounting Ledger', 'Preview');\n            frm.remove_custom_button('Payment Request', 'Create');\n            frm.remove_custom_button('Block Invoice', 'Create');\n            frm.remove_custom_button('Payment', 'Create');\n            // frm.remove_custom_button('Return / Debit Note', 'Create');\n            frm.remove_custom_button('Purchase Receipt', 'View');\n            frm.remove_custom_button('Accounting Ledger', 'View');\n        }, 10);\n    }\n});\n//Remove Form View Menu contents\nfrappe.ui.form.on('Purchase Invoice', {\n    refresh: function(frm) {\n        setTimeout( () => {\n            // frm.page.remove_inner_button('Print');\n            // frm.page.remove_inner_button('Customer', 'Create');\n            // frm.page.remove_inner_button('Quotation', 'Create');\n            // frm.page.remove_inner_button('Add to Prospect', 'Action');\n            frm.page.menu.find('[data-label=\"Create%20%3E%20Customer\"],\\\n            [data-label=\"Print\"],\\\n            [data-label=\"Email\"],\\\n            [data-label=\"Links\"],\\\n            [data-label=\"Jump%20to%20field\"],\\\n            [data-label=\"Duplicate\"],\\\n            [data-label=\"Send%20SMS\"],\\\n            [data-label=\"Copy%20to%20Clipboard\"],\\\n            [data-label=\"Reload\"],\\\n            [data-label=\"Delete\"],\\\n            [data-label=\"Remind%20Me\"],\\\n            [data-label=\"Undo\"],\\\n            [data-label=\"Redo\"],\\\n            [data-label=\"Repeat\"],\\\n            [data-label=\"New%20Purchase%20Invoice\"],\\\n            [data-label=\"Action%20%3E%20Add%20to%20Prospect\"]').parent().parent().remove();\n        }, 10);\n    }\n});\n\nfrappe.ui.form.on('Purchase Invoice', {\n    refresh: function (frm) {\n        // This function will run when the form is refreshed\n        // You can initialize or manipulate fields here if needed\n        let freight_amount = frm.doc.custom_freight_amount;\n        let freight_tax_amount = (freight_amount * 18) /100;\n        frm.set_value('custom_freight_taxes', freight_tax_amount);\n    },\n    onload: function (frm) {\n        let freight_amount = frm.doc.custom_freight_amount;\n        let freight_tax_amount = (freight_amount * 18) /100;\n        frm.set_value('custom_freight_taxes', freight_tax_amount);\n    },\n});\n\nfrappe.ui.form.on('Purchase Invoice', {\n    refresh: function (frm) {\n        // This function will run when the form is refreshed\n        // You can initialize or manipulate fields here if needed\n        let total_cgst = 0;\n        let total_sgst = 0;\n        let total_igst = 0;\n    \n        frm.doc.items.forEach(function(item_detail) {\n            if (item_detail.cgst_amount >0) {  \n                // Set both rate and amount to 0\n                total_cgst = parseFloat(total_cgst) + item_detail.cgst_amount;\n            }\n            \n            if (item_detail.sgst_amount >0) {  \n                // Set both rate and amount to 0\n                total_sgst = parseFloat(total_sgst) + item_detail.sgst_amount;\n            }\n            \n            if (item_detail.igst_amount >0) {  \n                // Set both rate and amount to 0\n                total_igst = parseFloat(total_igst) + item_detail.igst_amount;\n            }\n        \n        });\n        frm.set_value('custom_total_cgst', total_cgst);\n        frm.set_value('custom_total_sgst', total_sgst);\n        frm.set_value('custom_total_igst', total_igst);\n        \n    },\n    onload: function (frm) {\n        // This function will run when the form is refreshed\n        // You can initialize or manipulate fields here if needed\n        let total_cgst = 0;\n        let total_sgst = 0;\n        let total_igst = 0;\n    \n        frm.doc.items.forEach(function(item_detail) {\n            if (item_detail.cgst_amount >0) {  \n                // Set both rate and amount to 0\n                total_cgst = parseFloat(total_cgst) + item_detail.cgst_amount;\n            }\n            \n            if (item_detail.sgst_amount >0) {  \n                // Set both rate and amount to 0\n                total_sgst = parseFloat(total_sgst) + item_detail.sgst_amount;\n            }\n            \n            if (item_detail.igst_amount >0) {  \n                // Set both rate and amount to 0\n                total_igst = parseFloat(total_igst) + item_detail.igst_amount;\n            }\n        \n        });\n        frm.set_value('custom_total_cgst', total_cgst);\n        frm.set_value('custom_total_sgst', total_sgst);\n        frm.set_value('custom_total_igst', total_igst);\n    },\n});\n\n\n\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2024-11-08 09:23:55.953956",
  "module": "o2o ErpNext",
  "name": "Purchase invoice print button",
  "script": "frappe.listview_settings['Purchase Invoice'] = {\n    add_fields: ['name', 'supplier'],\n    \n    onload: function(listview) {\n        // Print with Header\n        listview.page.add_action_item(__('Print with Header'), function() {\n            const selected_docs = listview.get_checked_items();\n            if (selected_docs.length > 0) {\n                let successful_prints = 0;\n                \n                // Process each selected document\n                selected_docs.forEach((doc, index) => {\n                    frappe.model.with_doc('Purchase Invoice', doc.name, function() {\n                        setTimeout(() => {\n                            var w = window.open(\n                                frappe.urllib.get_full_url(\n                                    '/api/method/frappe.utils.print_format.download_pdf?' +\n                                    'doctype=' + encodeURIComponent('Purchase Invoice') +\n                                    '&name=' + encodeURIComponent(doc.name) +\n                                    '&format=' + encodeURIComponent('Final Purchase Invoice') +\n                                    '&no_letterhead=0' +\n                                    '&_lang=en'\n                                )\n                            );\n                            \n                            if (w) {\n                                successful_prints++;\n                                // Show success message after all prints are initiated\n                                if (index === selected_docs.length - 1) {\n                                    frappe.show_alert({\n                                        message: __(`Successfully initiated print for ${successful_prints} invoice(s)`),\n                                        indicator: 'green'\n                                    }, 5);\n                                }\n                            } else {\n                                frappe.show_alert({\n                                    message: __(`Failed to print ${doc.name}. Please enable pop-ups and try again.`),\n                                    indicator: 'red'\n                                }, 5);\n                            }\n                        }, index * 800); // Add delay between prints to prevent browser blocking\n                    });\n                });\n            } else {\n                frappe.show_alert({\n                    message: __('Please select at least one Purchase Invoice'),\n                    indicator: 'yellow'\n                }, 3);\n            }\n        });\n\n        // Print without Header\n        listview.page.add_action_item(__('Print without Header'), function() {\n            const selected_docs = listview.get_checked_items();\n            if (selected_docs.length > 0) {\n                let successful_prints = 0;\n                \n                // Process each selected document\n                selected_docs.forEach((doc, index) => {\n                    frappe.model.with_doc('Purchase Invoice', doc.name, function() {\n                        setTimeout(() => {\n                            var w = window.open(\n                                frappe.urllib.get_full_url(\n                                    '/api/method/frappe.utils.print_format.download_pdf?' +\n                                    'doctype=' + encodeURIComponent('Purchase Invoice') +\n                                    '&name=' + encodeURIComponent(doc.name) +\n                                    '&format=' + encodeURIComponent('Without Header Final Purchase Invoice') +\n                                    '&no_letterhead=1' +\n                                    '&_lang=en'\n                                )\n                            );\n                            \n                            if (w) {\n                                successful_prints++;\n                                // Show success message after all prints are initiated\n                                if (index === selected_docs.length - 1) {\n                                    frappe.show_alert({\n                                        message: __(`Successfully initiated print for ${successful_prints} invoice(s)`),\n                                        indicator: 'green'\n                                    }, 5);\n                                }\n                            } else {\n                                frappe.show_alert({\n                                    message: __(`Failed to print ${doc.name}. Please enable pop-ups and try again.`),\n                                    indicator: 'red'\n                                }, 5);\n                            }\n                        }, index * 800); // Add delay between prints to prevent browser blocking\n                    });\n                });\n            } else {\n                frappe.show_alert({\n                    message: __('Please select at least one Purchase Invoice'),\n                    indicator: 'yellow'\n                }, 3);\n            }\n        });\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-04-07 16:58:26.650985",
  "module": "o2o ErpNext",
  "name": "Employee v2",
  "script": "frappe.ui.form.on('Employee', {\n    refresh: function(frm) {\n        // Add custom button if user is not created/linked\n        if (!frm.doc.user_id && frm.doc.custom_user_email) {\n            frm.add_custom_button(__('Create User'), function() {\n                frm.events.show_password_dialog(frm);\n            }).addClass('btn-primary');\n        }\n        \n        // Add reset password button if user is already linked\n        if (frm.doc.user_id) {\n            frm.add_custom_button(__('Reset Password'), function() {\n                frm.events.show_reset_password_dialog(frm);\n            }).addClass('btn-primary');\n        }\n    },\n    \n    show_password_dialog: function(frm) {\n        if (!frm.doc.custom_user_email) {\n            frappe.throw(__(\"Please enter Email in Custom User Email field\"));\n            return;\n        }\n        \n        // Create a dialog to ask for password\n        let d = new frappe.ui.Dialog({\n            title: __('Create User'),\n            fields: [\n                {\n                    label: __('Email'),\n                    fieldname: 'email',\n                    fieldtype: 'Data',\n                    default: frm.doc.custom_user_email,\n                    read_only: 1\n                },\n                {\n                    label: __('Set Password'),\n                    fieldname: 'set_password',\n                    fieldtype: 'Check',\n                    default: 0,\n                    description: __('If unchecked, default password \"admin@123\" will be used')\n                },\n                {\n                    label: __('Password'),\n                    fieldname: 'password',\n                    fieldtype: 'Password',\n                    depends_on: 'set_password'\n                },\n                {\n                    label: __('Confirm Password'),\n                    fieldname: 'confirm_password',\n                    fieldtype: 'Password',\n                    depends_on: 'set_password'\n                }\n            ],\n            primary_action_label: __('Create'),\n            primary_action: function(values) {\n                if (values.set_password) {\n                    // Validate password\n                    if (!values.password) {\n                        frappe.throw(__(\"Please enter password\"));\n                        return;\n                    }\n                    if (values.password != values.confirm_password) {\n                        frappe.throw(__(\"Passwords do not match\"));\n                        return;\n                    }\n                    if (values.password.length < 8) {\n                        frappe.throw(__(\"Password must be at least 8 characters long\"));\n                        return;\n                    }\n                }\n                \n                d.hide();\n                frm.events.create_user(frm, values.set_password ? values.password : null);\n            }\n        });\n        \n        d.show();\n    },\n    \n    create_user: function(frm, password) {\n        frappe.call({\n            method: \"o2o_erpnext.api.employee.create_user\",\n            args: {\n                employee: frm.doc.name,\n                email: frm.doc.custom_user_email,\n                password: password\n            },\n            freeze: true,\n            freeze_message: __(\"Creating User...\"),\n            callback: function(r) {\n                if (!r.exc) {\n                    // Force reload the form\n                    frm.reload_doc();\n                    // Refresh the form\n                    setTimeout(function() {\n                        cur_frm.refresh();\n                    }, 1000);\n                }\n            }\n        });\n    },\n    \n    show_reset_password_dialog: function(frm) {\n        if (!frm.doc.user_id) {\n            frappe.throw(__(\"No user linked to this employee\"));\n            return;\n        }\n        \n        // Create a dialog to ask for the new password\n        let d = new frappe.ui.Dialog({\n            title: __('Reset User Password'),\n            fields: [\n                {\n                    label: __('User'),\n                    fieldname: 'user',\n                    fieldtype: 'Data',\n                    default: frm.doc.user_id,\n                    read_only: 1\n                },\n                {\n                    label: __('New Password'),\n                    fieldname: 'password',\n                    fieldtype: 'Password',\n                    reqd: 1\n                },\n                {\n                    label: __('Confirm Password'),\n                    fieldname: 'confirm_password',\n                    fieldtype: 'Password',\n                    reqd: 1\n                }\n            ],\n            primary_action_label: __('Reset Password'),\n            primary_action: function(values) {\n                // Validate password\n                if (values.password != values.confirm_password) {\n                    frappe.throw(__(\"Passwords do not match\"));\n                    return;\n                }\n                if (values.password.length < 8) {\n                    frappe.throw(__(\"Password must be at least 8 characters long\"));\n                    return;\n                }\n                \n                d.hide();\n                frm.events.reset_password(frm, values.password);\n            }\n        });\n        \n        d.show();\n    },\n    \n    reset_password: function(frm, password) {\n        frappe.call({\n            method: \"o2o_erpnext.api.employee.reset_user_password\",\n            args: {\n                employee: frm.doc.name,\n                password: password\n            },\n            freeze: true,\n            freeze_message: __(\"Resetting Password...\"),\n            callback: function(r) {\n                if (!r.exc) {\n                    frappe.show_alert({\n                        message: __(\"Password reset successfully\"),\n                        indicator: 'green'\n                    });\n                }\n            }\n        });\n    }\n});\n\n//Date of joining auto set\n// frappe.ui.form.on('Employee', {\n//     onload: function(frm) {\n//         // Only set the date if it's a new document (not saved yet)\n//         if (frm.is_new()) {\n//             // Get current date\n//             let currentDate = new Date();\n            \n//             // Subtract 6 months from current date\n//             currentDate.setMonth(currentDate.getMonth() - 6);\n            \n//             // Format the date to YYYY-MM-DD as required by ERPNext date fields\n//             let year = currentDate.getFullYear();\n//             let month = String(currentDate.getMonth() + 1).padStart(2, '0');\n//             let day = String(currentDate.getDate()).padStart(2, '0');\n            \n//             let formattedDate = year + '-' + month + '-' + day;\n            \n//             // Set the date_of_birth field\n//             frm.set_value('date_of_birth', formattedDate);\n//         }\n//     }\n// });\n\n//Date of joining auto set with hiddepn property\nfrappe.ui.form.on('Employee', {\n    onload: function(frm) {\n        // Only set the date if it's a new document (not saved yet)\n        if (frm.is_new()) {\n            // Get current date\n            let currentDate = new Date();\n            \n            // Subtract 6 months from current date\n            currentDate.setMonth(currentDate.getMonth() - 6);\n            \n            // Format the date to YYYY-MM-DD as required by ERPNext date fields\n            let year = currentDate.getFullYear();\n            let month = String(currentDate.getMonth() + 1).padStart(2, '0');\n            let day = String(currentDate.getDate()).padStart(2, '0');\n            \n            let formattedDate = year + '-' + month + '-' + day;\n            \n            // Set the date_of_birth field\n            frm.set_value('date_of_birth', formattedDate);\n            \n            // Hide the date_of_birth field\n            frm.set_df_property('date_of_birth', 'hidden', 1);\n        }\n    },\n    \n    refresh: function(frm) {\n        // Also hide the field on refresh for existing documents\n        frm.set_df_property('date_of_birth', 'hidden', 1);\n    }\n});\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Branch",
  "enabled": 1,
  "modified": "2025-04-03 04:05:37.819364",
  "module": "o2o ErpNext",
  "name": "Branch Restrict",
  "script": "frappe.listview_settings['Branch'] = {\n    // Array of roles that should have restricted access\n    restrictedRoles: ['Person Raising Request', 'Requisition Approver', 'PO Approver'],\n    \n    // Check if current user has any of the restricted roles\n    hasRestrictedRole: function() {\n        return this.restrictedRoles.some(role => frappe.user_roles.includes(role));\n    },\n    \n    onload: function(listview) {\n        if (this.hasRestrictedRole()) {\n            // Remove existing filters\n            listview.filter_area.clear();\n            \n            frappe.call({\n                method: 'frappe.client.get_value',\n                args: {\n                    doctype: 'Employee',\n                    filters: { 'user_id': frappe.session.user },\n                    fieldname: ['custom_supplier']\n                },\n                callback: function(r) {\n                    if (r.message && r.message.custom_supplier) {\n                        // Add non-removable filter\n                        listview.filter_area.add([\n                            ['Branch', 'custom_supplier', '=', r.message.custom_supplier]\n                        ]);\n                        \n                        // Store the supplier for reference\n                        listview.custom_supplier = r.message.custom_supplier;\n                        \n                        // Refresh list\n                        listview.refresh();\n                        \n                        // Hide filter area buttons\n                        $('.filter-selector').hide();\n                        $('.filter-button').hide();\n                    } else {\n                        // If no supplier found, show empty list\n                        listview.filter_area.add([\n                            ['Branch', 'name', '=', '']\n                        ]);\n                        listview.refresh();\n                    }\n                }\n            });\n        }\n    },\n\n    refresh: function(listview) {\n        if (this.hasRestrictedRole()) {\n            // Prevent filter removal\n            if (listview.custom_supplier) {\n                let current_filters = listview.filter_area.get();\n                let supplier_filter_exists = current_filters.some(f => \n                    f[1] === 'custom_supplier' && f[3] === listview.custom_supplier\n                );\n                \n                if (!supplier_filter_exists) {\n                    // Re-add the supplier filter if it was removed\n                    listview.filter_area.add([\n                        ['Branch', 'custom_supplier', '=', listview.custom_supplier]\n                    ]);\n                }\n            }\n            \n            // Hide filter area and buttons\n            $('.filter-selector').hide();\n            $('.filter-button').hide();\n            $('.filter-box .filter-area').css('pointer-events', 'none');\n            \n            // Remove filter tags close button\n            setTimeout(() => {\n                $('.filter-tag .remove-filter').hide();\n            }, 100);\n        }\n    },\n\n    before_refresh: function(listview) {\n        if (this.hasRestrictedRole()) {\n            // Prevent clearing filters\n            if (listview.custom_supplier) {\n                let current_filters = listview.filter_area.get();\n                let supplier_filter_exists = current_filters.some(f => \n                    f[1] === 'custom_supplier' && f[3] === listview.custom_supplier\n                );\n                \n                if (!supplier_filter_exists) {\n                    return false; // Prevent refresh if supplier filter was removed\n                }\n            }\n        }\n        return true;\n    },\n\n    before_new: function() {\n        if (this.hasRestrictedRole()) {\n            return new Promise((resolve, reject) => {\n                frappe.call({\n                    method: 'frappe.client.get_value',\n                    args: {\n                        doctype: 'Employee',\n                        filters: { 'user_id': frappe.session.user },\n                        fieldname: ['custom_supplier']\n                    },\n                    callback: function(r) {\n                        if (!r.message || !r.message.custom_supplier) {\n                            frappe.throw(__('You must have a supplier assigned to your employee record to create a branch.'));\n                            reject();\n                        } else {\n                            resolve();\n                        }\n                    }\n                });\n            });\n        }\n        return true;\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sub Branch",
  "enabled": 1,
  "modified": "2025-02-28 21:59:46.432558",
  "module": "o2o ErpNext",
  "name": "Sub Branch Restrict",
  "script": "frappe.listview_settings['Sub Branch'] = {\n    onload: function(listview) {\n        if (frappe.user_roles.includes('Person Raising Request') || \n            frappe.user_roles.includes('PO Approver') || \n            frappe.user_roles.includes('Requisition Approver')) {\n            \n            listview.filter_area.clear();\n\n            frappe.call({\n                method: 'frappe.client.get_value',\n                args: {\n                    doctype: 'Employee',\n                    filters: { 'user_id': frappe.session.user },\n                    fieldname: ['custom_supplier', 'branch', 'custom_sub_branch', 'custom_sub_branch_list']\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        let filters = [];\n                        if (frappe.user_roles.includes('Person Raising Request')){\n                            if (r.message.custom_supplier && r.message.branch && r.message.custom_sub_branch){\n                                filters.push(\n                                    ['Sub Branch', 'custom_supplier', '=', r.message.custom_supplier],\n                                    ['Sub Branch', 'branch', '=', r.message.branch],\n                                    ['Sub Branch', 'name', '=', r.message.custom_sub_branch]\n                                );\n                                listview.custom_supplier = r.message.custom_supplier;\n                                listview.branch = r.message.branch;\n                                listview.custom_sub_branch = r.message.custom_sub_branch;\n\n                            } else {\n                                // If any required fields are missing, show nothing.\n                                filters.push(['Sub Branch', 'name', '=', '']);\n                            }\n                        } else if (frappe.user_roles.includes('PO Approver')) {\n                            if (r.message.custom_supplier && r.message.branch ) {\n                                filters.push(\n                                     ['Sub Branch', 'custom_supplier', '=', r.message.custom_supplier],\n                                     ['Sub Branch', 'branch', '=', r.message.branch]\n                                );\n\n                                // Handle custom_sub_branch_list (Table field)\n                                if (r.message.custom_sub_branch_list && Array.isArray(r.message.custom_sub_branch_list)) {\n                                    const subBranchNames = r.message.custom_sub_branch_list\n                                        .map(item => item.custom_sub_branch)  // Assuming 'name' is the sub-branch name field\n                                        .filter(name => name); // Remove any empty/null values\n\n                                    if (subBranchNames.length > 0) {\n                                        filters.push(['Sub Branch', 'name', 'in', subBranchNames]);\n                                    }\n                                    else{\n                                         //If custom_sub_branch_list is empty\n                                        filters.push(['Sub Branch', 'name', '=', '']);\n                                    }\n                                }\n                                else if(r.message.custom_sub_branch){\n                                      filters.push(['Sub Branch', 'name', '=', r.message.custom_sub_branch]); //use custom_sub_branch\n                                }\n                                else {\n                                    // If custom_sub_branch_list is missing or invalid, show nothing.\n                                    filters.push(['Sub Branch', 'name', '=', '']);\n                                }\n                                listview.custom_supplier = r.message.custom_supplier;\n                                listview.branch = r.message.branch;\n                                listview.custom_sub_branch_list = r.message.custom_sub_branch_list;\n\n                            }\n                            else{\n                                // If any required fields are missing, show nothing.\n                                 filters.push(['Sub Branch', 'name', '=', '']);\n                            }\n                        } else if (frappe.user_roles.includes('Requisition Approver')) {\n                            if (r.message.custom_supplier && r.message.branch) {\n                                filters.push(\n                                    ['Sub Branch', 'custom_supplier', '=', r.message.custom_supplier],\n                                    ['Sub Branch', 'branch', '=', r.message.branch]\n                                );\n                                listview.custom_supplier = r.message.custom_supplier;\n                                listview.branch = r.message.branch;\n                            } else {\n                                // If any required fields are missing, show nothing.\n                                filters.push(['Sub Branch', 'name', '=', '']);\n                            }\n                        }\n\n                        listview.filter_area.add(filters);\n                        listview.refresh();\n                        _hideFilterControls(listview);\n\n                        let message = '';\n                        if (frappe.user_roles.includes('PO Approver')) {\n                            message = __('The Sub Branch list is filtered based on your assigned supplier, branch, and sub-branch list.');\n                        } else if (frappe.user_roles.includes('Requisition Approver')) {\n                            message = __('The Sub Branch list is filtered based on your assigned supplier and branch.');\n                        } else {\n                            message = __('The Sub Branch list is filtered based on your assigned supplier, branch, and sub-branch.');\n                        }\n                        \n                        frappe.show_alert({\n                            message: message,\n                            indicator: 'info'\n                        });\n                    }\n                }\n            });\n        }\n    },\n\n    refresh: function(listview) {\n        if (frappe.user_roles.includes('Person Raising Request') || \n            frappe.user_roles.includes('PO Approver') || \n            frappe.user_roles.includes('Requisition Approver')) {\n            \n            //For Person Raising Request\n            if (listview.custom_supplier && listview.branch && listview.custom_sub_branch && frappe.user_roles.includes('Person Raising Request')) {\n                let current_filters = listview.filter_area.get();\n                let filters_present = current_filters.some(f =>\n                    f[1] === 'custom_supplier' && f[3] === listview.custom_supplier &&\n                    f[1] === 'branch' && f[3] === listview.branch &&\n                    f[0] === 'Sub Branch' && f[1] === 'name' && f[3] === listview.custom_sub_branch\n                );\n\n                if (!filters_present) {\n                    listview.filter_area.add([\n                        ['Sub Branch', 'custom_supplier', '=', listview.custom_supplier],\n                        ['Sub Branch', 'branch', '=', listview.branch],\n                        ['Sub Branch', 'name', '=', listview.custom_sub_branch]\n                    ]);\n                }\n            }\n            //For PO Approver\n            else if(listview.custom_supplier && listview.branch && frappe.user_roles.includes('PO Approver')){\n                let current_filters = listview.filter_area.get();\n                let subBranchNames = [];\n                if(listview.custom_sub_branch_list){\n                    subBranchNames = listview.custom_sub_branch_list.map(f=> f.custom_sub_branch);\n                }\n\n                let filters_present = current_filters.every(f => {\n                    if (f[1] === 'custom_supplier') {\n                        return f[3] === listview.custom_supplier;\n                    } else if (f[1] === 'branch') {\n                        return f[3] === listview.branch;\n                    } else if (f[0] === 'Sub Branch' && f[1] === 'name') {\n                        return subBranchNames.includes(f[3]) || f[3] === listview.custom_sub_branch; //for custom_sub_branch\n                    }\n                    return true; // For other filters, don't interfere\n                });\n\n                if (!filters_present) {\n                    let filters = [\n                        ['Sub Branch', 'custom_supplier', '=', listview.custom_supplier],\n                        ['Sub Branch', 'branch', '=', listview.branch],\n                    ];\n                    if (subBranchNames.length > 0){\n                        filters.push(['Sub Branch', 'name', 'in', subBranchNames])\n                    }\n                    else if(listview.custom_sub_branch){\n                        filters.push(['Sub Branch', 'name', '=', listview.custom_sub_branch]); //use custom_sub_branch\n                    }\n\n                    listview.filter_area.add(filters);\n                }\n            }\n            //For Requisition Approver\n            else if(listview.custom_supplier && listview.branch && frappe.user_roles.includes('Requisition Approver')){\n                let current_filters = listview.filter_area.get();\n                let filters_present = current_filters.some(f =>\n                    f[1] === 'custom_supplier' && f[3] === listview.custom_supplier &&\n                    f[1] === 'branch' && f[3] === listview.branch\n                );\n\n                if (!filters_present) {\n                    listview.filter_area.add([\n                        ['Sub Branch', 'custom_supplier', '=', listview.custom_supplier],\n                        ['Sub Branch', 'branch', '=', listview.branch]\n                    ]);\n                }\n            }\n            _hideFilterControls(listview);\n        }\n    },\n\n    before_refresh: function(listview) {\n        if (frappe.user_roles.includes('Person Raising Request') || \n            frappe.user_roles.includes('PO Approver') || \n            frappe.user_roles.includes('Requisition Approver')) {\n            \n            if (listview.custom_supplier && listview.branch && listview.custom_sub_branch && frappe.user_roles.includes('Person Raising Request')) {\n                let current_filters = listview.filter_area.get();\n                let filters_present = current_filters.some(f =>\n                    f[1] === 'custom_supplier' && f[3] === listview.custom_supplier &&\n                    f[1] === 'branch' && f[3] === listview.branch &&\n                    f[0] === 'Sub Branch' && f[1] === 'name' && f[3] === listview.custom_sub_branch\n                );\n\n                if (!filters_present) {\n                    listview.filter_area.add([\n                        ['Sub Branch', 'custom_supplier', '=', listview.custom_supplier],\n                        ['Sub Branch', 'branch', '=', listview.branch],\n                        ['Sub Branch', 'name', '=', listview.custom_sub_branch]\n                    ]);\n                }\n            }\n            //For PO Approver\n            else if(listview.custom_supplier && listview.branch && frappe.user_roles.includes('PO Approver')){\n                let current_filters = listview.filter_area.get();\n                let subBranchNames = [];\n                if(listview.custom_sub_branch_list){\n                    subBranchNames = listview.custom_sub_branch_list.map(f=> f.custom_sub_branch);\n                }\n                let filters_present = current_filters.every(f => {\n                    if (f[1] === 'custom_supplier') {\n                        return f[3] === listview.custom_supplier;\n                    } else if (f[1] === 'branch') {\n                        return f[3] === listview.branch;\n                    } else if (f[0] === 'Sub Branch' && f[1] === 'name') {\n                        return subBranchNames.includes(f[3]) || f[3] === listview.custom_sub_branch;  //for custom_sub_branch\n                    }\n                    return true; // For other filters, don't interfere\n                });\n\n                if (!filters_present) {\n                    let filters = [\n                        ['Sub Branch', 'custom_supplier', '=', listview.custom_supplier],\n                        ['Sub Branch', 'branch', '=', listview.branch],\n                    ];\n                    if (subBranchNames.length > 0){\n                        filters.push(['Sub Branch', 'name', 'in', subBranchNames])\n                    }\n                    else if(listview.custom_sub_branch){\n                        filters.push(['Sub Branch', 'name', '=', listview.custom_sub_branch]);//use custom_sub_branch\n                    }\n                    listview.filter_area.add(filters);\n                }\n            }\n            //For Requisition Approver\n            else if(listview.custom_supplier && listview.branch && frappe.user_roles.includes('Requisition Approver')){\n                let current_filters = listview.filter_area.get();\n                let filters_present = current_filters.some(f =>\n                    f[1] === 'custom_supplier' && f[3] === listview.custom_supplier &&\n                    f[1] === 'branch' && f[3] === listview.branch\n                );\n\n                if (!filters_present) {\n                    listview.filter_area.add([\n                        ['Sub Branch', 'custom_supplier', '=', listview.custom_supplier],\n                        ['Sub Branch', 'branch', '=', listview.branch]\n                    ]);\n                }\n            }\n        }\n        return true;\n    },\n\n    before_new: function() {\n        if (frappe.user_roles.includes('Person Raising Request') || \n            frappe.user_roles.includes('PO Approver') || \n            frappe.user_roles.includes('Requisition Approver')) {\n            \n            return new Promise((resolve, reject) => {\n                frappe.call({\n                    method: 'frappe.client.get_value',\n                    args: {\n                        doctype: 'Employee',\n                        filters: { 'user_id': frappe.session.user },\n                        fieldname: ['custom_supplier', 'branch', 'custom_sub_branch', 'custom_sub_branch_list']\n                    },\n                    callback: function(r) {\n                        if (frappe.user_roles.includes('Person Raising Request')){\n                            if (!r.message || !r.message.custom_supplier || !r.message.branch || !r.message.custom_sub_branch) {\n                                frappe.throw(__('You must have a supplier, branch and sub branch assigned to your employee record to create a Sub Branch.'));\n                                reject();\n                            } else {\n                                resolve();\n                            }\n                        } else if(frappe.user_roles.includes('PO Approver')){\n                            if (!r.message || !r.message.custom_supplier || !r.message.branch ) {\n                                frappe.throw(__('You must have a supplier and branch assigned to your employee record to create a Sub Branch.'));\n                                reject();\n                            } else {\n                                resolve();\n                            }\n                        } else if(frappe.user_roles.includes('Requisition Approver')){\n                            if (!r.message || !r.message.custom_supplier || !r.message.branch ) {\n                                frappe.throw(__('You must have a supplier and branch assigned to your employee record to create a Sub Branch.'));\n                                reject();\n                            } else {\n                                resolve();\n                            }\n                        }\n                    }\n                });\n            });\n        }\n        return true;\n    }\n};\n\n// Helper function to hide filter controls (reused from the Branch script)\nfunction _hideFilterControls(listview) {\n    $('.filter-selector').hide();\n    $('.filter-button').hide();\n    $('.filter-box .filter-area').css('pointer-events', 'none');\n\n    setTimeout(() => {\n        $('.filter-tag .remove-filter').hide();\n    }, 100);\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier",
  "enabled": 1,
  "modified": "2025-04-03 04:02:30.402302",
  "module": "o2o ErpNext",
  "name": "Supplier restrict",
  "script": "frappe.listview_settings['Supplier'] = {\n    // Track the state to prevent duplicate operations\n    supplier_value: null,\n    filter_initialized: false,\n    \n    onload: function(listview) {\n        // Save reference\n        this.listview = listview;\n        \n        // IMPORTANT: Check if user is Administrator or doesn't have restricted role - exit early\n        if (this.isAdministrator() || !this.hasRestrictedRole()) {\n            // User is Administrator or doesn't have restricted role, do nothing and allow normal operation\n            console.log(\"User is Administrator or doesn't have restricted role, skipping supplier filter\");\n            return;\n        }\n        \n        // Only initialize once for restricted users\n        if (!this.filter_initialized) {\n            console.log(\"Initializing supplier filter for restricted user\");\n            this.initializeFilter();\n        }\n    },\n    \n    isAdministrator: function() {\n        // Check if current user is Administrator\n        return frappe.user_roles.includes('Administrator');\n    },\n    \n    hasRestrictedRole: function() {\n        var restricted_roles = ['Person Raising Request', 'Requisition Approver', 'PO Approver'];\n        for (var i = 0; i < restricted_roles.length; i++) {\n            if (frappe.user_roles.includes(restricted_roles[i])) {\n                return true;\n            }\n        }\n        // If we reach here, user doesn't have any restricted roles\n        return false;\n    },\n    \n    initializeFilter: function() {\n        // Prevent multiple initializations\n        this.filter_initialized = true;\n        \n        var me = this;\n        \n        // Use a one-time non-async call to get the supplier\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Employee',\n                filters: { 'user_id': frappe.session.user },\n                fieldname: ['custom_supplier']\n            },\n            async: false, // Make it synchronous\n            callback: function(r) {\n                if (r.message && r.message.custom_supplier) {\n                    me.supplier_value = r.message.custom_supplier;\n                    console.log(\"Detected supplier value:\", me.supplier_value);\n                    \n                    // Apply filter one time only\n                    me.applyFilter();\n                    \n                    // Apply UI restrictions one time\n                    me.applyUIRestrictions();\n                    \n                    // Show notification\n                    frappe.show_alert({\n                        message: __(`You are viewing your assigned supplier: ${me.supplier_value}`),\n                        indicator: 'blue'\n                    }, 5);\n                } else {\n                    // No supplier assigned\n                    frappe.show_alert({\n                        message: __('No supplier is assigned to your employee record.'),\n                        indicator: 'red'\n                    }, 5);\n                    \n                    // Apply empty filter\n                    me.listview.filter_area.clear();\n                    me.listview.filter_area.add([\n                        ['Supplier', 'name', '=', '_nonexistent_']\n                    ]);\n                    \n                    // Apply UI restrictions\n                    me.applyUIRestrictions();\n                }\n            }\n        });\n    },\n    \n    applyFilter: function() {\n        // Only proceed if we have a supplier and listview\n        if (!this.supplier_value || !this.listview) return;\n        \n        console.log(\"Applying supplier filter:\", this.supplier_value);\n        \n        // Clear any existing filters\n        this.listview.filter_area.clear();\n        \n        // Add our filter\n        this.listview.filter_area.add([\n            ['Supplier', 'name', '=', this.supplier_value]\n        ]);\n        \n        // Override the get method to ensure our filter always stays applied\n        var originalGet = this.listview.filter_area.get;\n        var supplier = this.supplier_value;\n        \n        this.listview.filter_area.get = function() {\n            var filters = originalGet.apply(this, arguments);\n            \n            // Check if our filter exists\n            var hasSupplierFilter = filters.some(function(f) {\n                return (Array.isArray(f) && f[1] === 'name' && f[3] === supplier) ||\n                       (f.fieldname === 'name' && f.value === supplier);\n            });\n            \n            // If not, add it back to the filters array without triggering a refresh\n            if (!hasSupplierFilter) {\n                filters.push(['Supplier', 'name', '=', supplier]);\n            }\n            \n            return filters;\n        };\n        \n        // Override the clear method to prevent complete clearing\n        var originalClear = this.listview.filter_area.clear;\n        \n        this.listview.filter_area.clear = function() {\n            // Call original clear\n            originalClear.apply(this, arguments);\n            \n            // Immediately re-add our filter without triggering refresh\n            this.filters.push({\n                fieldname: 'name',\n                label: 'Name',\n                condition: '=',\n                value: supplier\n            });\n        };\n    },\n    \n    applyUIRestrictions: function() {\n        var style = document.createElement('style');\n        style.id = 'supplier-restriction-style';\n        style.innerHTML = `\n            .filter-selector, .filter-button, .tag-filters-area, .clear-filters { \n                display: none !important; \n            }\n            .filter-box .filter-area { \n                pointer-events: none !important; \n            }\n            .filter-tag .remove-filter {\n                display: none !important;\n            }\n            .list-row-check, .list-select-all {\n                display: none !important;\n            }\n        `;\n        \n        // Only add the style if it doesn't exist\n        if (!document.getElementById('supplier-restriction-style')) {\n            document.head.appendChild(style);\n        }\n        \n        // Hide the new supplier button\n        setTimeout(function() {\n            $('.page-actions .btn-primary').hide();\n        }, 100);\n    },\n    \n    refresh: function(listview) {\n        // Exit immediately if user is Administrator or doesn't have restricted role\n        if (this.isAdministrator() || !this.hasRestrictedRole()) {\n            return;\n        }\n        \n        // Update listview reference\n        this.listview = listview;\n        \n        // Initialize if not already done\n        if (!this.filter_initialized) {\n            this.initializeFilter();\n        }\n        \n        // Re-apply UI restrictions on every refresh\n        this.applyUIRestrictions();\n        \n        // Add a guard to prevent loops\n        if (this.is_refreshing) return;\n        this.is_refreshing = true;\n        \n        // Check and ensure our filter is still applied\n        try {\n            if (this.supplier_value) {\n                var current_filters = listview.filter_area.get();\n                \n                // Check if our filter exists\n                var hasFilter = current_filters.some(function(f) {\n                    return (Array.isArray(f) && f[1] === 'name' && f[3] === this.supplier_value) ||\n                           (f.fieldname === 'name' && f.value === this.supplier_value);\n                }, this);\n                \n                // Only re-apply if missing and not already refreshing\n                if (!hasFilter && !this.is_reapplying) {\n                    this.is_reapplying = true;\n                    \n                    // Re-apply filter silently without triggering another refresh\n                    setTimeout(function() {\n                        listview.filter_area.filters.push({\n                            fieldname: 'name',\n                            label: 'Name',\n                            condition: '=',\n                            value: this.supplier_value\n                        });\n                        \n                        this.is_reapplying = false;\n                    }.bind(this), 0);\n                }\n            }\n        } catch (e) {\n            console.error(\"Error in refresh handler:\", e);\n        }\n        \n        // Release the guard\n        setTimeout(function() {\n            this.is_refreshing = false;\n        }.bind(this), 500);\n    },\n    \n    before_new: function() {\n        // Allow Administrator to create suppliers regardless of other roles\n        if (this.isAdministrator()) {\n            return true;\n        }\n        \n        // Only prevent new supplier creation for restricted roles\n        if (this.hasRestrictedRole()) {\n            frappe.throw(__('You do not have permission to create new suppliers.'));\n            return false;\n        }\n        \n        // Allow normal creation for non-restricted roles\n        return true;\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2025-04-04 14:23:50.817646",
  "module": "o2o ErpNext",
  "name": "Purchase Receipt merge v5",
  "script": "frappe.listview_settings['Purchase Receipt'] = {\n    onload: function(listview) {\n        listview.page.add_action_item(__('Create Purchase Invoice'), function() {\n            try {\n                const selected_docs = listview.get_checked_items();\n\n                if (selected_docs.length === 0) {\n                    frappe.msgprint({\n                        title: __('Warning'),\n                        indicator: 'red',\n                        message: __('Please select at least one Purchase Receipt')\n                    });\n                    return;\n                }\n\n                // Add validation for submitted documents only\n                const hasNonSubmittedDocs = selected_docs.some(doc => doc.docstatus !== 1);\n                if (hasNonSubmittedDocs) {\n                    frappe.msgprint({\n                        title: __('Warning'),\n                        indicator: 'red',\n                        message: __('Please select only submitted Purchase Receipts. Draft or cancelled Purchase Receipts cannot be merged.')\n                    });\n                    return;\n                }\n\n                // Check for linked Purchase Invoices first - ADDED CODE\n                let receiptsChecked = 0;\n                let receiptsWithInvoices = [];\n\n                selected_docs.forEach(doc => {\n                    frappe.call({\n                        method: \"o2o_erpnext.api.purchase_receipt.check_linked_purchase_invoices\",\n                        args: {\n                            \"purchase_receipt\": doc.name\n                        },\n                        callback: function(r) {\n                            receiptsChecked++;\n                            \n                            if (r.message && r.message.success && r.message.has_active_invoices) {\n                                receiptsWithInvoices.push({\n                                    receipt: doc.name,\n                                    invoices: r.message.invoices || []\n                                });\n                            }\n                            \n                            // Once all checks are complete\n                            if (receiptsChecked === selected_docs.length) {\n                                if (receiptsWithInvoices.length > 0) {\n                                    // Format error message\n                                    let message = __('Cannot create Purchase Invoice. The following Purchase Receipts already have active linked invoices:') + '<br><br>';\n                                    \n                                    receiptsWithInvoices.forEach(r => {\n                                        message += `<strong>${r.receipt}</strong>: ` + \n                                            r.invoices.map(inv => `${inv.name} (${inv.status})`).join(', ') + '<br>';\n                                    });\n                                    \n                                    frappe.msgprint({\n                                        title: __('Cannot Create Purchase Invoice'),\n                                        indicator: 'red',\n                                        message: message\n                                    });\n                                    return;\n                                } else {\n                                    // No linked invoices found, proceed with original flow\n                                    proceedWithPurchaseInvoiceCreation();\n                                }\n                            }\n                        }\n                    });\n                });\n\n                // Original flow wrapped in a function - ADDED CODE\n                function proceedWithPurchaseInvoiceCreation() {\n                    // Get fiscal year first\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Fiscal Year',\n                            filters: {\n                                'year_start_date': ['<=', frappe.datetime.get_today()],\n                                'year_end_date': ['>=', frappe.datetime.get_today()]\n                            },\n                            fields: ['name']\n                        },\n                        callback: function(fiscal_response) {\n                            try {\n                                let display_fiscal_year = '';\n                                if (fiscal_response.message && fiscal_response.message.length > 0) {\n                                    let fiscal_year = fiscal_response.message[0].name;\n                                    let start_year = fiscal_year.split('-')[0];\n                                    let end_year = fiscal_year.split('-')[1];\n                                    display_fiscal_year = start_year.substring(2) + '-' + end_year.substring(2);\n                                }\n\n                                frappe.call({\n                                    method: 'frappe.client.get',\n                                    args: { \n                                        doctype: 'Purchase Receipt', \n                                        name: selected_docs[0].name \n                                    },\n                                    callback: function(firstDocResponse) {\n                                        try {\n                                            if (!firstDocResponse.message) {\n                                                throw new Error('Failed to fetch first Purchase Receipt');\n                                            }\n\n                                            const firstDoc = firstDocResponse.message;\n                                            const firstVendor = firstDoc.custom_vendor;\n                                            const firstSupplier = firstDoc.supplier;\n                                            const firstBranch = firstDoc.custom_branch;\n                                            const firstSubBranch = firstDoc.custom_sub_branch; // Fetch sub-branch\n                                            const firstTaxCategory = firstDoc.tax_category;\n                                            const firstTaxesAndCharges = firstDoc.taxes_and_charges;\n                                            const isReturn = firstDoc.is_return || 0;\n                                            const vendor_code = firstVendor ? firstVendor.substring(0, 5).toUpperCase() : '';\n\n                                            const supplier_address = firstDoc.supplier_address;\n                                            const shipping_address = firstDoc.shipping_address;\n                                            const billing_address = firstDoc.billing_address;\n                                            const vendor_address = firstDoc.custom_vendor_address;\n\n                                            const naming_series = isReturn ? \n                                                `DN./.${display_fiscal_year}./.###` : \n                                                `${vendor_code}./.${display_fiscal_year}./.###`;\n\n                                            if (!firstTaxCategory || !firstTaxesAndCharges) {\n                                                frappe.msgprint({\n                                                    title: __('Error'),\n                                                    indicator: 'red',\n                                                    message: __('Tax Category and Taxes and Charges must be set for the first selected receipt.')\n                                                });\n                                                return;\n                                            }\n\n                                            if (!firstBranch) {\n                                                frappe.msgprint({\n                                                    title: __('Error'),\n                                                    indicator: 'red',\n                                                    message: __('Branch is not set for the first selected receipt.')\n                                                });\n                                                return;\n                                            }\n\n                                            // Fetch all receipts first to validate supplier, branch, and sub-branch\n                                            const receiptPromises = selected_docs.map(doc => \n                                                new Promise((resolve, reject) => {\n                                                    frappe.call({\n                                                        method: 'frappe.client.get',\n                                                        args: { \n                                                            doctype: 'Purchase Receipt', \n                                                            name: doc.name \n                                                        },\n                                                        callback: function(r) {\n                                                            if (r.message) {\n                                                                resolve(r.message);\n                                                            } else {\n                                                                reject('Failed to fetch receipt');\n                                                            }\n                                                        }\n                                                    });\n                                                })\n                                            );\n\n                                            Promise.all(receiptPromises)\n                                                .then(receipts => {\n                                                    // Validate that all receipts have the same supplier, branch, and sub-branch\n                                                    const mismatchedSupplier = receipts.some(receipt => receipt.supplier !== firstSupplier);\n                                                    const mismatchedBranch = receipts.some(receipt => receipt.custom_branch !== firstBranch);\n                                                    const mismatchedSubBranch = receipts.some(receipt => receipt.custom_sub_branch !== firstSubBranch);\n\n                                                    if (mismatchedSupplier) {\n                                                        frappe.msgprint({\n                                                            title: __('Error'),\n                                                            indicator: 'red',\n                                                            message: __('Receipts cannot be merged because suppliers are different.')\n                                                        });\n                                                        return;\n                                                    }\n\n                                                    if (mismatchedBranch) {\n                                                        frappe.msgprint({\n                                                            title: __('Error'),\n                                                            indicator: 'red',\n                                                            message: __('Receipts cannot be merged because branches are different.')\n                                                        });\n                                                        return;\n                                                    }\n\n                                                    if (mismatchedSubBranch) {\n                                                        frappe.msgprint({\n                                                            title: __('Error'),\n                                                            indicator: 'red',\n                                                            message: __('Receipts cannot be merged because sub-branches are different.')\n                                                        });\n                                                        return;\n                                                    }\n\n                                                    frappe.call({\n                                                        method: 'frappe.client.get',\n                                                        args: {\n                                                            doctype: 'Purchase Taxes and Charges Template',\n                                                            name: firstTaxesAndCharges\n                                                        },\n                                                        callback: function(tax_template_response) {\n                                                            try {\n                                                                if (!tax_template_response.message) {\n                                                                    throw new Error('Failed to fetch tax template');\n                                                                }\n\n                                                                const tax_template = tax_template_response.message;\n                                                                let consolidatedItems = [];\n                                                                let totalGrandTotal = 0;\n                                                                let totalFreightAmount = 0;\n                                                                let freightCostEntries = [];\n\n                                                                // Process receipts data for consolidated items\n                                                                receipts.forEach(receipt => {\n                                                                    totalGrandTotal += flt(receipt.custom_grand_total || 0);\n                                                                    totalFreightAmount += flt(receipt.custom_freight_amount || 0);\n\n                                                                    freightCostEntries.push({\n                                                                        purchase_receipt: receipt.name,\n                                                                        hsnsac: receipt.custom_freight_hsnsac || \"\",\n                                                                        quantity: flt(receipt.custom_weight_in_kg || 0),\n                                                                        gst_rate: flt(receipt.custom_freight_tax_rate_ || 0),\n                                                                        rate: flt(receipt.custom_rate_per_kg || 0),\n                                                                        total_rate: flt(receipt.custom_freight_amount || 0),\n                                                                        cgst: flt(receipt.custom_cgst_amount || 0),\n                                                                        sgst: flt(receipt.custom_sgst_amount || 0),\n                                                                        igst: flt(receipt.custom_igst_amount || 0),\n                                                                        amount: flt(receipt.custom_total_freight_amount || 0)\n                                                                    });\n\n                                                                    receipt.items.forEach(item => {\n                                                                        const existingItem = consolidatedItems.find(\n                                                                            ci => ci.item_name.toLowerCase() === item.item_name.toLowerCase() && \n                                                                                ci.custom_gstn_value === item.custom_gstn_value\n                                                                        );\n\n                                                                        if (existingItem) {\n                                                                            if (existingItem.uom !== item.uom) {\n                                                                                frappe.throw(__(`UOM mismatch for item ${item.item_code}. Cannot consolidate items with different UOMs.`));\n                                                                            }\n\n                                                                            const newQty = flt(existingItem.qty) + flt(item.qty);\n                                                                            const newAmount = flt(existingItem.amount) + flt(item.amount);\n                                                                            \n                                                                            existingItem.qty = newQty;\n                                                                            existingItem.amount = newAmount;\n                                                                            existingItem.rate = flt(newAmount / newQty);\n                                                                            existingItem.custom_grand_total = flt(existingItem.custom_grand_total || 0) + flt(item.custom_grand_total || 0);\n                                                                            \n                                                                            if (!existingItem.pr_details) existingItem.pr_details = [];\n                                                                            existingItem.pr_details.push({\n                                                                                pr_detail: item.name,\n                                                                                purchase_receipt: receipt.name,\n                                                                                amount: flt(item.amount),\n                                                                                purchase_order: item.purchase_order,\n                                                                                purchase_order_item: item.purchase_order_item\n                                                                            });\n                                                                        } else {\n                                                                            consolidatedItems.push({\n                                                                                item_code: item.item_code,\n                                                                                item_name: item.item_name,\n                                                                                qty: flt(item.qty),\n                                                                                rate: flt(item.rate),\n                                                                                amount: flt(item.amount),\n                                                                                warehouse: item.warehouse,\n                                                                                custom_grand_total: flt(item.custom_grand_total || 0),\n                                                                                custom_gstn_value: item.custom_gstn_value,\n                                                                                uom: item.uom,\n                                                                                stock_uom: item.stock_uom,\n                                                                                conversion_factor: item.conversion_factor,\n                                                                                purchase_receipt: receipt.name,\n                                                                                pr_detail: item.name,\n                                                                                purchase_order: item.purchase_order,\n                                                                                purchase_order_item: item.purchase_order_item,\n                                                                                pr_details: [{\n                                                                                    pr_detail: item.name,\n                                                                                    purchase_receipt: receipt.name,\n                                                                                    amount: flt(item.amount),\n                                                                                    purchase_order: item.purchase_order,\n                                                                                    purchase_order_item: item.purchase_order_item\n                                                                                }]\n                                                                            });\n                                                                        }\n                                                                    });\n                                                                });\n\n                                                                let taxes = [];\n                                                                if (tax_template.taxes) {\n                                                                    taxes = tax_template.taxes.map((tax, idx) => {\n                                                                        let row_id = null;\n                                                                        if (tax.charge_type === 'On Previous Row Amount' || tax.charge_type === 'On Previous Row Total') {\n                                                                            if (tax.row_id && parseInt(tax.row_id) < (idx + 1)) {\n                                                                                row_id = tax.row_id;\n                                                                            } else {\n                                                                                frappe.throw(__(`Invalid row reference in tax row ${idx + 1}`));\n                                                                            }\n                                                                        }\n\n                                                                        return {\n                                                                            account_head: tax.account_head,\n                                                                            charge_type: tax.charge_type,\n                                                                            row_id: row_id,\n                                                                            description: tax.description,\n                                                                            included_in_print_rate: tax.included_in_print_rate || 0,\n                                                                            included_in_paid_amount: tax.included_in_paid_amount || 0,\n                                                                            rate: tax.rate,\n                                                                            account_currency: tax.account_currency,\n                                                                            cost_center: tax.cost_center\n                                                                        };\n                                                                    });\n                                                                }\n\n                                                                const doc = {\n                                                                    doctype: 'Purchase Invoice',\n                                                                    naming_series: naming_series,\n                                                                    custom_fiscal_year: display_fiscal_year,\n                                                                    custom_vendor_code: vendor_code,\n                                                                    supplier: firstSupplier,\n                                                                    custom_vendor: firstVendor,\n                                                                    custom_branch: firstBranch,\n                                                                    custom_sub_branch: firstSubBranch, // Add sub-branch to Purchase Invoice\n                                                                    tax_category: firstTaxCategory,\n                                                                    taxes_and_charges: firstTaxesAndCharges,\n                                                                    taxes: taxes,\n                                                                    items: consolidatedItems,\n                                                                    custom_grand_total: totalGrandTotal,\n                                                                    custom_freight_amount: totalFreightAmount,\n                                                                    update_stock: 0,\n                                                                    is_return: isReturn,\n                                                                    supplier_address: supplier_address,\n                                                                    shipping_address: shipping_address,\n                                                                    billing_address: billing_address,\n                                                                    custom_vendor_address: vendor_address,\n                                                                    custom_freight_cost_data: freightCostEntries\n                                                                };\n\n                                                                console.log('Creating Purchase Invoice with:', doc);\n\n                                                                frappe.call({\n                                                                    method: 'frappe.client.insert',\n                                                                    args: { doc: doc },\n                                                                    callback: function(response) {\n                                                                        if (response.message) {\n                                                                            frappe.msgprint({\n                                                                                title: __('Success'),\n                                                                                indicator: 'green',\n                                                                                message: __('Purchase Invoice created successfully: ') + response.message.name\n                                                                            });\n\n                                                                            // Refresh listview to show updated status\n                                                                            listview.refresh();\n                                                                        } else {\n                                                                            frappe.msgprint({\n                                                                                title: __('Error'),\n                                                                                indicator: 'red',\n                                                                                message: __('Failed to create Purchase Invoice')\n                                                                            });\n                                                                        }\n                                                                    }\n                                                                });\n                                                            } catch (error) {\n                                                                console.error('Error in tax template processing:', error);\n                                                                frappe.msgprint({\n                                                                    title: __('Error'),\n                                                                    indicator: 'red',\n                                                                    message: __('Error in tax template processing: ') + error.message\n                                                                });\n                                                            }\n                                                        }\n                                                    });\n                                                })\n                                                .catch(error => {\n                                                    console.error('Error processing receipts:', error);\n                                                    frappe.msgprint({\n                                                        title: __('Error'),\n                                                        indicator: 'red',\n                                                        message: __('Error processing receipts: ') + error\n                                                    });\n                                                });\n                                        } catch (error) {\n                                            console.error('Error processing first document:', error);\n                                            frappe.msgprint({\n                                                title: __('Error'),\n                                                indicator: 'red',\n                                                message: __('Error processing first document: ') + error.message\n                                            });\n                                        }\n                                    }\n                                });\n                            } catch (error) {\n                                console.error('Error in fiscal year processing:', error);\n                                frappe.msgprint({\n                                    title: __('Error'),\n                                    indicator: 'red',\n                                    message: __('Error in fiscal year processing: ') + error.message\n                                });\n                            }\n                        }\n                    });\n                }\n            } catch (error) {\n                console.error('Error in main function:', error);\n                frappe.msgprint({\n                    title: __('Error'),\n                    indicator: 'red',\n                    message: __('Error in main function: ') + error.message\n                });\n            }\n        });\n    },\n\n    onrender: function(listview) {\n        listview.page.wrapper.find('.list-row-checkbox').removeClass('hide');\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2025-04-03 14:36:08.635583",
  "module": "o2o ErpNext",
  "name": "Freight Tax Calculate",
  "script": "frappe.ui.form.on('Purchase Receipt', {\n    before_save: function(frm) {\n        // Call the custom freight tax calculation function\n        calculate_freight_tax_distribution(frm);\n    },\n    \n    // Additional handler to recalculate when tax category changes\n    tax_category: function(frm) {\n        calculate_freight_tax_distribution(frm);\n    },\n\n    // Add handlers for post-submission changes\n    custom_freight_amount: function(frm) {\n        if (frm.doc.docstatus === 1) { // 1 = Submitted status\n            calculate_freight_tax_distribution(frm);\n            // Save the document after calculation\n            frm.save('Update');\n        }\n    },\n    \n    custom_total_freight_amount: function(frm) {\n        if (frm.doc.docstatus === 1) { // 1 = Submitted status\n            calculate_freight_tax_distribution(frm);\n            // Save the document after calculation\n            frm.save('Update');\n        }\n    },\n\n    // Run calculations on form load for submitted documents\n    refresh: function(frm) {\n        if (frm.doc.docstatus === 1) {\n            // Make fields editable after submission\n            frm.set_df_property('custom_freight_amount', 'read_only', 0);\n            frm.set_df_property('custom_total_freight_amount', 'read_only', 0);\n        }\n    }\n});\n\n// Function to calculate freight tax and distribute it according to tax category\nfunction calculate_freight_tax_distribution(frm) {\n    // Get freight amount and total freight amount\n    let freight_amount = frm.doc.custom_freight_amount;\n    let total_freight_amount = frm.doc.custom_total_freight_amount;\n    let tax_category = frm.doc.tax_category;\n    \n    // Default to 0 if empty or null\n    if(freight_amount === \"\" || freight_amount === null || isNaN(freight_amount)) {\n        freight_amount = 0;\n    }\n    \n    if(total_freight_amount === \"\" || total_freight_amount === null || isNaN(total_freight_amount)) {\n        total_freight_amount = 0;\n    }\n    \n    // Calculate freight tax by subtracting freight amount from total freight amount\n    let freight_tax = total_freight_amount - freight_amount;\n    \n    // Reset tax distribution fields\n    frm.set_value('custom_cgst_amount', 0);\n    frm.set_value('custom_sgst_amount', 0);\n    frm.set_value('custom_igst_amount', 0);\n    \n    // Distribute tax based on tax_category\n    if (tax_category === \"In-State\") {\n        // Split the tax into CGST and SGST (half each)\n        let half_tax = freight_tax / 2;\n        frm.set_value('custom_cgst_amount', half_tax);\n        frm.set_value('custom_sgst_amount', half_tax);\n    } else if (tax_category === \"Out-State\") {\n        // Put the entire tax amount into IGST\n        frm.set_value('custom_igst_amount', freight_tax);\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-03-18 07:59:01.408944",
  "module": "o2o ErpNext",
  "name": "PI Tax calculate",
  "script": "frappe.ui.form.on('Purchase Invoice', {\n    after_save: function(frm) {\n        // Call the server-side function after save\n        frappe.call({\n            method: \"o2o_erpnext.api.purchase_invoice.calculate_gst_values_for_purchase_invoice\",\n            args: {\n                \"doc_name\": frm.doc.name\n            },\n            callback: function(r) {\n                if (r.message && r.message.status === \"success\") {\n                    // Refresh the form to show the updated values\n                    frm.reload_doc();\n                    \n                    // Show a success message\n                    frappe.show_alert({\n                        message: __(\"GST values calculated successfully\"),\n                        indicator: 'green'\n                    }, 5);\n                } else if (r.message && r.message.status === \"error\") {\n                    frappe.msgprint({\n                        title: __(\"Error\"),\n                        indicator: 'red',\n                        message: r.message.message\n                    });\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier",
  "enabled": 1,
  "modified": "2025-03-06 03:04:32.106286",
  "module": "o2o ErpNext",
  "name": "Budget Auto Update",
  "script": "// Custom Script for Supplier List\nfrappe.listview_settings['Supplier'] = frappe.listview_settings['Supplier'] || {};\n\n// Extend the existing list view settings\nObject.assign(frappe.listview_settings['Supplier'], {\n    onload: function(listview) {\n        // Only show to administrators and system managers\n        if (frappe.user.has_role('System Manager') || frappe.user.has_role('Administrator')) {\n            // Add button to the list view\n            listview.page.add_inner_button(__('Setup Monthly Budget Updates'), function() {\n                frappe.confirm(\n                    'This will set up automatic budget updates for both Branch and Sub Branch doctypes to run on the 1st of every month at midnight (00:00 hrs). Continue?',\n                    function() {\n                        frappe.call({\n                            method: \"o2o_erpnext.branch_update.setup_all_budget_updates\",\n                            freeze: true,\n                            freeze_message: \"Setting up scheduled jobs...\",\n                            callback: function(r) {\n                                frappe.msgprint({\n                                    title: \"Success\",\n                                    indicator: \"green\",\n                                    message: \"Scheduled jobs have been set up. Branch and Sub Branch budgets will be automatically updated on the 1st of every month at 00:00 hours.\"\n                                });\n                            }\n                        });\n                    }\n                );\n            });\n        }\n    }\n});",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-03-12 11:30:39.894864",
  "module": "o2o ErpNext",
  "name": "filter for PI",
  "script": "frappe.ui.form.on('Purchase Invoice', {\n    onload: function(frm) {\n        // This runs when the form first loads\n        clearShippingAddressFilter(frm);\n    },\n    refresh: function(frm) {\n        // This runs on every refresh\n        clearShippingAddressFilter(frm);\n    },\n    company: function(frm) {\n        // This runs when company field changes\n        clearShippingAddressFilter(frm);\n    }\n});\n\nfunction clearShippingAddressFilter(frm) {\n    // Method to override only the shipping_address filtering\n    \n    // For shipping_address only\n    frm.set_query(\"shipping_address\", function() {\n        return {\n            query: \"frappe.contacts.doctype.address.address.address_query\",\n            filters: {} // Empty filters to show all addresses\n        };\n    });\n    \n    // Clear any cached queries for shipping_address\n    if(frm.fields_dict.shipping_address) {\n        frm.fields_dict.shipping_address.get_query = function() {\n            return {\n                query: \"frappe.contacts.doctype.address.address.address_query\",\n                filters: {}\n            };\n        };\n    }\n    \n    // Force UI refresh of the shipping_address field\n    frm.refresh_field(\"shipping_address\");\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2025-03-12 11:30:27.399468",
  "module": "o2o ErpNext",
  "name": "filter for PR",
  "script": "frappe.ui.form.on('Purchase Receipt', {\n    onload: function(frm) {\n        // This runs when the form first loads\n        clearShippingAddressFilter(frm);\n    },\n    refresh: function(frm) {\n        // This runs on every refresh\n        clearShippingAddressFilter(frm);\n    },\n    company: function(frm) {\n        // This runs when company field changes\n        clearShippingAddressFilter(frm);\n    }\n});\n\nfunction clearShippingAddressFilter(frm) {\n    // Method to override only the shipping_address filtering\n    \n    // For shipping_address only\n    frm.set_query(\"shipping_address\", function() {\n        return {\n            query: \"frappe.contacts.doctype.address.address.address_query\",\n            filters: {} // Empty filters to show all addresses\n        };\n    });\n    \n    // Clear any cached queries for shipping_address\n    if(frm.fields_dict.shipping_address) {\n        frm.fields_dict.shipping_address.get_query = function() {\n            return {\n                query: \"frappe.contacts.doctype.address.address.address_query\",\n                filters: {}\n            };\n        };\n    }\n    \n    // Force UI refresh of the shipping_address field\n    frm.refresh_field(\"shipping_address\");\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sub Branch",
  "enabled": 1,
  "modified": "2025-04-03 04:07:42.693997",
  "module": "o2o ErpNext",
  "name": "Create Address Sub Branch",
  "script": "frappe.ui.form.on('Sub Branch', {\n    refresh: function(frm) {\n        // Clear existing custom buttons\n        frm.remove_custom_button('Create Address');\n        frm.remove_custom_button('Delete Address');\n        \n        // Check if addresses exist\n        let billing_exists = frm.doc.address ? true : false;\n        let shipping_exists = frm.doc.custom_shipping_address ? true : false;\n        \n        // Always show the Create Address button\n        frm.add_custom_button(__('Create Address'), function() {\n            // Show dialog to select address type\n            frappe.prompt([\n                {\n                    fieldname: 'address_type',\n                    label: __('Address Type'),\n                    fieldtype: 'Select',\n                    options: 'Billing\\nShipping',\n                    reqd: 1\n                }\n            ], function(values) {\n                // After selecting address type, create a dialog matching the address form\n                let address_type = values.address_type;\n                \n                let d = new frappe.ui.Dialog({\n                    title: __('New Address'),\n                    fields: [\n                        // Section 1: Address Details\n                        {\n                            fieldname: 'address_section',\n                            fieldtype: 'Section Break',\n                            label: __('Address Details')\n                        },\n                        {\n                            fieldname: 'address_line1',\n                            label: __('Address Line 1'),\n                            fieldtype: 'Data',\n                            reqd: 1\n                        },\n                        {\n                            fieldname: 'address_line2',\n                            label: __('Address Line 2'),\n                            fieldtype: 'Data'\n                        },\n                        {\n                            fieldname: 'city',\n                            label: __('City/Town'),\n                            fieldtype: 'Data',\n                            reqd: 1\n                        },\n                        {\n                            fieldname: 'state',\n                            label: __('State/Province'),\n                            fieldtype: 'Select',\n                            options: '\\nAndaman and Nicobar Islands\\nAndhra Pradesh\\nArunachal Pradesh\\nAssam\\nBihar\\nChandigarh\\nChhattisgarh\\nDadra and Nagar Haveli and Daman and Diu\\nDelhi\\nGoa\\nGujarat\\nHaryana\\nHimachal Pradesh\\nJammu and Kashmir\\nJharkhand\\nKarnataka\\nKerala\\nLadakh\\nLakshadweep\\nMadhya Pradesh\\nMaharashtra\\nManipur\\nMeghalaya\\nMizoram\\nNagaland\\nOdisha\\nPuducherry\\nPunjab\\nRajasthan\\nSikkim\\nTamil Nadu\\nTelangana\\nTripura\\nUttar Pradesh\\nUttarakhand\\nWest Bengal',\n                            reqd: 1,\n                            change: function() {\n                                let state = d.get_value('state');\n                                if (!state) return;\n                                \n                                // Default tax category\n                                let tax_category = 'In-State';\n                                \n                                // If we have supplier information, check state directly from supplier\n                                if (frm.doc.custom_supplier) {\n                                    frappe.db.get_value('Supplier', frm.doc.custom_supplier, 'custom_vendor_state')\n                                        .then(supplier_data => {\n                                            if (supplier_data && supplier_data.message && supplier_data.message.custom_vendor_state) {\n                                                let vendor_state = supplier_data.message.custom_vendor_state;\n                                                \n                                                // Compare states\n                                                if (state.toLowerCase() === vendor_state.toLowerCase()) {\n                                                    tax_category = 'In-State';\n                                                } else {\n                                                    tax_category = 'Out-State';\n                                                }\n                                                \n                                                // Set the tax category\n                                                d.set_value('tax_category', tax_category);\n                                            }\n                                        })\n                                        .catch(err => {\n                                            console.error(\"Error fetching supplier state:\", err);\n                                            // Set default tax category on error\n                                            d.set_value('tax_category', tax_category);\n                                        });\n                                } else {\n                                    // Set default tax category if no supplier\n                                    d.set_value('tax_category', tax_category);\n                                }\n                            }\n                        },\n                        {\n                            fieldname: 'country',\n                            label: __('Country'),\n                            fieldtype: 'Link',\n                            options: 'Country',\n                            default: 'India',\n                            reqd: 1\n                        },\n                        {\n                            fieldname: 'pincode',\n                            label: __('Postal Code'),\n                            fieldtype: 'Data',\n                            reqd: 1\n                        },\n                        // Column Break\n                        {\n                            fieldname: 'col_break1',\n                            fieldtype: 'Column Break'\n                        },\n                        {\n                            fieldname: 'is_primary_address',\n                            label: __('Preferred Billing Address'),\n                            fieldtype: 'Check',\n                            default: address_type === 'Billing' ? 1 : 0\n                        },\n                        {\n                            fieldname: 'is_shipping_address',\n                            label: __('Preferred Shipping Address'),\n                            fieldtype: 'Check',\n                            default: address_type === 'Shipping' ? 1 : 0\n                        },\n                        {\n                            fieldname: 'disabled',\n                            label: __('Disabled'),\n                            fieldtype: 'Check',\n                            default: 0\n                        },\n                        // Section 2: Tax Details\n                        {\n                            fieldname: 'tax_section',\n                            fieldtype: 'Section Break',\n                            label: __('Tax Details')\n                        },\n                        {\n                            fieldname: 'gstin',\n                            label: __('GSTIN / UIN'),\n                            fieldtype: 'Data'\n                        },\n                        {\n                            fieldname: 'tax_category',\n                            label: __('Tax Category'),\n                            fieldtype: 'Link',\n                            options: 'Tax Category',\n                            default: 'In-State',\n                            reqd: 1\n                        },\n                        {\n                            fieldname: 'col_break2',\n                            fieldtype: 'Column Break'\n                        },\n                        {\n                            fieldname: 'gst_category',\n                            label: __('GST Category'),\n                            fieldtype: 'Select',\n                            options: 'Registered Regular\\nRegistered Composition\\nUnregistered\\nOverseas\\nUIN Holders\\nSEZ\\nDeemed Export',\n                            default: 'Unregistered'\n                        }\n                    ],\n                    primary_action_label: __('Save'),\n                    primary_action: function() {\n                        let values = d.get_values();\n                        \n                        // Call server-side method to create address\n                        frappe.call({\n                            method: \"create_address\",\n                            doc: frm.doc,\n                            args: {\n                                address_type: address_type,\n                                address_data: values\n                            },\n                            callback: function(r) {\n                                if (r.message && r.message.status === \"success\") {\n                                    frm.reload_doc();\n                                    d.hide();\n                                }\n                            }\n                        });\n                    }\n                });\n                \n                d.show();\n                \n                // Add \"Edit Full Form\" button\n                d.$wrapper.find('.modal-footer').prepend(`\n                    <button class=\"btn btn-default edit-full-form\">\n                        ${__('Edit Full Form')}\n                    </button>\n                `);\n                \n                // Handle Edit Full Form button click\n                d.$wrapper.find('.edit-full-form').on('click', function() {\n                    d.hide();\n                    \n                    // Create temporary address and open in full form\n                    let tmp_address = frappe.model.get_new_doc(\"Address\");\n                    frappe.set_route(\"Form\", \"Address\", tmp_address.name);\n                });\n            }, __('Select Address Type'), __('Next'));\n        }).addClass('btn-primary');\n        \n        // Show Delete Address button only if addresses exist\n        if (billing_exists || shipping_exists) {\n            frm.add_custom_button(__('Delete Address'), function() {\n                // Show a dialog with checkboxes for addresses\n                let fields = [];\n                \n                if (billing_exists) {\n                    fields.push({\n                        fieldname: 'delete_billing',\n                        label: __('Delete Billing Address'),\n                        fieldtype: 'Check',\n                        default: 0\n                    });\n                }\n                \n                if (shipping_exists) {\n                    fields.push({\n                        fieldname: 'delete_shipping',\n                        label: __('Delete Shipping Address'),\n                        fieldtype: 'Check',\n                        default: 0\n                    });\n                }\n                \n                frappe.prompt(\n                    fields,\n                    function(values) {\n                        let addresses_to_delete = [];\n                        \n                        // Prepare for update\n                        let update_fields = {};\n                        \n                        if (billing_exists && values.delete_billing) {\n                            addresses_to_delete.push(frm.doc.address);\n                            update_fields.address = '';\n                            update_fields.custom_billing_address_details = '';\n                        }\n                        \n                        if (shipping_exists && values.delete_shipping) {\n                            addresses_to_delete.push(frm.doc.custom_shipping_address);\n                            update_fields.custom_shipping_address = '';\n                            update_fields.custom_shipping_address_details = '';\n                        }\n                        \n                        if (addresses_to_delete.length === 0) {\n                            frappe.msgprint(__('No addresses selected for deletion'));\n                            return;\n                        }\n                        \n                        // First update sub branch to remove references\n                        frappe.model.set_value(frm.doctype, frm.docname, update_fields);\n                        frm.save().then(() => {\n                            // After saving Sub Branch, delete addresses one by one\n                            let deletion_promises = addresses_to_delete.map(addr => {\n                                return frappe.call({\n                                    method: 'frappe.client.delete',\n                                    args: {\n                                        doctype: 'Address',\n                                        name: addr\n                                    }\n                                });\n                            });\n                            \n                            Promise.all(deletion_promises).then(() => {\n                                frappe.msgprint(__('Selected addresses deleted'));\n                                frm.refresh();\n                            }).catch(err => {\n                                console.error(\"Error deleting addresses:\", err);\n                                frappe.msgprint(__('Error deleting some addresses. Please refresh and try again.'));\n                                frm.refresh();\n                            });\n                        });\n                    },\n                    __('Select Addresses to Delete'),\n                    __('Delete')\n                );\n            }).addClass('btn-primary');\n        }\n    }\n});",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item Price",
  "enabled": 1,
  "modified": "2025-04-05 11:11:17.155571",
  "module": "o2o ErpNext",
  "name": "Item Price Filter",
  "script": "frappe.listview_settings['Item Price'] = {\n    // Track state to prevent duplicate operations\n    filter_initialized: false,\n    supplier_value: null,\n    \n    onload: function(listview) {\n        // Store reference to listview\n        this.listview = listview;\n        \n        // Exit early for Administrator\n        if (this.isAdministrator()) {\n            console.log(\"User is Administrator, skipping filter\");\n            return;\n        }\n        \n        // Check for relevant roles\n        const hasRelevantRole = this.hasSupplierRole() || this.hasApproverRole();\n        \n        if (!hasRelevantRole) {\n            console.log(\"User doesn't have Supplier, Requisition Approver, or PO Approver role, skipping filter\");\n            return;\n        }\n        \n        // Apply filter once per page load\n        if (!this.filter_initialized) {\n            console.log(\"Initializing supplier filter for restricted user\");\n            this.initializeSupplierFilter();\n        }\n    },\n    \n    isAdministrator: function() {\n        // Check if current user is Administrator\n        return frappe.user_roles.includes('Administrator');\n    },\n    \n    hasSupplierRole: function() {\n        // Check if user has Supplier role\n        return frappe.user_roles.includes('Supplier');\n    },\n    \n    hasApproverRole: function() {\n        // Check if user has either Requisition Approver or PO Approver role\n        return frappe.user_roles.includes('Requisition Approver') || \n               frappe.user_roles.includes('PO Approver');\n    },\n    \n    initializeSupplierFilter: function() {\n        // Mark as initialized to prevent duplicate calls\n        this.filter_initialized = true;\n        \n        var me = this;\n        \n        // Different supplier lookup logic based on role\n        if (this.hasSupplierRole()) {\n            // For Supplier role - Get supplier directly linked to user\n            this.getSupplierFromUser();\n        } else if (this.hasApproverRole()) {\n            // For Approver roles - Get supplier through employee\n            this.getSupplierFromEmployee();\n        }\n    },\n    \n    getSupplierFromUser: function() {\n        var me = this;\n        \n        // Get the supplier linked to the current user\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Supplier',\n                filters: { 'custom_user': frappe.session.user },\n                fieldname: ['name']\n            },\n            callback: function(r) {\n                if (r.message && r.message.name) {\n                    me.supplier_value = r.message.name;\n                    console.log(\"Found supplier for current user:\", me.supplier_value);\n                    \n                    // Apply filter for this supplier\n                    me.applySupplierFilter(me.supplier_value);\n                    \n                    // Show notification\n                    frappe.show_alert({\n                        message: __(`Showing price list items for your supplier account: ${me.supplier_value}`),\n                        indicator: 'blue'\n                    }, 5);\n                } else {\n                    console.log(\"No supplier found linked to current user\");\n                    frappe.show_alert({\n                        message: __('No supplier is linked to your user account.'),\n                        indicator: 'orange'\n                    }, 5);\n                }\n            }\n        });\n    },\n    \n    getSupplierFromEmployee: function() {\n        var me = this;\n        \n        // First get the employee linked to the current user\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Employee',\n                filters: { 'user_id': frappe.session.user },\n                fieldname: ['name', 'custom_supplier']\n            },\n            callback: function(r) {\n                if (r.message && r.message.custom_supplier) {\n                    me.supplier_value = r.message.custom_supplier;\n                    console.log(\"Found supplier from employee record:\", me.supplier_value);\n                    \n                    // Apply filter for this supplier\n                    me.applySupplierFilter(me.supplier_value);\n                    \n                    // Show notification\n                    frappe.show_alert({\n                        message: __(`Showing price list items for your associated supplier: ${me.supplier_value}`),\n                        indicator: 'blue'\n                    }, 5);\n                } else {\n                    console.log(\"No supplier found linked to employee record\");\n                    frappe.show_alert({\n                        message: __('No supplier is associated with your employee record.'),\n                        indicator: 'orange'\n                    }, 5);\n                }\n            }\n        });\n    },\n    \n    applySupplierFilter: function(supplier) {\n        if (!supplier || !this.listview) return;\n        \n        var me = this;\n        \n        console.log(\"Applying supplier filter to Item Price list:\", supplier);\n        \n        // Clear existing filters\n        this.listview.filter_area.clear();\n        \n        // Add supplier filter\n        this.listview.filter_area.add([\n            ['Item Price', 'supplier', '=', supplier]\n        ]);\n        \n        // Apply UI restrictions\n        this.applyUIRestrictions();\n        \n        // Override filter methods to maintain filter\n        this.overrideFilterMethods(supplier);\n    },\n    \n    overrideFilterMethods: function(supplier) {\n        var me = this;\n        \n        // Override the get method to ensure our filter always stays applied\n        var originalGet = this.listview.filter_area.get;\n        \n        this.listview.filter_area.get = function() {\n            var filters = originalGet.apply(this, arguments);\n            \n            // Check if our filter exists\n            var hasSupplierFilter = filters.some(function(f) {\n                return (Array.isArray(f) && f[1] === 'supplier' && f[3] === supplier) ||\n                       (f.fieldname === 'supplier' && f.value === supplier);\n            });\n            \n            // If not, add it back to the filters array\n            if (!hasSupplierFilter) {\n                filters.push(['Item Price', 'supplier', '=', supplier]);\n            }\n            \n            return filters;\n        };\n        \n        // Override the clear method to prevent complete clearing\n        var originalClear = this.listview.filter_area.clear;\n        \n        this.listview.filter_area.clear = function() {\n            // Call original clear\n            originalClear.apply(this, arguments);\n            \n            // Immediately re-add our filter without triggering refresh\n            this.filters.push({\n                fieldname: 'supplier',\n                label: 'Supplier',\n                condition: '=',\n                value: supplier\n            });\n        };\n    },\n    \n    applyUIRestrictions: function() {\n        // Add CSS to restrict UI\n        if (!document.getElementById('item-price-restriction-style')) {\n            var style = document.createElement('style');\n            style.id = 'item-price-restriction-style';\n            style.innerHTML = `\n                .filter-selector, .filter-button, .tag-filters-area, .clear-filters { \n                    display: none !important; \n                }\n                .filter-box .filter-area { \n                    pointer-events: none !important; \n                }\n                .filter-tag .remove-filter {\n                    display: none !important;\n                }\n            `;\n            document.head.appendChild(style);\n        }\n    },\n    \n    refresh: function(listview) {\n        // Update listview reference\n        this.listview = listview;\n        \n        // Skip for Administrator\n        if (this.isAdministrator()) {\n            return;\n        }\n        \n        // Check for relevant roles\n        const hasRelevantRole = this.hasSupplierRole() || this.hasApproverRole();\n        \n        if (!hasRelevantRole) {\n            return;\n        }\n        \n        // Initialize filter if not already done\n        if (!this.filter_initialized) {\n            this.initializeSupplierFilter();\n            return;\n        }\n        \n        // Re-apply UI restrictions\n        this.applyUIRestrictions();\n        \n        // Check if we need to re-apply filter\n        if (this.supplier_value) {\n            var current_filters = listview.filter_area.get();\n            \n            // Check if our filter exists\n            var hasFilter = current_filters.some(function(f) {\n                return (Array.isArray(f) && f[1] === 'supplier' && f[3] === this.supplier_value) ||\n                       (f.fieldname === 'supplier' && f.value === this.supplier_value);\n            }, this);\n            \n            // Re-apply if filter is missing\n            if (!hasFilter) {\n                console.log(\"Re-applying supplier filter\");\n                this.listview.filter_area.add([\n                    ['Item Price', 'supplier', '=', this.supplier_value]\n                ]);\n            }\n        }\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2025-04-04 12:52:52.565154",
  "module": null,
  "name": "Purchase Receipt Limit on PI",
  "script": "// Purchase Receipt - Client Script\nfrappe.ui.form.on('Purchase Receipt', {\n    refresh: function(frm) {\n        if (frm.doc.__islocal || frm.doc.docstatus !== 1) {\n            return; // Only run for saved, submitted documents\n        }\n        \n        // Add the Check Linked Invoices button\n        frm.add_custom_button(__('Check Linked Invoices'), function() {\n            check_linked_invoices(frm);\n        }, __(\"Tools\"));\n        \n        // When the form refreshes, directly override the standard make_purchase_invoice function\n        // Store the original function\n        if (!window._original_make_purchase_invoice) {\n            window._original_make_purchase_invoice = cur_frm.cscript.make_purchase_invoice;\n            \n            // Replace it with our custom function\n            cur_frm.cscript.make_purchase_invoice = function() {\n                // Check for linked invoices before proceeding\n                frappe.call({\n                    method: \"o2o_erpnext.api.purchase_receipt.check_linked_purchase_invoices\",\n                    args: {\n                        \"purchase_receipt\": frm.doc.name\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.success) {\n                            if (r.message.has_active_invoices) {\n                                // Format invoice list for display\n                                const invoice_list = r.message.invoices.map(inv => \n                                    `${inv.name} (${inv.status})`).join('<br>');\n                                \n                                // If active invoices exist (Draft OR Submitted), show warning\n                                frappe.msgprint({\n                                    title: __('Cannot Create Purchase Invoice'),\n                                    indicator: 'red',\n                                    message: __(`This Purchase Receipt already has active linked Purchase Invoices:<br>${invoice_list}<br><br>You cannot create additional Purchase Invoices for this receipt.`)\n                                });\n                            } else {\n                                // If no active invoices, proceed with original method\n                                window._original_make_purchase_invoice.apply(cur_frm.cscript);\n                            }\n                        } else {\n                            frappe.msgprint({\n                                title: __('Error'),\n                                indicator: 'red',\n                                message: __('Failed to check for linked Purchase Invoices. For safety, invoice creation has been blocked.')\n                            });\n                        }\n                    }\n                });\n            };\n        }\n        \n        // Also check for linked invoices silently on form load\n        check_linked_invoices(frm, true).then(function(result) {\n            if (result && result.has_active_invoices) {\n                // Format the invoice list for display\n                const invoice_list = result.invoices.map(inv => \n                    `${inv.name} (${inv.status})`).join('<br>');\n                \n                // Add an indicator to the dashboard with both Draft and Submitted status mentioned\n                frm.dashboard.add_indicator(\n                    __(\"Has active linked Purchase Invoices in Draft or Submitted status\"), \"red\"\n                );\n                \n                // Add a custom message in the dashboard\n                frm.dashboard.add_section(\n                    `<div class=\"form-dashboard-section custom-linked-invoices\">\n                        <div class=\"section-head\">Linked Purchase Invoices</div>\n                        <div class=\"row\">\n                            <div class=\"col-md-12\">\n                                <div class=\"alert alert-warning\">\n                                    This Purchase Receipt has active linked Purchase Invoices in Draft or Submitted status:<br>\n                                    ${invoice_list}<br><br>\n                                    You cannot create additional Purchase Invoices for this receipt.\n                                </div>\n                            </div>\n                        </div>\n                    </div>`\n                );\n            }\n        }).catch(function(err) {\n            console.error(\"Error checking linked invoices:\", err);\n        });\n    }\n});\n\n// Function to check linked invoices\nfunction check_linked_invoices(frm, silent = false) {\n    return new Promise(function(resolve, reject) {\n        if (!silent) {\n            frappe.show_alert({\n                message: __(\"Checking for linked Purchase Invoices in Draft or Submitted status...\"),\n                indicator: 'blue'\n            }, 3);\n        }\n        \n        frappe.call({\n            method: \"o2o_erpnext.api.purchase_receipt.check_linked_purchase_invoices\",\n            args: {\n                \"purchase_receipt\": frm.doc.name\n            },\n            callback: function(r) {\n                if (r.message && r.message.success) {\n                    if (r.message.has_active_invoices && !silent) {\n                        // Format the invoice list\n                        const invoice_list = r.message.invoices.map(inv => \n                            `${inv.name} (${inv.status})`).join('<br>');\n                        \n                        // Show warning message explicitly mentioning Draft OR Submitted status\n                        frappe.msgprint({\n                            title: __('Active Linked Invoices Found'),\n                            indicator: 'red',\n                            message: __(`This Purchase Receipt has active linked Purchase Invoices in Draft or Submitted status:<br>${invoice_list}<br><br>You cannot create additional Purchase Invoices for this receipt.`)\n                        });\n                    } else if (!r.message.has_active_invoices && !silent) {\n                        frappe.msgprint({\n                            title: __('No Active Linked Invoices'),\n                            indicator: 'green',\n                            message: __('No active Purchase Invoices found in Draft or Submitted status. You can create a new one.')\n                        });\n                    }\n                    \n                    resolve(r.message);\n                } else {\n                    if (!silent) {\n                        frappe.msgprint({\n                            title: __('Error'),\n                            indicator: 'red',\n                            message: __('Failed to check for linked Purchase Invoices.')\n                        });\n                    }\n                    reject(new Error(\"Failed to check linked invoices\"));\n                }\n            }\n        });\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 0,
  "modified": "2025-12-24 16:12:18.268511",
  "module": null,
  "name": "Item Filter",
  "script": "frappe.listview_settings['Item'] = {\n    // Track state to prevent duplicate operations\n    filter_initialized: false,\n    supplier_value: null,\n    \n    onload: function(listview) {\n        // Store reference to listview\n        this.listview = listview;\n        \n        // Exit early for Administrator\n        if (this.isAdministrator()) {\n            console.log(\"User is Administrator, skipping filter\");\n            return;\n        }\n        \n        // Check for relevant roles\n        const hasRelevantRole = this.hasSupplierRole() || this.hasApproverRole();\n        \n        if (!hasRelevantRole) {\n            console.log(\"User doesn't have Supplier, Requisition Approver, or PO Approver role, skipping filter\");\n            return;\n        }\n        \n        // Apply filter once per page load\n        if (!this.filter_initialized) {\n            console.log(\"Initializing supplier filter for restricted user\");\n            this.initializeSupplierFilter();\n        }\n    },\n    \n    isAdministrator: function() {\n        // Check if current user is Administrator\n        return frappe.user_roles.includes('Administrator');\n    },\n    \n    hasSupplierRole: function() {\n        // Check if user has Supplier role\n        return frappe.user_roles.includes('Supplier');\n    },\n    \n    hasApproverRole: function() {\n        // Check if user has either Requisition Approver or PO Approver role\n        return frappe.user_roles.includes('Requisition Approver') || \n               frappe.user_roles.includes('PO Approver');\n    },\n    \n    initializeSupplierFilter: function() {\n        // Mark as initialized to prevent duplicate calls\n        this.filter_initialized = true;\n        \n        var me = this;\n        \n        // Different supplier lookup logic based on role\n        if (this.hasSupplierRole()) {\n            // For Supplier role - Get supplier directly linked to user\n            this.getSupplierFromUser();\n        } else if (this.hasApproverRole()) {\n            // For Approver roles - Get supplier through employee\n            this.getSupplierFromEmployee();\n        }\n    },\n    \n    getSupplierFromUser: function() {\n        var me = this;\n        \n        // Get the supplier linked to the current user\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Supplier',\n                filters: { 'custom_user': frappe.session.user },\n                fieldname: ['name']\n            },\n            callback: function(r) {\n                if (r.message && r.message.name) {\n                    me.supplier_value = r.message.name;\n                    console.log(\"Found supplier for current user:\", me.supplier_value);\n                    \n                    // Apply filter for this supplier\n                    me.applySupplierFilter(me.supplier_value);\n                    \n                    // Show notification\n                    frappe.show_alert({\n                        message: __(`Showing items for your supplier account: ${me.supplier_value}`),\n                        indicator: 'blue'\n                    }, 5);\n                } else {\n                    console.log(\"No supplier found linked to current user\");\n                    frappe.show_alert({\n                        message: __('No supplier is linked to your user account.'),\n                        indicator: 'orange'\n                    }, 5);\n                }\n            }\n        });\n    },\n    \n    getSupplierFromEmployee: function() {\n        var me = this;\n        \n        // First get the employee linked to the current user\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Employee',\n                filters: { 'user_id': frappe.session.user },\n                fieldname: ['name', 'custom_supplier']\n            },\n            callback: function(r) {\n                if (r.message && r.message.custom_supplier) {\n                    me.supplier_value = r.message.custom_supplier;\n                    console.log(\"Found supplier from employee record:\", me.supplier_value);\n                    \n                    // Apply filter for this supplier\n                    me.applySupplierFilter(me.supplier_value);\n                    \n                    // Show notification\n                    frappe.show_alert({\n                        message: __(`Showing items for your associated supplier: ${me.supplier_value}`),\n                        indicator: 'blue'\n                    }, 5);\n                } else {\n                    console.log(\"No supplier found linked to employee record\");\n                    frappe.show_alert({\n                        message: __('No supplier is associated with your employee record.'),\n                        indicator: 'orange'\n                    }, 5);\n                }\n            }\n        });\n    },\n    \n    applySupplierFilter: function(supplier) {\n        if (!supplier || !this.listview) return;\n        \n        var me = this;\n        \n        console.log(\"Applying supplier filter to Item list:\", supplier);\n        \n        // Clear existing filters\n        this.listview.filter_area.clear();\n        \n        // Add supplier filter using our custom server-side method\n        this.fetchItemsForSupplier(supplier);\n    },\n    \n    fetchItemsForSupplier: function(supplier) {\n        var me = this;\n        \n        // Use our custom server-side method to get the items\n        frappe.call({\n            method: 'o2o_erpnext.api.item.get_items_for_supplier',\n            args: {\n                supplier: supplier\n            },\n            callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    console.log(`Found ${r.message.length} items for supplier ${supplier}`);\n                    me.applyItemsFilter(r.message);\n                } else {\n                    console.log(`No items found for supplier ${supplier}`);\n                    me.listview.filter_area.add([\n                        ['Item', 'name', '=', 'NO_ITEMS_FOR_THIS_SUPPLIER']\n                    ]);\n                    \n                    frappe.show_alert({\n                        message: __('No items found for your supplier.'),\n                        indicator: 'orange'\n                    }, 5);\n                }\n                \n                me.applyUIRestrictions();\n            }\n        });\n    },\n    \n    applyItemsFilter: function(items) {\n        var me = this;\n        \n        if (!items || !items.length || !this.listview) return;\n        \n        // Apply the \"in\" filter for item codes\n        this.listview.filter_area.add([\n            ['Item', 'name', 'in', items]\n        ]);\n        \n        // Override filter methods to maintain filter\n        this.overrideFilterMethods(items);\n    },\n    \n    overrideFilterMethods: function(items) {\n        var me = this;\n        var supplier = this.supplier_value;\n        \n        // Override the get method to ensure our filter always stays applied\n        var originalGet = this.listview.filter_area.get;\n        \n        this.listview.filter_area.get = function() {\n            var filters = originalGet.apply(this, arguments);\n            \n            // Check if our filter exists (either supplier filter or items filter)\n            var hasItemsFilter = filters.some(function(f) {\n                return (Array.isArray(f) && f[1] === 'name' && f[2] === 'in' && Array.isArray(f[3])) ||\n                       (f.fieldname === 'name' && f.condition === 'in' && Array.isArray(f.value));\n            });\n            \n            // If not, add it back to the filters array\n            if (!hasItemsFilter && items && items.length) {\n                filters.push(['Item', 'name', 'in', items]);\n            }\n            \n            return filters;\n        };\n        \n        // Override the clear method to prevent complete clearing\n        var originalClear = this.listview.filter_area.clear;\n        \n        this.listview.filter_area.clear = function() {\n            // Call original clear\n            originalClear.apply(this, arguments);\n            \n            // Immediately re-add our filter without triggering refresh\n            if (items && items.length) {\n                this.filters.push({\n                    fieldname: 'name',\n                    label: 'Name',\n                    condition: 'in',\n                    value: items\n                });\n            } else {\n                // Fallback to impossible filter if no items\n                this.filters.push({\n                    fieldname: 'name',\n                    label: 'Name',\n                    condition: '=',\n                    value: 'NO_ITEMS_FOR_THIS_SUPPLIER'\n                });\n            }\n        };\n    },\n    \n    applyUIRestrictions: function() {\n        // Add CSS to restrict UI\n        if (!document.getElementById('item-restriction-style')) {\n            var style = document.createElement('style');\n            style.id = 'item-restriction-style';\n            style.innerHTML = `\n                .filter-selector, .filter-button, .tag-filters-area, .clear-filters { \n                    display: none !important; \n                }\n                .filter-box .filter-area { \n                    pointer-events: none !important; \n                }\n                .filter-tag .remove-filter {\n                    display: none !important;\n                }\n            `;\n            document.head.appendChild(style);\n        }\n    },\n    \n    refresh: function(listview) {\n        // Update listview reference\n        this.listview = listview;\n        \n        // Skip for Administrator\n        if (this.isAdministrator()) {\n            return;\n        }\n        \n        // Check for relevant roles\n        const hasRelevantRole = this.hasSupplierRole() || this.hasApproverRole();\n        \n        if (!hasRelevantRole) {\n            return;\n        }\n        \n        // Initialize filter if not already done\n        if (!this.filter_initialized) {\n            this.initializeSupplierFilter();\n            return;\n        }\n        \n        // Re-apply UI restrictions\n        this.applyUIRestrictions();\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Party Specific Item",
  "enabled": 1,
  "modified": "2025-04-05 11:35:36.339508",
  "module": "o2o ErpNext",
  "name": "Party Specific Filter",
  "script": "frappe.listview_settings['Party Specific Item'] = {\n    // Track state to prevent duplicate operations\n    filter_initialized: false,\n    supplier_value: null,\n    \n    onload: function(listview) {\n        // Store reference to listview\n        this.listview = listview;\n        \n        // Exit early for Administrator\n        if (this.isAdministrator()) {\n            console.log(\"User is Administrator, skipping filter\");\n            return;\n        }\n        \n        // Check for relevant roles\n        const hasRelevantRole = this.hasSupplierRole() || this.hasApproverRole();\n        \n        if (!hasRelevantRole) {\n            console.log(\"User doesn't have Supplier, Requisition Approver, or PO Approver role, skipping filter\");\n            return;\n        }\n        \n        // Apply filter once per page load\n        if (!this.filter_initialized) {\n            console.log(\"Initializing supplier filter for restricted user\");\n            this.initializeSupplierFilter();\n        }\n    },\n    \n    isAdministrator: function() {\n        // Check if current user is Administrator\n        return frappe.user_roles.includes('Administrator');\n    },\n    \n    hasSupplierRole: function() {\n        // Check if user has Supplier role\n        return frappe.user_roles.includes('Supplier');\n    },\n    \n    hasApproverRole: function() {\n        // Check if user has either Requisition Approver or PO Approver role\n        return frappe.user_roles.includes('Requisition Approver') || \n               frappe.user_roles.includes('PO Approver');\n    },\n    \n    initializeSupplierFilter: function() {\n        // Mark as initialized to prevent duplicate calls\n        this.filter_initialized = true;\n        \n        var me = this;\n        \n        // Different supplier lookup logic based on role\n        if (this.hasSupplierRole()) {\n            // For Supplier role - Get supplier directly linked to user\n            this.getSupplierFromUser();\n        } else if (this.hasApproverRole()) {\n            // For Approver roles - Get supplier through employee\n            this.getSupplierFromEmployee();\n        }\n    },\n    \n    getSupplierFromUser: function() {\n        var me = this;\n        \n        // Get the supplier linked to the current user\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Supplier',\n                filters: { 'custom_user': frappe.session.user },\n                fieldname: ['name']\n            },\n            callback: function(r) {\n                if (r.message && r.message.name) {\n                    me.supplier_value = r.message.name;\n                    console.log(\"Found supplier for current user:\", me.supplier_value);\n                    \n                    // Apply filter for this supplier\n                    me.applySupplierFilter(me.supplier_value);\n                    \n                    // Show notification\n                    frappe.show_alert({\n                        message: __(`Showing party specific items for your supplier account: ${me.supplier_value}`),\n                        indicator: 'blue'\n                    }, 5);\n                } else {\n                    console.log(\"No supplier found linked to current user\");\n                    frappe.show_alert({\n                        message: __('No supplier is linked to your user account.'),\n                        indicator: 'orange'\n                    }, 5);\n                }\n            }\n        });\n    },\n    \n    getSupplierFromEmployee: function() {\n        var me = this;\n        \n        // First get the employee linked to the current user\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Employee',\n                filters: { 'user_id': frappe.session.user },\n                fieldname: ['name', 'custom_supplier']\n            },\n            callback: function(r) {\n                if (r.message && r.message.custom_supplier) {\n                    me.supplier_value = r.message.custom_supplier;\n                    console.log(\"Found supplier from employee record:\", me.supplier_value);\n                    \n                    // Apply filter for this supplier\n                    me.applySupplierFilter(me.supplier_value);\n                    \n                    // Show notification\n                    frappe.show_alert({\n                        message: __(`Showing party specific items for your associated supplier: ${me.supplier_value}`),\n                        indicator: 'blue'\n                    }, 5);\n                } else {\n                    console.log(\"No supplier found linked to employee record\");\n                    frappe.show_alert({\n                        message: __('No supplier is associated with your employee record.'),\n                        indicator: 'orange'\n                    }, 5);\n                }\n            }\n        });\n    },\n    \n    applySupplierFilter: function(supplier) {\n        if (!supplier || !this.listview) return;\n        \n        var me = this;\n        \n        console.log(\"Applying supplier filter to Party Specific Item list:\", supplier);\n        \n        // Clear existing filters\n        this.listview.filter_area.clear();\n        \n        // Add supplier filter - Assuming 'party' field contains the supplier\n        // and 'party_type' is 'Supplier'\n        this.listview.filter_area.add([\n            ['Party Specific Item', 'party', '=', supplier],\n            ['Party Specific Item', 'party_type', '=', 'Supplier']\n        ]);\n        \n        // Apply UI restrictions\n        this.applyUIRestrictions();\n        \n        // Override filter methods to maintain filter\n        this.overrideFilterMethods(supplier);\n    },\n    \n    overrideFilterMethods: function(supplier) {\n        var me = this;\n        \n        // Override the get method to ensure our filter always stays applied\n        var originalGet = this.listview.filter_area.get;\n        \n        this.listview.filter_area.get = function() {\n            var filters = originalGet.apply(this, arguments);\n            \n            // Check if our supplier filter exists\n            var hasSupplierFilter = filters.some(function(f) {\n                return (Array.isArray(f) && f[1] === 'party' && f[3] === supplier) ||\n                       (f.fieldname === 'party' && f.value === supplier);\n            });\n            \n            // Check if our party_type filter exists\n            var hasPartyTypeFilter = filters.some(function(f) {\n                return (Array.isArray(f) && f[1] === 'party_type' && f[3] === 'Supplier') ||\n                       (f.fieldname === 'party_type' && f.value === 'Supplier');\n            });\n            \n            // If either is missing, add them back\n            if (!hasSupplierFilter) {\n                filters.push(['Party Specific Item', 'party', '=', supplier]);\n            }\n            \n            if (!hasPartyTypeFilter) {\n                filters.push(['Party Specific Item', 'party_type', '=', 'Supplier']);\n            }\n            \n            return filters;\n        };\n        \n        // Override the clear method to prevent complete clearing\n        var originalClear = this.listview.filter_area.clear;\n        \n        this.listview.filter_area.clear = function() {\n            // Call original clear\n            originalClear.apply(this, arguments);\n            \n            // Immediately re-add our filters without triggering refresh\n            this.filters.push({\n                fieldname: 'party',\n                label: 'Party',\n                condition: '=',\n                value: supplier\n            });\n            \n            this.filters.push({\n                fieldname: 'party_type',\n                label: 'Party Type',\n                condition: '=',\n                value: 'Supplier'\n            });\n        };\n    },\n    \n    applyUIRestrictions: function() {\n        // Add CSS to restrict UI\n        if (!document.getElementById('party-specific-item-restriction-style')) {\n            var style = document.createElement('style');\n            style.id = 'party-specific-item-restriction-style';\n            style.innerHTML = `\n                .filter-selector, .filter-button, .tag-filters-area, .clear-filters { \n                    display: none !important; \n                }\n                .filter-box .filter-area { \n                    pointer-events: none !important; \n                }\n                .filter-tag .remove-filter {\n                    display: none !important;\n                }\n            `;\n            document.head.appendChild(style);\n        }\n    },\n    \n    refresh: function(listview) {\n        // Update listview reference\n        this.listview = listview;\n        \n        // Skip for Administrator\n        if (this.isAdministrator()) {\n            return;\n        }\n        \n        // Check for relevant roles\n        const hasRelevantRole = this.hasSupplierRole() || this.hasApproverRole();\n        \n        if (!hasRelevantRole) {\n            return;\n        }\n        \n        // Initialize filter if not already done\n        if (!this.filter_initialized) {\n            this.initializeSupplierFilter();\n            return;\n        }\n        \n        // Re-apply UI restrictions\n        this.applyUIRestrictions();\n        \n        // Check if we need to re-apply filter\n        if (this.supplier_value) {\n            var current_filters = listview.filter_area.get();\n            \n            // Check if our supplier filter exists\n            var hasSupplierFilter = current_filters.some(function(f) {\n                return (Array.isArray(f) && f[1] === 'party' && f[3] === this.supplier_value) ||\n                       (f.fieldname === 'party' && f.value === this.supplier_value);\n            }, this);\n            \n            // Check if our party_type filter exists\n            var hasPartyTypeFilter = current_filters.some(function(f) {\n                return (Array.isArray(f) && f[1] === 'party_type' && f[3] === 'Supplier') ||\n                       (f.fieldname === 'party_type' && f.value === 'Supplier');\n            }, this);\n            \n            // Re-apply if either filter is missing\n            if (!hasSupplierFilter || !hasPartyTypeFilter) {\n                console.log(\"Re-applying supplier filters\");\n                \n                // Clear and re-add both filters to ensure correct order\n                this.listview.filter_area.clear();\n                \n                this.listview.filter_area.add([\n                    ['Party Specific Item', 'party', '=', this.supplier_value],\n                    ['Party Specific Item', 'party_type', '=', 'Supplier']\n                ]);\n            }\n        }\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Party Specific Item",
  "enabled": 1,
  "modified": "2025-04-09 14:52:00.974914",
  "module": null,
  "name": "Party Specific Item Supplier Update",
  "script": "frappe.ui.form.on('Party Specific Item', {\n    refresh: function(frm) {\n        // Set default party type to Supplier\n        if(frm.is_new()) {\n            frm.set_value('party_type', 'Supplier');\n        }\n        \n        // Add custom button to update supplier access\n        frm.add_custom_button(__('Update Supplier Access List'), function() {\n            // Show appropriate confirmation message based on restriction type\n            let confirmation_message = 'This will add the supplier to the access list. Continue?';\n            \n            if(frm.doc.restrict_based_on === 'Item Group') {\n                confirmation_message = 'This will add the supplier to the access list for ALL items in this group. This may take some time. Continue?';\n            } else if(frm.doc.restrict_based_on === 'Brand') {\n                confirmation_message = 'This will add the supplier to the access list for ALL items with this brand. This may take some time. Continue?';\n            }\n            \n            frappe.confirm(\n                confirmation_message,\n                function() {\n                    // User clicked Yes\n                    update_supplier_access(frm);\n                },\n                function() {\n                    // User clicked No\n                    // Do nothing\n                }\n            );\n        });\n    },\n    \n    // Always force party_type to be Supplier\n    party_type: function(frm) {\n        if(frm.doc.party_type !== 'Supplier') {\n            frm.set_value('party_type', 'Supplier');\n            frappe.show_alert({\n                message: __('Party Type is always set to Supplier'),\n                indicator: 'orange'\n            }, 5);\n        }\n    },\n    \n    // Add before_save event to call our function automatically\n    before_save: function(frm) {\n        // Set party_type to 'Supplier' before saving (just to be sure)\n        frm.doc.party_type = 'Supplier';\n        \n        // If the document has the right criteria, flag it for update after save\n        if(frm.doc.restrict_based_on && frm.doc.party && frm.doc.based_on_value) {\n            frm._update_supplier_after_save = true;\n        }\n    },\n    \n    after_save: function(frm) {\n        // Check if we flagged this document to update supplier access\n        if(frm._update_supplier_after_save) {\n            // Reset the flag\n            frm._update_supplier_after_save = false;\n            \n            // Call our function\n            update_supplier_access(frm);\n        }\n    }\n});\n\n// Function to call the server script\nfunction update_supplier_access(frm) {\n    if(!frm.doc.restrict_based_on) {\n        frappe.msgprint(__(\"Please select a restriction type\"));\n        return;\n    }\n    \n    if(!frm.doc.party || !frm.doc.based_on_value) {\n        frappe.msgprint(__(\"Both Supplier and restriction value must be selected\"));\n        return;\n    }\n    \n    // Show appropriate progress indicator\n    let message = 'Updating supplier access list...';\n    if(frm.doc.restrict_based_on === 'Item Group' || frm.doc.restrict_based_on === 'Brand') {\n        message = 'Updating supplier access list for multiple items. This may take some time...';\n    }\n    \n    frappe.show_alert({\n        message: __(message),\n        indicator: 'blue'\n    }, 5);\n    \n    // Call the API method\n    frappe.call({\n        method: 'o2o_erpnext.api.party_specific_item.update_supplier_access',\n        args: {\n            'party_specific_item_name': frm.doc.name\n        },\n        callback: function(r) {\n            if(r.message && r.message.success) {\n                let message = 'Supplier access updated successfully';\n                if(r.message.updated > 0 || r.message.skipped > 0) {\n                    message = `Supplier access updated for ${r.message.updated} items. ${r.message.skipped} items already had access.`;\n                }\n                \n                frappe.show_alert({\n                    message: __(message),\n                    indicator: 'green'\n                }, 5);\n            } else {\n                frappe.show_alert({\n                    message: __('Error updating supplier access'),\n                    indicator: 'red'\n                }, 5);\n            }\n        }\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-04-12 08:48:01.269068",
  "module": "o2o ErpNext",
  "name": "Employee Bulk User Create",
  "script": "// Custom script for Employee List view to add bulk user creation functionality\nfrappe.listview_settings['Employee'] = frappe.listview_settings['Employee'] || {};\n\n// Extend the existing list view settings\nObject.assign(frappe.listview_settings['Employee'], {\n    onload: function(listview) {\n        // Add a custom button after the list is rendered\n        let create_users_button = $(`<button class=\"btn btn-secondary btn-sm create-users-btn\">\n            ${__('Create Users')}\n        </button>`).hide();\n        \n        // Add the button to the page\n        listview.page.custom_actions.append(create_users_button);\n        \n        // Handle button click\n        create_users_button.on('click', function() {\n            const selected_docs = listview.get_checked_items();\n            \n            // Check if any employees are selected\n            if (selected_docs.length === 0) {\n                frappe.throw(__('Please select at least one Employee'));\n                return;\n            }\n            \n            // Debug: log selected docs to see what data we have\n            console.log(\"Selected employees:\", selected_docs);\n            \n            // Get complete employee info for each selected doc\n            const valid_employees = [];\n            const invalid_employees = [];\n            let processed = 0;\n            \n            // Show a message that we're validating\n            frappe.show_alert({\n                message: __('Validating selected employees...'),\n                indicator: 'blue'\n            }, 3);\n            \n            selected_docs.forEach(doc => {\n                frappe.db.get_doc('Employee', doc.name)\n                    .then(employee_doc => {\n                        // Debug employee data\n                        console.log(`Employee ${doc.name} data:`, employee_doc);\n                        \n                        // Check if employee already has a user\n                        if (employee_doc.user_id) {\n                            invalid_employees.push({\n                                name: employee_doc.name,\n                                reason: __('Already has a linked user')\n                            });\n                        } \n                        // Check if employee has custom_user_email\n                        else if (!employee_doc.custom_user_email) {\n                            invalid_employees.push({\n                                name: employee_doc.name,\n                                reason: __('Missing Custom User Email')\n                            });\n                        } \n                        // Valid employee for user creation\n                        else {\n                            valid_employees.push(employee_doc);\n                        }\n                        \n                        // Update progress\n                        processed++;\n                        \n                        // When all are processed, show results\n                        if (processed === selected_docs.length) {\n                            process_validation_results();\n                        }\n                    })\n                    .catch(err => {\n                        console.error(`Error fetching employee ${doc.name}:`, err);\n                        invalid_employees.push({\n                            name: doc.name,\n                            reason: __('Error fetching employee data')\n                        });\n                        \n                        // Update progress\n                        processed++;\n                        \n                        // When all are processed, show results\n                        if (processed === selected_docs.length) {\n                            process_validation_results();\n                        }\n                    });\n            });\n            \n            function process_validation_results() {\n                // Show warning if there are invalid employees\n                if (invalid_employees.length > 0) {\n                    let message = __('The following employees cannot have users created:') + '<br><br><table class=\"table table-bordered\">';\n                    message += '<tr><th>' + __('Employee ID') + '</th><th>' + __('Reason') + '</th></tr>';\n                    \n                    invalid_employees.forEach(emp => {\n                        message += `<tr><td>${emp.name}</td><td>${emp.reason}</td></tr>`;\n                    });\n                    \n                    message += '</table><br>';\n                    message += valid_employees.length > 0 ? \n                        __('Do you want to continue creating users for the remaining {0} employees?', [valid_employees.length]) : \n                        __('No valid employees found for user creation.');\n                    \n                    if (valid_employees.length === 0) {\n                        frappe.msgprint(message);\n                        return;\n                    }\n                    \n                    frappe.confirm(message, function() {\n                        // User clicked Yes, proceed with creating users for valid employees\n                        show_password_dialog(valid_employees, listview);\n                    });\n                } else {\n                    // All selected employees are valid\n                    show_password_dialog(valid_employees, listview);\n                }\n            }\n        });\n        \n        // Function to check selection and show/hide button\n        function update_button_visibility() {\n            const any_checked = listview.get_checked_items().length > 0;\n            any_checked ? create_users_button.show() : create_users_button.hide();\n        }\n        \n        // Setup initial checkbox listeners\n        listview.$page.on('change', 'input[type=\"checkbox\"]', update_button_visibility);\n    },\n    \n    refresh: function(listview) {\n        // Re-check for selected items after refresh\n        setTimeout(function() {\n            const any_checked = listview.get_checked_items().length > 0;\n            const create_users_button = listview.page.custom_actions.find('.create-users-btn');\n            if (create_users_button.length) {\n                any_checked ? create_users_button.show() : create_users_button.hide();\n            }\n        }, 100);\n    }\n});\n\n// Function to show password dialog\nfunction show_password_dialog(employees, listview) {\n    // Create a dialog to ask for password options\n    let d = new frappe.ui.Dialog({\n        title: __('Create Users for {0} Employees', [employees.length]),\n        fields: [\n            {\n                label: __('Set Custom Password'),\n                fieldname: 'set_password',\n                fieldtype: 'Check',\n                default: 0,\n                description: __('If unchecked, default password \"admin@123\" will be used for all users')\n            },\n            {\n                label: __('Password'),\n                fieldname: 'password',\n                fieldtype: 'Password',\n                depends_on: 'set_password'\n            },\n            {\n                label: __('Confirm Password'),\n                fieldname: 'confirm_password',\n                fieldtype: 'Password',\n                depends_on: 'set_password'\n            }\n        ],\n        primary_action_label: __('Create Users'),\n        primary_action: function(values) {\n            if (values.set_password) {\n                // Validate password\n                if (!values.password) {\n                    frappe.throw(__(\"Please enter password\"));\n                    return;\n                }\n                if (values.password != values.confirm_password) {\n                    frappe.throw(__(\"Passwords do not match\"));\n                    return;\n                }\n                if (values.password.length < 8) {\n                    frappe.throw(__(\"Password must be at least 8 characters long\"));\n                    return;\n                }\n            }\n            \n            d.hide();\n            create_users_for_employees(employees, values.set_password ? values.password : null, listview);\n        }\n    });\n    \n    d.show();\n}\n\n// Function to create users for multiple employees\nfunction create_users_for_employees(employees, password, listview) {\n    // Show a progress indicator\n    const total = employees.length;\n    let completed = 0;\n    let succeeded = 0;\n    let failed = 0;\n    let error_messages = [];\n    \n    frappe.show_progress(__('Creating Users'), completed, total);\n    \n    // Process each employee sequentially\n    function process_next_employee() {\n        if (completed >= total) {\n            // All employees processed\n            frappe.hide_progress();\n            \n            // Show completion message\n            let message = __('User creation complete: {0} succeeded, {1} failed', [succeeded, failed]);\n            if (failed > 0) {\n                message += '<br><br>' + __('Errors:') + '<br>';\n                error_messages.forEach(err => {\n                    message += '<div class=\"text-danger\">' + err + '</div>';\n                });\n            }\n            \n            frappe.msgprint(message);\n            \n            // Refresh the list view\n            listview.refresh();\n            return;\n        }\n        \n        const employee = employees[completed];\n        \n        // Call the server-side method to create a user\n        frappe.call({\n            method: \"o2o_erpnext.api.employee.create_user\",\n            args: {\n                employee: employee.name,\n                email: employee.custom_user_email,\n                password: password\n            },\n            callback: function(r) {\n                completed++;\n                \n                if (!r.exc) {\n                    succeeded++;\n                } else {\n                    failed++;\n                    error_messages.push(`<b>${employee.name}</b>: ${r._server_messages || \"Unknown error\"}`);\n                }\n                \n                frappe.show_progress(__('Creating Users'), completed, total);\n                \n                // Process the next employee\n                process_next_employee();\n            }\n        });\n    }\n    \n    // Start processing\n    process_next_employee();\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-05-15 15:44:19.811934",
  "module": "o2o ErpNext",
  "name": "Change debit note label",
  "script": "frappe.ui.form.on('Purchase Invoice', {\n    refresh: function(frm) {\n        console.log(\"====++++++++++++++++++++++++++++++\")\n       \n        setTimeout(() => {\n            \n            $('.dropdown-menu a.dropdown-item').each(function() {\n                if ($(this).text().trim() === \"Return / Debit Note\") {\n                    $(this).text(\"Return / Credit Note\");\n                }\n            });\n        }, 300); \n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-07-28 10:52:35.741544",
  "module": "o2o ErpNext",
  "name": "Employee restriction 1",
  "script": "frappe.listview_settings['Employee'] = {\n    onload: function(listview) {\n        if (frappe.user_roles.includes('PO Approver') || \n            frappe.user_roles.includes('Requisition Approver')) {\n            \n            listview.filter_area.clear();\n\n            frappe.call({\n                method: 'frappe.client.get_value',\n                args: {\n                    doctype: 'Employee',\n                    filters: { 'user_id': frappe.session.user },\n                    fieldname: ['custom_supplier']\n                },\n                callback: function(r) {\n                    console.log('Employee data for current user:', r.message);\n                    \n                    if (r.message) {\n                        let filters = [];\n                        \n                        if (r.message.custom_supplier) {\n                            // Both PO Approver and Requisition Approver: Show all employees from same supplier only\n                            filters.push(\n                                ['Employee', 'custom_supplier', '=', r.message.custom_supplier]\n                            );\n                            \n                            listview.custom_supplier = r.message.custom_supplier;\n                            \n                            console.log('Applied filter - Supplier:', r.message.custom_supplier);\n                        } else {\n                            // If supplier is missing, show nothing\n                            filters.push(['Employee', 'name', '=', '']);\n                            console.log('Missing supplier - showing empty list');\n                        }\n\n                        console.log('Final filters to apply:', filters);\n                        listview.filter_area.add(filters);\n                        listview.refresh();\n                        _hideFilterControls(listview);\n\n                        frappe.show_alert({\n                            message: __('The Employee list is filtered based on your assigned supplier.'),\n                            indicator: 'info'\n                        });\n                        \n                        // Debug: Show what employees should be visible\n                        this.debugEmployeeFilter(r.message.custom_supplier);\n                    }\n                }.bind(this)\n            });\n        }\n    },\n    \n    debugEmployeeFilter: function(supplier) {\n        setTimeout(() => {\n            let filters = { \n                'custom_supplier': supplier\n            };\n            \n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Employee',\n                    fields: ['name', 'employee_name', 'custom_supplier', 'branch', 'custom_sub_branch', 'custom_roles'],\n                    filters: filters,\n                    limit_page_length: 50\n                },\n                callback: function(r) {\n                    console.log('=== EMPLOYEES THAT SHOULD BE VISIBLE ===');\n                    console.log('Filter: supplier =', supplier);\n                    \n                    if (r.message && r.message.length > 0) {\n                        console.log('Found', r.message.length, 'employees:');\n                        r.message.forEach(emp => {\n                            console.log(`- ${emp.employee_name} (${emp.custom_roles}) - Supplier: ${emp.custom_supplier}, Branch: ${emp.branch}, Sub-Branch: ${emp.custom_sub_branch}`);\n                        });\n                    } else {\n                        console.log('‚ùå No employees found with this supplier!');\n                        \n                        // Let's also check what suppliers exist\n                        frappe.call({\n                            method: 'frappe.client.get_list',\n                            args: {\n                                doctype: 'Employee',\n                                fields: ['employee_name', 'custom_supplier', 'branch', 'custom_sub_branch'],\n                                limit_page_length: 50\n                            },\n                            callback: function(allEmp) {\n                                console.log('=== ALL EMPLOYEES AND THEIR SUPPLIERS ===');\n                                if (allEmp.message) {\n                                    allEmp.message.forEach(emp => {\n                                        console.log(`- ${emp.employee_name}: Supplier=\"${emp.custom_supplier}\", Branch=\"${emp.branch}\", Sub-Branch=\"${emp.custom_sub_branch}\"`);\n                                    });\n                                }\n                            }\n                        });\n                    }\n                    console.log('=== END DEBUG ===');\n                }\n            });\n        }, 1000);\n    },\n\n    refresh: function(listview) {\n        if (frappe.user_roles.includes('PO Approver') || \n            frappe.user_roles.includes('Requisition Approver')) {\n            \n            if (listview.custom_supplier) {\n                let current_filters = listview.filter_area.get();\n                let filters_present = current_filters.some(f =>\n                    f[1] === 'custom_supplier' && f[3] === listview.custom_supplier\n                );\n\n                if (!filters_present) {\n                    listview.filter_area.add([\n                        ['Employee', 'custom_supplier', '=', listview.custom_supplier]\n                    ]);\n                }\n            }\n            _hideFilterControls(listview);\n        }\n    },\n\n    before_refresh: function(listview) {\n        if (frappe.user_roles.includes('PO Approver') || \n            frappe.user_roles.includes('Requisition Approver')) {\n            \n            if (listview.custom_supplier) {\n                let current_filters = listview.filter_area.get();\n                let filters_present = current_filters.some(f =>\n                    f[1] === 'custom_supplier' && f[3] === listview.custom_supplier\n                );\n\n                if (!filters_present) {\n                    listview.filter_area.add([\n                        ['Employee', 'custom_supplier', '=', listview.custom_supplier]\n                    ]);\n                }\n            }\n        }\n        return true;\n    },\n\n    before_new: function() {\n        if (frappe.user_roles.includes('PO Approver') || \n            frappe.user_roles.includes('Requisition Approver')) {\n            \n            return new Promise((resolve, reject) => {\n                frappe.call({\n                    method: 'frappe.client.get_value',\n                    args: {\n                        doctype: 'Employee',\n                        filters: { 'user_id': frappe.session.user },\n                        fieldname: ['custom_supplier']\n                    },\n                    callback: function(r) {\n                        if (!r.message || !r.message.custom_supplier) {\n                            frappe.throw(__('You must have a supplier assigned to your employee record to create an employee.'));\n                            reject();\n                        } else {\n                            resolve();\n                        }\n                    }\n                });\n            });\n        }\n        return true;\n    }\n};\n\n// Helper function to hide filter controls\nfunction _hideFilterControls(listview) {\n    $('.filter-selector').hide();\n    $('.filter-button').hide();\n    $('.filter-box .filter-area').css('pointer-events', 'none');\n\n    setTimeout(() => {\n        $('.filter-tag .remove-filter').hide();\n    }, 100);\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-12-10 17:14:36.821922",
  "module": null,
  "name": "freight table cal",
  "script": "frappe.ui.form.on('Purchase Invoice', {\n    refresh: function(frm) {\n        // Calculate on form load\n        calculate_freight_gst_totals(frm);\n        \n        // Add manual calculation button for testing\n        frm.add_custom_button(__('Recalculate Freight GST'), function() {\n            calculate_freight_gst_totals(frm);\n        });\n    },\n    \n    // Trigger when any field changes\n    onload: function(frm) {\n        calculate_freight_gst_totals(frm);\n    }\n});\n\n// Child table events - using the exact doctype name\nfrappe.ui.form.on('Purchase Invoice Freight Cost', {\n    // When GST fields change\n    cgst: function(frm, cdt, cdn) {\n        calculate_freight_gst_totals(frm);\n    },\n    \n    sgst: function(frm, cdt, cdn) {\n        calculate_freight_gst_totals(frm);\n    },\n    \n    igst: function(frm, cdt, cdn) {\n        calculate_freight_gst_totals(frm);\n    },\n    \n    // When rows are added/removed\n    purchase_invoice_freight_cost_add: function(frm) {\n        calculate_freight_gst_totals(frm);\n    },\n    \n    purchase_invoice_freight_cost_remove: function(frm) {\n        setTimeout(() => calculate_freight_gst_totals(frm), 100);\n    }\n});\n\nfunction calculate_freight_gst_totals(frm) {\n    let total_cgst = 0;\n    let total_sgst = 0;\n    let total_igst = 0;\n    \n    // Try common fieldname patterns for Purchase Invoice Freight Cost\n    const possible_fieldnames = [\n        'purchase_invoice_freight_cost',\n        'freight_cost',\n        'custom_freight_cost',\n        'custom_purchase_invoice_freight_cost'\n    ];\n    \n    let freight_table = null;\n    let found_fieldname = null;\n    \n    // Find the freight cost table\n    for (let fieldname of possible_fieldnames) {\n        if (frm.doc[fieldname]) {\n            freight_table = frm.doc[fieldname];\n            found_fieldname = fieldname;\n            break;\n        }\n    }\n    \n    // If not found, search all arrays in the document\n    if (!freight_table) {\n        for (let key in frm.doc) {\n            if (Array.isArray(frm.doc[key]) && frm.doc[key].length > 0) {\n                const first_row = frm.doc[key][0];\n                if (first_row && first_row.doctype === 'Purchase Invoice Freight Cost') {\n                    freight_table = frm.doc[key];\n                    found_fieldname = key;\n                    break;\n                }\n            }\n        }\n    }\n    \n    console.log(\"Found freight table:\", found_fieldname, freight_table);\n    \n    if (freight_table && Array.isArray(freight_table)) {\n        // Calculate totals\n        freight_table.forEach(function(row) {\n            total_cgst += flt(row.cgst || 0);\n            total_sgst += flt(row.sgst || 0);\n            total_igst += flt(row.igst || 0);\n        });\n        \n        console.log(\"Calculated totals:\", {\n            cgst: total_cgst,\n            sgst: total_sgst,\n            igst: total_igst\n        });\n        \n        // Update parent fields\n        frm.set_value('custom_total_freight_cgst', total_cgst);\n        frm.set_value('custom_total_freight_sgst', total_sgst);\n        frm.set_value('custom_total_freight_igst', total_igst);\n        \n        // Show success message\n        frappe.show_alert({\n            message: `Freight GST Updated - CGST: ‚Çπ${total_cgst.toFixed(2)}, SGST: ‚Çπ${total_sgst.toFixed(2)}, IGST: ‚Çπ${total_igst.toFixed(2)}`,\n            indicator: 'green'\n        });\n    } else {\n        console.log(\"Freight cost table not found or empty\");\n        \n        // Reset to zero if no data\n        frm.set_value('custom_total_freight_cgst', 0);\n        frm.set_value('custom_total_freight_sgst', 0);\n        frm.set_value('custom_total_freight_igst', 0);\n    }\n    \n    // Refresh the fields\n    frm.refresh_fields(['custom_total_freight_cgst', 'custom_total_freight_sgst', 'custom_total_freight_igst']);\n}",
  "view": "Form"
 }
]